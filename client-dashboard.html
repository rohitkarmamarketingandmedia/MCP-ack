<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Content Dashboard | AckWest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/unified-header.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        
        /* Premium gradient background */
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-light { background: rgba(255,255,255,0.95); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-border { border: 2px solid transparent; background: linear-gradient(#1e293b, #1e293b) padding-box, linear-gradient(135deg, #667eea, #764ba2, #f093fb) border-box; }
        
        /* Glow effects */
        .glow { box-shadow: 0 0 60px rgba(99, 102, 241, 0.3); }
        .glow-green { box-shadow: 0 0 40px rgba(16, 185, 129, 0.3); }
        .glow-purple { box-shadow: 0 0 40px rgba(139, 92, 246, 0.3); }
        .glow-orange { box-shadow: 0 0 40px rgba(249, 115, 22, 0.3); }
        
        .stat-card { transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(102,126,234,0.2); }
        .content-card { transition: all 0.3s; }
        .content-card:hover { transform: translateY(-2px); }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Health score circle animation */
        .health-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 2s ease-out;
        }
        
        /* Slide up animation */
        .slide-up {
            animation: slideUp 0.6s ease-out forwards;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Scale in animation */
        .scale-in {
            animation: scaleIn 0.5s ease-out forwards;
        }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .blog-content { line-height: 1.8; }
        .blog-content h2 { font-size: 1.5rem; font-weight: 700; margin: 1.5rem 0 1rem; color: #1e293b; }
        .blog-content h3 { font-size: 1.25rem; font-weight: 600; margin: 1.25rem 0 0.75rem; color: #334155; }
        .blog-content p { margin-bottom: 1rem; color: #475569; }
        .blog-content ul, .blog-content ol { margin: 1rem 0; padding-left: 1.5rem; }
        .blog-content li { margin-bottom: 0.5rem; color: #475569; }
        .blog-content a { color: #667eea; text-decoration: underline; }
        .internal-link { background: linear-gradient(135deg, #667eea20, #764ba220); padding: 2px 6px; border-radius: 4px; }
        .tab-active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top-color: #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .social-gbp { border-left: 4px solid #4285f4; }
        .social-facebook { border-left: 4px solid #1877f2; }
        .social-instagram { border-left: 4px solid #e4405f; }
        
        /* Win item styles */
        .win-item {
            animation: slideIn 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Progress bar animation */
        .progress-bar-animated {
            transition: width 1.5s ease-out;
        }
        
        /* Phone mockup styles */
        .phone-mockup {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 3px solid #334155;
            border-radius: 36px;
            padding: 8px;
        }
        .phone-screen {
            background: #000;
            border-radius: 28px;
            overflow: hidden;
        }
        .phone-notch {
            width: 80px;
            height: 20px;
            background: #000;
            border-radius: 0 0 12px 12px;
            margin: 0 auto;
        }
        
        /* Pulse ring animation */
        .pulse-ring {
            animation: pulse-ring 2s ease-out infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        /* Audio waveform */
        .waveform {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 30px;
        }
        .waveform-bar {
            width: 3px;
            background: linear-gradient(to top, #10b981, #34d399);
            border-radius: 2px;
            animation: waveform 0.5s ease-in-out infinite alternate;
        }
        @keyframes waveform {
            from { height: 20%; }
            to { height: 100%; }
        }
        
        /* Float animation */
        .float {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Toast styles */
        .toast-enter {
            animation: toastEnter 0.3s ease-out;
        }
        @keyframes toastEnter {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Onboarding Tour Styles */
        .tour-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9998; }
        .tour-highlight { position: relative; z-index: 9999; box-shadow: 0 0 0 4px #8b5cf6, 0 0 0 9999px rgba(0,0,0,0.7); border-radius: 8px; }
        .tour-tooltip { position: fixed; z-index: 10000; background: white; border-radius: 12px; padding: 20px; max-width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .tour-tooltip::before { content: ''; position: absolute; width: 12px; height: 12px; background: white; transform: rotate(45deg); }
        .tour-tooltip.top::before { bottom: -6px; left: 50%; margin-left: -6px; }
        .tour-tooltip.bottom::before { top: -6px; left: 50%; margin-left: -6px; }
        .tour-tooltip.left::before { right: -6px; top: 50%; margin-top: -6px; }
        .tour-tooltip.right::before { left: -6px; top: 50%; margin-top: -6px; }
        .tour-progress { display: flex; gap: 4px; margin-top: 16px; }
        .tour-progress-dot { width: 8px; height: 8px; border-radius: 50%; background: #e2e8f0; }
        .tour-progress-dot.active { background: #8b5cf6; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>
<body class="min-h-screen">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="glass rounded-2xl p-8 w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold gradient-text mb-2" data-brand="name">AckWest</h1>
                <p class="text-gray-400">Content Dashboard</p>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="apiUrl" value="">
                <input type="email" id="loginEmail" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" placeholder="Email">
                <input type="password" id="loginPassword" autocomplete="current-password" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" placeholder="Password">
                <button onclick="doLogin()" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-semibold hover:opacity-90 transition">
                    Sign In
                </button>
                <p id="authError" class="text-red-400 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Navigation Bar -->
        <nav class="bg-slate-900 border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex items-center justify-between h-12">
                    <!-- Mobile menu button -->
                    <button onclick="toggleMobileNav()" class="md:hidden p-2 text-gray-400 hover:text-white">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- Desktop nav -->
                    <div class="hidden md:flex items-center gap-6 text-sm">
                        <a href="/intake" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i> New Client
                        </a>
                        <a href="/agency" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-building"></i> Agency
                        </a>
                        <a href="/client" class="text-white font-medium flex items-center gap-2">
                            <i class="fas fa-file-alt"></i> Content
                        </a>
                        <a href="/elite" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-chart-line"></i> SEO Elite
                        </a>
                        <a href="/admin" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-cog"></i> Admin
                        </a>
                    </div>
                    <div class="text-xs text-gray-500">
                        <span class="text-purple-400">MCP</span> Framework
                    </div>
                </div>
                
                <!-- Mobile nav dropdown -->
                <div id="mobileNav" class="hidden md:hidden pb-4">
                    <div class="flex flex-col gap-2 text-sm">
                        <a href="/intake" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-plus-circle w-5"></i> New Client
                        </a>
                        <a href="/agency" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-building w-5"></i> Agency
                        </a>
                        <a href="/client" class="text-white font-medium flex items-center gap-2 py-2">
                            <i class="fas fa-file-alt w-5"></i> Content
                        </a>
                        <a href="/elite" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-chart-line w-5"></i> SEO Elite
                        </a>
                        <a href="/admin" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-cog w-5"></i> Admin
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Header -->
        <header class="glass border-b border-white/10 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-rocket text-white"></i>
                        </div>
                        <div class="min-w-0">
                            <h1 id="clientName" class="text-lg sm:text-xl font-bold text-white truncate">Loading...</h1>
                            <p id="clientMeta" class="text-xs sm:text-sm text-gray-400 truncate">Content Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <select id="clientSelector" onchange="loadClient(this.value)" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:outline-none truncate max-w-[200px]">
                            <option value="">Select Client</option>
                        </select>
                        <button onclick="showEditClient()" class="p-2 glass rounded-lg text-gray-400 hover:text-blue-400 transition flex-shrink-0" title="Edit Client">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeleteClient()" class="p-2 glass rounded-lg text-gray-400 hover:text-red-400 transition flex-shrink-0" title="Delete Client">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="refreshData()" class="p-2 glass rounded-lg text-gray-400 hover:text-white transition flex-shrink-0" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button onclick="startTour()" class="p-2 glass rounded-lg text-gray-400 hover:text-white transition flex-shrink-0" title="Help Tour">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Permission Error Alert (hidden by default) -->
        <div id="permissionAlert" class="hidden max-w-7xl mx-auto px-4 py-2">
            <div class="bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-500/40 rounded-xl p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                    </div>
                    <div>
                        <p class="text-white font-medium">Permission Issues Detected</p>
                        <p class="text-sm text-gray-400">Some features may not work. Click to fix.</p>
                    </div>
                </div>
                <button onclick="manualFixPermissions()" class="px-4 py-2 bg-gradient-to-r from-red-600 to-orange-600 rounded-lg text-white text-sm font-medium hover:opacity-90 transition">
                    <i class="fas fa-wrench mr-2"></i>Fix Permissions
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                            <i class="fas fa-file-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statBlogs" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Blog Posts</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                            <i class="fas fa-share-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statSocial" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Social Posts</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
                            <i class="fas fa-key text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statKeywords" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Keywords</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
                            <i class="fas fa-users text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statCompetitors" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Competitors</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="max-w-7xl mx-auto px-4 mb-6">
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-active px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium transition whitespace-nowrap">
                    <i class="fas fa-home sm:mr-2"></i><span class="hidden sm:inline">Overview</span><span class="sm:hidden">Home</span>
                </button>
                <button onclick="showTab('generate')" id="tab-generate" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                    <i class="fas fa-magic sm:mr-2"></i><span class="hidden sm:inline">Generate Content</span><span class="sm:hidden">Generate</span>
                </button>
                <button onclick="showTab('blogs')" id="tab-blogs" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-file-alt sm:mr-2"></i><span class="hidden sm:inline">Blog Posts</span><span class="sm:hidden">Blogs</span>
                </button>
                <button onclick="showTab('social')" id="tab-social" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-share-alt sm:mr-2"></i><span class="hidden sm:inline">Social Posts</span><span class="sm:hidden">Social</span>
                </button>
                <button onclick="showTab('seo')" id="tab-seo" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-chart-line sm:mr-2"></i><span class="hidden sm:inline">SEO Overview</span><span class="sm:hidden">SEO</span>
                </button>
                <button onclick="showTab('calendar')" id="tab-calendar" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-calendar-alt sm:mr-2"></i><span class="hidden sm:inline">Calendar</span><span class="sm:hidden">Cal</span>
                </button>
                <button onclick="showTab('reports')" id="tab-reports" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-file-pdf sm:mr-2"></i><span class="hidden sm:inline">Reports</span><span class="sm:hidden">PDF</span>
                </button>
                <button onclick="showTab('rankings')" id="tab-rankings" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-trophy sm:mr-2"></i><span class="hidden sm:inline">Rankings</span><span class="sm:hidden">Rank</span>
                </button>
                <button onclick="showTab('competitors')" id="tab-competitors" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-users sm:mr-2"></i><span class="hidden sm:inline">Competitors</span><span class="sm:hidden">Comp</span>
                </button>
                <button onclick="showTab('settings')" id="tab-settings" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-cog sm:mr-2"></i><span class="hidden sm:inline">Settings</span><span class="sm:hidden">Set</span>
                </button>
                <button onclick="showTab('chatbot')" id="tab-chatbot" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-robot sm:mr-2"></i><span class="hidden sm:inline">AI Chatbot</span><span class="sm:hidden">Bot</span>
                </button>
                <button onclick="showTab('leads')" id="tab-leads" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-user-plus sm:mr-2"></i><span class="hidden sm:inline">Leads</span><span class="sm:hidden">Lead</span>
                </button>
                <button onclick="showTab('reviews')" id="tab-reviews" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-star sm:mr-2"></i><span class="hidden sm:inline">Reviews</span><span class="sm:hidden">Rev</span>
                </button>
                <button onclick="showTab('calls')" id="tab-calls" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-phone sm:mr-2"></i><span class="hidden sm:inline">Call Intel</span><span class="sm:hidden">Call</span>
                </button>
                <button onclick="showTab('pages')" id="tab-pages" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-file-code sm:mr-2"></i><span class="hidden sm:inline">Pages</span><span class="sm:hidden">Page</span>
                </button>
            </div>
        </div>

        <!-- Content Panels -->
        <div class="max-w-7xl mx-auto px-4 pb-12">
            
            <!-- Overview Panel - Client Home Dashboard -->
            <div id="panel-overview" class="fade-in">
                <div class="grid lg:grid-cols-4 gap-6 mb-8">
                    <!-- Health Score -->
                    <div class="glass rounded-2xl p-6 text-center glow-green">
                        <div class="relative w-32 h-32 mx-auto mb-4">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="64" cy="64" r="56" stroke="rgba(255,255,255,0.1)" stroke-width="10" fill="none"/>
                                <circle id="health-circle" cx="64" cy="64" r="56" stroke="#10b981" stroke-width="10" fill="none" class="health-circle" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div>
                                    <div class="text-4xl font-bold text-white" id="health-score-value">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-emerald-400 font-bold text-lg" id="health-grade">Loading...</div>
                        <div class="text-sm text-gray-400">Marketing Health Score</div>
                    </div>
                    
                    <!-- Leads This Month -->
                    <div class="glass rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-user-plus text-white text-2xl"></i>
                        </div>
                        <div class="text-4xl font-bold text-white mb-1" id="overview-leads">--</div>
                        <div class="text-sm text-gray-400 mb-3">New Leads</div>
                        <div class="flex items-center justify-center gap-1 text-emerald-400 text-sm" id="leads-change">
                            <span>--</span>
                        </div>
                    </div>
                    
                    <!-- Calls This Month -->
                    <div class="glass rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-phone text-white text-2xl"></i>
                        </div>
                        <div class="text-4xl font-bold text-white mb-1" id="overview-calls">--</div>
                        <div class="text-sm text-gray-400 mb-3">Phone Calls</div>
                        <div class="w-full bg-slate-700 rounded-full h-2 mb-1">
                            <div id="answer-rate-bar" class="bg-emerald-500 h-2 rounded-full progress-bar-animated" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500"><span id="answer-rate">--</span>% answered</div>
                    </div>
                    
                    <!-- Content Created -->
                    <div class="glass rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-alt text-white text-2xl"></i>
                        </div>
                        <div class="text-4xl font-bold text-white mb-1" id="overview-content">--</div>
                        <div class="text-sm text-gray-400 mb-3">Content Created</div>
                        <div class="text-xs text-gray-500">This month</div>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- This Week's Wins -->
                    <div class="glass rounded-2xl p-6 glow-purple">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                                <i class="fas fa-trophy text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">This Week's Wins</h3>
                                <p class="text-sm text-gray-400">Your marketing victories</p>
                            </div>
                        </div>
                        <div class="space-y-3" id="wins-list">
                            <div class="flex items-center gap-3 text-sm win-item" style="animation-delay: 0.1s">
                                <span class="text-emerald-400">‚úì</span>
                                <span class="text-gray-300">Loading wins...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pending Approval -->
                    <div class="glass rounded-2xl p-6 glow">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                    <i class="fas fa-clipboard-check text-white text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white">Ready for Approval</h3>
                                    <p class="text-sm text-gray-400">Content awaiting your review</p>
                                </div>
                            </div>
                            <span class="bg-indigo-500 text-white text-xs px-3 py-1 rounded-full font-bold" id="pending-count">0</span>
                        </div>
                        <div class="space-y-4" id="pending-list">
                            <div class="text-gray-500 text-sm">No content pending approval</div>
                        </div>
                    </div>
                </div>
                
                <!-- Live Call Intelligence + Recent Activity -->
                <div class="mt-8 grid lg:grid-cols-3 gap-6">
                    <!-- Phone Mockup - Live Calls -->
                    <div class="glass rounded-2xl p-6 glow-green">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                                <i class="fas fa-phone text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Call Intelligence</h3>
                                <p class="text-xs text-gray-400">AI listens to every call</p>
                            </div>
                        </div>
                        
                        <!-- Phone Mockup -->
                        <div class="phone-mockup mx-auto max-w-[200px]">
                            <div class="phone-screen">
                                <div class="bg-slate-900 p-3">
                                    <div class="phone-notch"></div>
                                    
                                    <div class="text-center py-4">
                                        <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-3 relative">
                                            <span class="text-3xl">üë§</span>
                                            <div class="absolute inset-0 bg-emerald-500/30 rounded-full pulse-ring"></div>
                                        </div>
                                        <div class="text-sm font-semibold text-white mb-0.5" id="caller-name">Waiting...</div>
                                        <div class="text-slate-400 text-xs mb-3" id="caller-location">for next call</div>
                                        
                                        <div class="text-emerald-400 text-xl font-mono mb-2" id="call-timer">--:--</div>
                                        
                                        <!-- Waveform -->
                                        <div class="waveform justify-center mb-4" id="waveform">
                                            <div class="waveform-bar" style="animation-delay: 0s"></div>
                                            <div class="waveform-bar" style="animation-delay: 0.1s"></div>
                                            <div class="waveform-bar" style="animation-delay: 0.2s"></div>
                                            <div class="waveform-bar" style="animation-delay: 0.3s"></div>
                                            <div class="waveform-bar" style="animation-delay: 0.4s"></div>
                                            <div class="waveform-bar" style="animation-delay: 0.5s"></div>
                                            <div class="waveform-bar" style="animation-delay: 0.6s"></div>
                                            <div class="waveform-bar" style="animation-delay: 0.7s"></div>
                                        </div>
                                        
                                        <div class="flex justify-center gap-3">
                                            <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center text-xs">üîá</div>
                                            <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-xs" id="call-status-icon">üìû</div>
                                            <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center text-xs">üîä</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <div class="text-xs text-gray-500" id="calls-today">0 calls analyzed today</div>
                        </div>
                    </div>
                    
                    <!-- Live Transcript / Extracted Keywords -->
                    <div class="lg:col-span-2 glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                    <i class="fas fa-brain text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white">AI Extracted Insights</h3>
                                    <p class="text-xs text-gray-400">From recent customer interactions</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                <span class="text-xs text-gray-400">Live</span>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- Questions Extracted -->
                            <div class="bg-slate-900/50 rounded-xl p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-blue-400">‚ùì</span>
                                    <span class="text-sm font-medium text-white">Top Questions Asked</span>
                                </div>
                                <div class="space-y-2" id="extracted-questions">
                                    <div class="bg-slate-800/50 rounded-lg p-2 text-xs text-gray-300">Loading...</div>
                                </div>
                            </div>
                            
                            <!-- Keywords Identified -->
                            <div class="bg-slate-900/50 rounded-xl p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-purple-400">üîë</span>
                                    <span class="text-sm font-medium text-white">Keywords Identified</span>
                                </div>
                                <div class="flex flex-wrap gap-2" id="extracted-keywords">
                                    <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded-full text-xs">Loading...</span>
                                </div>
                            </div>
                            
                            <!-- Pain Points -->
                            <div class="bg-slate-900/50 rounded-xl p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-orange-400">‚ö†Ô∏è</span>
                                    <span class="text-sm font-medium text-white">Pain Points</span>
                                </div>
                                <div class="space-y-2" id="extracted-pain">
                                    <div class="text-xs text-orange-300">Loading...</div>
                                </div>
                            </div>
                            
                            <!-- Services Requested -->
                            <div class="bg-slate-900/50 rounded-xl p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-emerald-400">üîß</span>
                                    <span class="text-sm font-medium text-white">Services Requested</span>
                                </div>
                                <div class="space-y-2" id="content-opportunities">
                                    <div class="text-xs text-emerald-300">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-8 grid md:grid-cols-4 gap-4">
                    <button onclick="showTab('generate')" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center group-hover:scale-110 transition">
                                <i class="fas fa-magic text-green-400"></i>
                            </div>
                            <div>
                                <div class="text-white font-medium">Generate Content</div>
                                <div class="text-xs text-gray-500">Create blogs & social</div>
                            </div>
                        </div>
                    </button>
                    <button onclick="showTab('rankings')" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center group-hover:scale-110 transition">
                                <i class="fas fa-trophy text-yellow-400"></i>
                            </div>
                            <div>
                                <div class="text-white font-medium">Check Rankings</div>
                                <div class="text-xs text-gray-500">See keyword positions</div>
                            </div>
                        </div>
                    </button>
                    <button onclick="showTab('reports')" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center group-hover:scale-110 transition">
                                <i class="fas fa-chart-bar text-purple-400"></i>
                            </div>
                            <div>
                                <div class="text-white font-medium">View Reports</div>
                                <div class="text-xs text-gray-500">Analytics & insights</div>
                            </div>
                        </div>
                    </button>
                    <button onclick="showTab('competitors')" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center group-hover:scale-110 transition">
                                <i class="fas fa-users text-red-400"></i>
                            </div>
                            <div>
                                <div class="text-white font-medium">Spy on Competitors</div>
                                <div class="text-xs text-gray-500">See what they're doing</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Generate Panel -->
            <div id="panel-generate" class="hidden fade-in">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Blog Generation -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                <i class="fas fa-file-alt text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Generate Blog Post</h3>
                                <p class="text-sm text-gray-400">1,500 words with FAQs & internal links</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Select Keyword</label>
                                <select id="blogKeyword" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                    <option value="">Choose a keyword...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Or Enter Custom Keyword</label>
                                <input type="text" id="customBlogKeyword" placeholder="e.g., emergency AC repair" 
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Word Count</label>
                                    <select id="blogWordCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="1500">1,500 words</option>
                                        <option value="1800" selected>1,800 words</option>
                                        <option value="2000">2,000 words</option>
                                        <option value="2500">2,500 words</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Include FAQs</label>
                                    <select id="blogFaqs" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="5" selected>5 FAQs</option>
                                        <option value="3">3 FAQs</option>
                                        <option value="0">No FAQs</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Featured Image Option -->
                            <div class="p-4 bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 rounded-xl">
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center">
                                            <i class="fas fa-image text-amber-400"></i>
                                        </div>
                                        <div>
                                            <span class="text-white font-medium">Generate Featured Image</span>
                                            <p class="text-xs text-gray-400">AI-powered image matching your topic</p>
                                        </div>
                                    </div>
                                    <input type="checkbox" id="blogGenerateImage" checked class="w-5 h-5 text-amber-600 rounded">
                                </label>
                            </div>
                            
                            <button onclick="generateBlog()" id="btnGenerateBlog" 
                                class="w-full py-4 bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i class="fas fa-magic"></i> Generate Blog Post
                            </button>
                        </div>
                        
                        <div id="blogProgress" class="hidden mt-4 p-4 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="spinner w-6 h-6"></div>
                                <span id="blogProgressText" class="text-gray-300">Generating...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bulk Blog Generation -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                <i class="fas fa-layer-group text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Bulk Blog Generation</h3>
                                <p class="text-sm text-gray-400">Generate multiple blogs at once</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Keywords (one per line)</label>
                                <textarea id="bulkKeywords" rows="5" placeholder="ac repair sarasota&#10;hvac maintenance bradenton&#10;emergency ac service" 
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 resize-none"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Word Count Each</label>
                                    <select id="bulkWordCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="1500">1,500 words</option>
                                        <option value="1800" selected>1,800 words</option>
                                        <option value="2000">2,000 words</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">FAQs Per Blog</label>
                                    <select id="bulkFaqCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="5" selected>5 FAQs</option>
                                        <option value="3">3 FAQs</option>
                                        <option value="0">No FAQs</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button onclick="generateBulkBlogs()" id="btnBulkGenerate" 
                                class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i class="fas fa-rocket"></i> Generate All Blogs
                            </button>
                        </div>
                        
                        <div id="bulkProgress" class="hidden mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Progress</span>
                                <span id="bulkProgressCount" class="text-sm text-white">0/0</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div id="bulkProgressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div id="bulkProgressLog" class="mt-3 max-h-32 overflow-y-auto text-sm text-gray-400 space-y-1"></div>
                        </div>
                    </div>
                    
                    <!-- Social Generation -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-share-alt text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Generate Social Posts</h3>
                                <p class="text-sm text-gray-400">GBP, Facebook & Instagram</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Topic / Keyword</label>
                                <input type="text" id="socialTopic" placeholder="e.g., summer AC maintenance tips" 
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Platforms</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="flex items-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <input type="checkbox" id="platformGbp" checked class="w-4 h-4 text-blue-600 rounded">
                                        <i class="fab fa-google text-blue-400"></i>
                                        <span class="text-sm text-white">GBP</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <input type="checkbox" id="platformFacebook" checked class="w-4 h-4 text-blue-600 rounded">
                                        <i class="fab fa-facebook text-blue-500"></i>
                                        <span class="text-sm text-white">FB</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <input type="checkbox" id="platformInstagram" checked class="w-4 h-4 text-pink-600 rounded">
                                        <i class="fab fa-instagram text-pink-500"></i>
                                        <span class="text-sm text-white">IG</span>
                                    </label>
                                </div>
                            </div>
                            
                            <button onclick="generateSocial()" id="btnGenerateSocial" 
                                class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i class="fas fa-magic"></i> Generate Social Posts
                            </button>
                        </div>
                        
                        <div id="socialProgress" class="hidden mt-4 p-4 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="spinner w-6 h-6"></div>
                                <span id="socialProgressText" class="text-gray-300">Generating...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Image Generation -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                                <i class="fas fa-image text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">AI Image Generator</h3>
                                <p class="text-sm text-gray-400">Create images with DALL-E & more</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Image Description</label>
                                <textarea id="imagePrompt" rows="3" placeholder="Describe the image you want to create..."
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-amber-500 resize-none"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Style</label>
                                    <select id="imageStyle" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-amber-500">
                                        <option value="photorealistic">üì∑ Photorealistic</option>
                                        <option value="social_media">üì± Social Media</option>
                                        <option value="corporate">üíº Corporate</option>
                                        <option value="illustration">üé® Illustration</option>
                                        <option value="minimal">‚ú® Minimal</option>
                                        <option value="lifestyle">üè° Lifestyle</option>
                                        <option value="product">üõçÔ∏è Product</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Size</label>
                                    <select id="imageSize" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-amber-500">
                                        <option value="1024x1024">Square (1024x1024)</option>
                                        <option value="1792x1024">Landscape (1792x1024)</option>
                                        <option value="1024x1792">Portrait (1024x1792)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="generateImage()" id="btnGenerateImage" 
                                    class="flex-1 py-4 bg-gradient-to-r from-amber-600 to-orange-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                    <i class="fas fa-wand-magic-sparkles"></i> Generate Image
                                </button>
                                <button onclick="generateSocialImages()" id="btnGenerateSocialImages" 
                                    class="px-4 py-4 bg-white/10 hover:bg-white/20 rounded-xl text-white transition" title="Generate for all platforms">
                                    <i class="fas fa-layer-group"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Generated Image Preview -->
                        <div id="imagePreview" class="hidden mt-4">
                            <div class="relative rounded-xl overflow-hidden bg-white/5">
                                <img id="generatedImage" src="" alt="Generated Image" class="w-full h-auto">
                                <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent">
                                    <div class="flex items-center justify-between">
                                        <span id="imageProvider" class="text-xs text-gray-400">Generated with DALL-E</span>
                                        <div class="flex gap-2">
                                            <a id="imageDownload" href="#" download class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
                                                <i class="fas fa-download text-white text-sm"></i>
                                            </a>
                                            <button onclick="copyImageUrl()" class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
                                                <i class="fas fa-copy text-white text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="imageProgress" class="hidden mt-4 p-4 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="spinner w-6 h-6"></div>
                                <span id="imageProgressText" class="text-gray-300">Generating image...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Image Library -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center">
                                <i class="fas fa-photo-film text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Image Library</h3>
                                <p class="text-sm text-gray-400">Upload photos for featured images</p>
                            </div>
                        </div>
                        
                        <!-- Upload Area -->
                        <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center hover:border-pink-500/50 transition cursor-pointer" 
                             onclick="document.getElementById('libraryImageUpload').click()"
                             ondragover="event.preventDefault(); this.classList.add('border-pink-500')"
                             ondragleave="this.classList.remove('border-pink-500')"
                             ondrop="handleImageDrop(event)">
                            <input type="file" id="libraryImageUpload" accept="image/*" multiple class="hidden" onchange="uploadLibraryImages(event)">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-400">Click to upload or drag & drop</p>
                            <p class="text-xs text-gray-500 mt-1">JPG, PNG, WebP (max 10MB) ‚Ä¢ Multiple files supported</p>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="uploadProgress" class="hidden mt-2">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-white/10 rounded-full h-2">
                                    <div id="uploadProgressBar" class="bg-pink-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <span id="uploadProgressText" class="text-xs text-gray-400">0/0</span>
                            </div>
                        </div>
                        
                        <!-- Category Selection -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Image Category</label>
                            <select id="uploadCategory" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-pink-500">
                                <option value="hero">üñºÔ∏è Hero Images</option>
                                <option value="work">üîß Work/Projects</option>
                                <option value="team">üë• Team Photos</option>
                                <option value="office">üè¢ Office/Location</option>
                                <option value="equipment">üõ†Ô∏è Equipment</option>
                                <option value="general">üìÅ General</option>
                            </select>
                        </div>
                        
                        <!-- Image Library Grid -->
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Your Images</span>
                                <button onclick="loadImageLibrary()" class="text-xs text-pink-400 hover:text-pink-300">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                                </button>
                            </div>
                            <p class="text-xs text-yellow-500/70 mb-2">‚ö†Ô∏è Uploaded images may be lost after server updates. Use external URLs below for reliable images.</p>
                            <div id="imageLibraryGrid" class="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                                <p class="col-span-3 text-center text-gray-500 text-sm py-4">Upload images to see them here</p>
                            </div>
                        </div>
                        
                        <!-- Create Featured Image -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-pink-500/10 to-rose-500/10 border border-pink-500/20 rounded-xl">
                            <h4 class="text-sm font-medium text-white mb-2">
                                <i class="fas fa-wand-magic-sparkles text-pink-400 mr-2"></i>Create Featured Image
                            </h4>
                            <input type="text" id="featuredImageTitle" placeholder="Enter SEO title for overlay..." 
                                class="w-full px-3 py-2 bg-white/10 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-pink-500">
                            <input type="text" id="featuredImageUrl" placeholder="External image URL (https://...)" 
                                class="w-full px-3 py-2 bg-white/10 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-pink-500">
                            <p class="text-xs text-gray-400 mb-2">üí° Use Unsplash, Imgur, or any image URL. Leave blank to use uploaded images.</p>
                            <select id="featuredImageTemplate" class="w-full px-3 py-2 bg-white/10 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-pink-500">
                                <option value="gradient_bottom">Gradient Bottom</option>
                                <option value="gradient_full">Full Overlay</option>
                                <option value="banner_bottom">Solid Banner</option>
                                <option value="banner_branded">Branded Banner</option>
                                <option value="minimal">Minimal</option>
                            </select>
                            <button onclick="createFeaturedImage()" class="w-full py-2 bg-gradient-to-r from-pink-600 to-rose-600 rounded-lg text-white text-sm font-medium hover:opacity-90 transition">
                                <i class="fas fa-magic mr-1"></i>Create Featured Image
                            </button>
                        </div>
                        
                        <!-- Featured Image Preview -->
                        <div id="featuredImagePreview" class="hidden mt-4">
                            <div class="relative rounded-xl overflow-hidden">
                                <img id="featuredImageResult" src="" alt="Featured Image" class="w-full h-auto">
                                <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/80 to-transparent">
                                    <div class="flex items-center justify-end gap-2">
                                        <a id="featuredImageDownload" href="#" download class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
                                            <i class="fas fa-download text-white text-sm"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Generation -->
                <div class="glass rounded-2xl p-6 mt-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                            <i class="fas fa-layer-group text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Bulk Generate</h3>
                            <p class="text-sm text-gray-400">Generate multiple posts at once</p>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Blog Posts to Generate</label>
                            <select id="bulkBlogCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                <option value="0">0 blogs</option>
                                <option value="3">3 blogs</option>
                                <option value="5" selected>5 blogs</option>
                                <option value="10">10 blogs</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Social Posts Per Platform</label>
                            <select id="bulkSocialCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                <option value="0">0 social</option>
                                <option value="3">3 per platform</option>
                                <option value="5" selected>5 per platform</option>
                                <option value="10">10 per platform</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="generateBulk()" id="btnGenerateBulk" 
                                class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i class="fas fa-rocket"></i> Generate All
                            </button>
                        </div>
                    </div>
                    
                    <div id="oldBulkProgress" class="hidden">
                        <div class="bg-white/5 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-300">Generating content...</span>
                                <span id="oldBulkProgressCount" class="text-purple-400 font-bold">0 / 0</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div id="oldBulkProgressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div id="oldBulkProgressLog" class="mt-3 text-sm text-gray-400 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blogs Panel -->
            <div id="panel-blogs" class="fade-in">
                <!-- Bulk Action Bar -->
                <!-- Search and Filter Bar -->
                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <div class="flex-1 relative">
                        <input type="text" id="blogSearchInput" placeholder="Search blogs by title or keyword..." 
                            oninput="filterBlogs()"
                            class="w-full pl-10 pr-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    </div>
                    <select id="blogStatusFilter" onchange="filterBlogs()" 
                        class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-purple-500">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="approved">Approved</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="published">Published</option>
                    </select>
                    <button onclick="toggleBulkSelect()" id="bulkSelectBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm transition whitespace-nowrap">
                        <i class="fas fa-check-square mr-1"></i>Bulk Select
                    </button>
                </div>
                
                <div id="bulkActionBar" class="hidden mb-4 p-3 bg-purple-500/20 border border-purple-500/50 rounded-xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="selectAllBlogs" onchange="toggleSelectAllBlogs()" class="w-5 h-5 rounded">
                        <span class="text-white font-medium"><span id="selectedCount">0</span> selected</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="bulkApproveBlogs()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-check mr-1"></i>Approve
                        </button>
                        <button onclick="bulkDeleteBlogs()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                        <button onclick="cancelBulkSelect()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-times mr-1"></i>Cancel
                        </button>
                    </div>
                </div>
                
                <div id="blogsList" class="space-y-4">
                    <div class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading blog posts...</p>
                    </div>
                </div>
            </div>

            <!-- Social Panel -->
            <div id="panel-social" class="hidden fade-in">
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <button onclick="filterSocial('all')" id="social-all" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition border-2 border-purple-500">
                        <p class="text-white font-semibold">All Platforms</p>
                        <p id="countAll" class="text-2xl font-bold gradient-text">0</p>
                    </button>
                    <button onclick="filterSocial('gbp')" id="social-gbp" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition">
                        <div class="flex items-center gap-2">
                            <i class="fab fa-google text-blue-400"></i>
                            <p class="text-white font-semibold">Google Business</p>
                        </div>
                        <p id="countGbp" class="text-2xl font-bold text-blue-400">0</p>
                    </button>
                    <button onclick="filterSocial('facebook')" id="social-facebook" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition">
                        <div class="flex items-center gap-2">
                            <i class="fab fa-facebook text-blue-500"></i>
                            <p class="text-white font-semibold">Facebook</p>
                        </div>
                        <p id="countFacebook" class="text-2xl font-bold text-blue-500">0</p>
                    </button>
                    <button onclick="filterSocial('instagram')" id="social-instagram" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition">
                        <div class="flex items-center gap-2">
                            <i class="fab fa-instagram text-pink-500"></i>
                            <p class="text-white font-semibold">Instagram</p>
                        </div>
                        <p id="countInstagram" class="text-2xl font-bold text-pink-500">0</p>
                    </button>
                </div>
                <div id="socialList" class="grid md:grid-cols-2 gap-4">
                    <div class="text-center py-12 col-span-2">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading social posts...</p>
                    </div>
                </div>
            </div>

            <!-- SEO Panel -->
            <div id="panel-seo" class="hidden fade-in">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-bullseye mr-2 text-purple-400"></i>Target Keywords</h3>
                        <div id="keywordsList" class="space-y-2"></div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-crosshairs mr-2 text-orange-400"></i>Competitors</h3>
                        <div id="competitorsList" class="space-y-2"></div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-link mr-2 text-green-400"></i>Service Pages</h3>
                        <div id="servicePagesList" class="space-y-2"></div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-star mr-2 text-yellow-400"></i>Unique Selling Points</h3>
                        <div id="uspsList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Competitor Insights Section -->
                <div class="glass rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white"><i class="fas fa-chart-bar mr-2 text-cyan-400"></i>Competitor Insights</h3>
                        <a href="/elite" class="text-sm text-cyan-400 hover:text-cyan-300">
                            <i class="fas fa-external-link-alt mr-1"></i>Full Analysis
                        </a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-gray-400 border-b border-white/10">
                                    <th class="text-left py-3">Keyword</th>
                                    <th class="text-center py-3">Your Rank</th>
                                    <th class="text-center py-3">Top Competitor</th>
                                    <th class="text-center py-3">Gap</th>
                                </tr>
                            </thead>
                            <tbody id="competitorInsightsTable">
                                <tr>
                                    <td colspan="4" class="text-center py-6 text-gray-500">
                                        <i class="fas fa-chart-line text-3xl mb-2 block"></i>
                                        Loading competitor insights...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Panel -->
            <div id="panel-calendar" class="hidden fade-in">
                <div class="glass rounded-2xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <button onclick="changeMonth(-1)" class="p-2 glass rounded-lg hover:bg-white/10 transition">
                                <i class="fas fa-chevron-left text-white"></i>
                            </button>
                            <h2 id="calendarMonth" class="text-xl font-bold text-white">December 2024</h2>
                            <button onclick="changeMonth(1)" class="p-2 glass rounded-lg hover:bg-white/10 transition">
                                <i class="fas fa-chevron-right text-white"></i>
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="autoSchedule()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg text-white text-sm font-medium hover:opacity-90 transition">
                                <i class="fas fa-magic mr-2"></i>Auto-Schedule
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Sun</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Mon</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Tue</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Wed</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Thu</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Fri</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Sat</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days populated by JS -->
                    </div>
                    
                    <!-- Legend -->
                    <div class="flex items-center gap-6 mt-6 pt-4 border-t border-white/10">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-sm text-gray-400">Blog Post</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                            <span class="text-sm text-gray-400">GBP Post</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
                            <span class="text-sm text-gray-400">Facebook</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-pink-500"></div>
                            <span class="text-sm text-gray-400">Instagram</span>
                        </div>
                    </div>
                </div>
                
                <!-- Scheduled Content List -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-list mr-2 text-purple-400"></i>Scheduled Content</h3>
                    <div id="scheduledList" class="space-y-3">
                        <p class="text-gray-500 text-sm">No content scheduled yet. Click "Auto-Schedule" to create a posting schedule.</p>
                    </div>
                </div>
            </div>
            
            <!-- Reports Panel -->
            <div id="panel-reports" class="hidden fade-in">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Monthly Report -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center">
                                <i class="fas fa-file-pdf text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Monthly Report</h3>
                                <p class="text-sm text-gray-400">Content performance summary</p>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Blog Posts Created</span>
                                <span id="reportBlogs" class="text-white font-bold">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Social Posts Created</span>
                                <span id="reportSocial" class="text-white font-bold">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Total Word Count</span>
                                <span id="reportWords" class="text-white font-bold">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Avg SEO Score</span>
                                <span id="reportSeoScore" class="text-white font-bold">--</span>
                            </div>
                        </div>
                        <button onclick="generateMonthlyReport()" class="w-full py-3 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl text-white font-semibold hover:opacity-90 transition">
                            <i class="fas fa-download mr-2"></i>Download PDF Report
                        </button>
                    </div>
                    
                    <!-- Content Inventory -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-list-alt text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Content Inventory</h3>
                                <p class="text-sm text-gray-400">Export all content data</p>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6">
                            <label class="flex items-center gap-3 p-3 glass rounded-lg cursor-pointer">
                                <input type="checkbox" id="exportBlogs" checked class="w-5 h-5 rounded">
                                <span class="text-white">Include Blog Posts</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 glass rounded-lg cursor-pointer">
                                <input type="checkbox" id="exportSocial" checked class="w-5 h-5 rounded">
                                <span class="text-white">Include Social Posts</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 glass rounded-lg cursor-pointer">
                                <input type="checkbox" id="exportKeywords" checked class="w-5 h-5 rounded">
                                <span class="text-white">Include Keywords</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportInventoryCSV()" class="py-3 glass rounded-xl text-white font-semibold hover:bg-white/10 transition">
                                <i class="fas fa-file-csv mr-2"></i>CSV
                            </button>
                            <button onclick="exportInventoryHTML()" class="py-3 glass rounded-xl text-white font-semibold hover:bg-white/10 transition">
                                <i class="fas fa-file-code mr-2"></i>HTML
                            </button>
                        </div>
                    </div>
                    
                    <!-- Client Summary Card -->
                    <div class="glass rounded-2xl p-6 md:col-span-2">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
                                <i class="fas fa-chart-pie text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Client Summary</h3>
                                <p class="text-sm text-gray-400">One-page overview for client meetings</p>
                            </div>
                        </div>
                        <p class="text-gray-400 mb-4">Generate a professional one-page summary showing content created, keywords targeted, and next steps. Perfect for client review meetings.</p>
                        <button onclick="generateClientSummary()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-semibold hover:opacity-90 transition">
                            <i class="fas fa-file-alt mr-2"></i>Generate Client Summary
                        </button>
                    </div>
                    
                    <!-- Google Analytics 4 Integration -->
                    <div class="glass rounded-2xl p-6 md:col-span-2">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-yellow-600 flex items-center justify-center">
                                    <i class="fab fa-google text-white text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white">Google Analytics 4</h3>
                                    <p class="text-sm text-gray-400">Website traffic and performance</p>
                                </div>
                            </div>
                            <button onclick="refreshGA4Data()" id="refreshGA4Btn" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                        
                        <div id="ga4NotConfigured" class="p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl mb-4">
                            <p class="text-amber-400 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>GA4 not configured. <a href="#" onclick="showTab('settings'); return false;" class="underline hover:text-amber-300">Add your GA4 Property ID in Settings ‚Üí Integrations</a></p>
                        </div>
                        
                        <div id="ga4Data" class="hidden">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div class="text-center p-3 bg-white/5 rounded-xl">
                                    <p id="ga4Sessions" class="text-2xl font-bold text-white">--</p>
                                    <p class="text-xs text-gray-400">Sessions (30d)</p>
                                </div>
                                <div class="text-center p-3 bg-white/5 rounded-xl">
                                    <p id="ga4Users" class="text-2xl font-bold text-blue-400">--</p>
                                    <p class="text-xs text-gray-400">Users (30d)</p>
                                </div>
                                <div class="text-center p-3 bg-white/5 rounded-xl">
                                    <p id="ga4Pageviews" class="text-2xl font-bold text-green-400">--</p>
                                    <p class="text-xs text-gray-400">Pageviews</p>
                                </div>
                                <div class="text-center p-3 bg-white/5 rounded-xl">
                                    <p id="ga4BounceRate" class="text-2xl font-bold text-purple-400">--</p>
                                    <p class="text-xs text-gray-400">Bounce Rate</p>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="p-4 bg-white/5 rounded-xl">
                                    <h4 class="text-white font-medium mb-3"><i class="fas fa-globe mr-2 text-blue-400"></i>Top Pages</h4>
                                    <div id="ga4TopPages" class="space-y-2 text-sm">
                                        <p class="text-gray-500">Loading...</p>
                                    </div>
                                </div>
                                <div class="p-4 bg-white/5 rounded-xl">
                                    <h4 class="text-white font-medium mb-3"><i class="fas fa-search mr-2 text-green-400"></i>Top Search Terms</h4>
                                    <div id="ga4SearchTerms" class="space-y-2 text-sm">
                                        <p class="text-gray-500">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rankings Panel -->
            <div id="panel-rankings" class="hidden fade-in">
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <!-- Average Position -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                                <i class="fas fa-trophy text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Avg Position</span>
                        </div>
                        <div class="text-3xl font-bold text-white" id="rankAvgPosition">#--</div>
                        <div class="text-sm text-gray-500 mt-1" id="rankPositionChange">-- vs last check</div>
                    </div>
                    
                    <!-- Top 3 Keywords -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                <i class="fas fa-medal text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Top 3</span>
                        </div>
                        <div class="text-3xl font-bold text-green-400" id="rankTop3">0</div>
                        <div class="text-sm text-gray-500 mt-1">keywords in top 3</div>
                    </div>
                    
                    <!-- Top 10 Keywords -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-chart-line text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Top 10</span>
                        </div>
                        <div class="text-3xl font-bold text-blue-400" id="rankTop10">0</div>
                        <div class="text-sm text-gray-500 mt-1">keywords in top 10</div>
                    </div>
                    
                    <!-- Traffic Value -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Traffic Value</span>
                        </div>
                        <div class="text-3xl font-bold text-purple-400" id="rankTrafficValue">$0</div>
                        <div class="text-sm text-gray-500 mt-1">monthly SEO value</div>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Keywords Table -->
                    <div class="lg:col-span-2 glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-white">Keyword Rankings</h3>
                            <button onclick="refreshRankings()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition" id="refreshRankBtn">
                                <i class="fas fa-sync-alt mr-2"></i>Check Rankings
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-left text-sm text-gray-400 border-b border-white/10">
                                        <th class="pb-3">Keyword</th>
                                        <th class="pb-3 text-center">Position</th>
                                        <th class="pb-3 text-center">Change</th>
                                        <th class="pb-3 text-center">KD%</th>
                                        <th class="pb-3 text-right">Volume</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingsTable">
                                    <tr>
                                        <td colspan="5" class="py-8 text-center text-gray-500">
                                            <i class="fas fa-search text-2xl mb-2"></i>
                                            <p>Click "Check Rankings" to scan Google</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Position History Chart -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Position History</h3>
                        <div class="h-64">
                            <canvas id="rankHistoryChart"></canvas>
                        </div>
                        <div class="mt-4 space-y-2" id="rankHistoryList">
                            <p class="text-gray-500 text-sm text-center">Historical data will appear after multiple checks</p>
                        </div>
                    </div>
                </div>
                
                <!-- Movement Analysis -->
                <div class="grid md:grid-cols-2 gap-6 mt-6">
                    <!-- Improved -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-green-400 mb-4">
                            <i class="fas fa-arrow-up mr-2"></i>Improved Rankings
                        </h3>
                        <div id="improvedKeywords" class="space-y-2">
                            <p class="text-gray-500 text-sm">No improvements detected yet</p>
                        </div>
                    </div>
                    
                    <!-- Declined -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-red-400 mb-4">
                            <i class="fas fa-arrow-down mr-2"></i>Declined Rankings
                        </h3>
                        <div id="declinedKeywords" class="space-y-2">
                            <p class="text-gray-500 text-sm">No declines detected</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Competitors Panel -->
            <div id="panel-competitors" class="hidden fade-in">
                <!-- Header -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Competitor Intelligence</h2>
                        <p class="text-gray-400">Track and outrank your competition</p>
                    </div>
                    <button onclick="refreshCompetitorDashboard()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium hover:opacity-90 transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Data
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400" id="compCount">0</div>
                        <div class="text-sm text-gray-400">Competitors Tracked</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-green-400" id="compWinRate">0%</div>
                        <div class="text-sm text-gray-400">Win Rate</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-blue-400" id="compGaps">0</div>
                        <div class="text-sm text-gray-400">Content Gaps</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-amber-400" id="compKeywords">0</div>
                        <div class="text-sm text-gray-400">Keywords Tracked</div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- Competitor Cards -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-white">
                                <i class="fas fa-building mr-2 text-purple-400"></i>Your Competitors
                            </h3>
                            <button onclick="showAddCompetitorForm()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition">
                                <i class="fas fa-plus mr-1"></i>Add
                            </button>
                        </div>
                        
                        <!-- Add Competitor Form (hidden by default) -->
                        <div id="addCompetitorForm" class="hidden mb-4 p-4 bg-white/5 rounded-xl border border-purple-500/30">
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Competitor Domain</label>
                                    <input type="text" id="newCompetitorDomain" placeholder="competitor.com" 
                                        class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Name (optional)</label>
                                    <input type="text" id="newCompetitorName" placeholder="Main Competitor" 
                                        class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:border-purple-500">
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="addCompetitor()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition">
                                        <i class="fas fa-plus mr-1"></i>Add Competitor
                                    </button>
                                    <button onclick="hideAddCompetitorForm()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg text-sm transition">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="competitorCards" class="space-y-3">
                            <p class="text-gray-500 text-sm">No competitors added yet. Click "Add" to track a competitor.</p>
                        </div>
                    </div>

                    <!-- Ranking Battles -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-swords mr-2 text-amber-400"></i>Ranking Battles
                        </h3>
                        <div id="rankingBattles" class="space-y-3 max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Check rankings to see battles</p>
                        </div>
                    </div>
                </div>

                <!-- Content Gap Analysis -->
                <div class="glass rounded-2xl p-6 mt-6">
                    <h3 class="text-lg font-bold text-white mb-4">
                        <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Content Gap Opportunities
                    </h3>
                    <p class="text-gray-400 text-sm mb-4">Topics your competitors cover that you don't. Click to generate content.</p>
                    <div id="contentGaps" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <p class="text-gray-500 text-sm col-span-full">Analyzing competitor content...</p>
                    </div>
                </div>
                
                <!-- Competitor Monitoring Settings -->
                <div class="glass rounded-2xl p-6 mt-6">
                    <h3 class="text-lg font-bold text-white mb-4">
                        <i class="fas fa-clock mr-2 text-cyan-400"></i>Auto-Crawl Schedule
                    </h3>
                    <p class="text-gray-400 text-sm mb-4">Automatically monitor competitor websites for new content</p>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="radio" name="crawlFrequency" value="daily" checked class="w-4 h-4 text-cyan-500">
                                <div>
                                    <span class="text-white font-medium">Daily</span>
                                    <p class="text-xs text-gray-500">Crawl every day at 3 AM</p>
                                </div>
                            </label>
                        </div>
                        <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="radio" name="crawlFrequency" value="weekly" class="w-4 h-4 text-cyan-500">
                                <div>
                                    <span class="text-white font-medium">Weekly</span>
                                    <p class="text-xs text-gray-500">Crawl every Monday</p>
                                </div>
                            </label>
                        </div>
                        <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="radio" name="crawlFrequency" value="manual" class="w-4 h-4 text-cyan-500">
                                <div>
                                    <span class="text-white font-medium">Manual Only</span>
                                    <p class="text-xs text-gray-500">Click "Crawl Now" to update</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <button onclick="saveCrawlSettings()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-save mr-2"></i>Save Settings
                        </button>
                        <button onclick="crawlAllCompetitors()" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg text-sm transition">
                            <i class="fas fa-sync-alt mr-2"></i>Crawl All Now
                        </button>
                        <span id="lastCrawlTime" class="text-sm text-gray-500">Last crawl: Never</span>
                    </div>
                </div>
                
                <!-- Content Freshness Alerts -->
                <div class="glass rounded-2xl p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-bell mr-2 text-yellow-400"></i>Freshness Alerts
                        </h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <span class="text-sm text-gray-400">Enable Alerts</span>
                            <input type="checkbox" id="freshnessAlertsEnabled" checked class="w-4 h-4 text-yellow-500 rounded">
                        </label>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Get notified when competitors publish new content</p>
                    
                    <div id="freshnessAlertsList" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-check-circle text-2xl mb-2 opacity-50"></i>
                            <p class="text-sm">No new competitor content detected</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Panel -->
            <div id="panel-settings" class="hidden fade-in">
                <!-- Settings Sub-Navigation -->
                <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                    <button onclick="showSettingsSection('integrations')" id="settings-tab-integrations" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white transition whitespace-nowrap">
                        <i class="fas fa-plug mr-2"></i>Integrations
                    </button>
                    <button onclick="showSettingsSection('notifications')" id="settings-tab-notifications" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white glass transition whitespace-nowrap">
                        <i class="fas fa-bell mr-2"></i>Notifications
                    </button>
                    <button onclick="showSettingsSection('system')" id="settings-tab-system" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white glass transition whitespace-nowrap">
                        <i class="fas fa-heartbeat mr-2"></i>System Status
                    </button>
                </div>
                
                <!-- INTEGRATIONS SECTION (shown by default) -->
                <div id="settings-section-integrations" class="space-y-6">
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-plug text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">API Integrations</h3>
                                <p class="text-sm text-gray-400">Connect your accounts to enable full functionality</p>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- Google Analytics 4 -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-orange-500/20 flex items-center justify-center">
                                        <i class="fas fa-chart-bar text-orange-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">Google Analytics 4</h4>
                                        <p id="ga4StatusTop" class="text-xs text-gray-400">Not configured</p>
                                    </div>
                                </div>
                                <input type="text" id="ga4PropertyIdTop" placeholder="GA4 Property ID (e.g., 123456789)"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-orange-500">
                                <p class="text-xs text-gray-500">Find in GA4 ‚Üí Admin ‚Üí Property Settings</p>
                            </div>
                            
                            <!-- CallRail -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                                        <i class="fas fa-phone text-green-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">CallRail</h4>
                                        <p id="callrailStatusTop" class="text-xs text-gray-400">Not configured</p>
                                    </div>
                                </div>
                                <input type="text" id="callrailCompanyIdTop" placeholder="CallRail Company ID"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-green-500">
                                <p class="text-xs text-gray-500">Links this client to your CallRail account</p>
                            </div>
                            
                            <!-- WordPress -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-sky-500/20 flex items-center justify-center">
                                        <i class="fab fa-wordpress text-sky-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">WordPress</h4>
                                        <p id="wpStatusTop" class="text-xs text-gray-400">Not configured</p>
                                    </div>
                                </div>
                                <input type="text" id="wpSiteUrlTop" placeholder="WordPress URL (https://yoursite.com)"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-sky-500">
                                <input type="text" id="wpUsernameTop" placeholder="WordPress Username"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-sky-500">
                                <input type="password" id="wpAppPasswordTop" placeholder="Application Password"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-sky-500">
                                <p class="text-xs text-gray-500">Users ‚Üí Profile ‚Üí Application Passwords</p>
                            </div>
                            
                            <!-- SEMrush / OpenAI Status -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                        <i class="fas fa-server text-purple-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">Server APIs</h4>
                                        <p class="text-xs text-gray-400">Configured by admin</p>
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">OpenAI (Content)</span>
                                        <span id="openaiStatusTop" class="text-gray-400">Checking...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">SEMrush (Rankings)</span>
                                        <span id="semrushStatusTop" class="text-gray-400">Checking...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">SendGrid (Email)</span>
                                        <span id="sendgridStatusTop" class="text-gray-400">Checking...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="saveIntegrationsTop()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                                <i class="fas fa-save mr-2"></i>Save Integrations
                            </button>
                        </div>
                    </div>
                    
                    <!-- Social Media Connections (inside Settings -> Integrations) -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-white">
                                    <i class="fas fa-share-nodes mr-2 text-blue-400"></i>Social Media Connections
                                </h3>
                                <p class="text-gray-400 text-sm">Connect your social accounts for automated publishing</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="testClientTokens()" class="px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 text-green-300 rounded-lg text-xs transition" title="Test if client's OAuth tokens are working">
                                    <i class="fas fa-vial mr-1"></i>Test Tokens
                                </button>
                                <button onclick="verifyOAuthCredentials()" class="px-3 py-1.5 bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 rounded-lg text-xs transition" title="Verify API credentials are configured correctly">
                                    <i class="fas fa-check-circle mr-1"></i>Verify API Setup
                                </button>
                            </div>
                        </div>
                        <div id="socialConnections" class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- GBP -->
                            <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="gbp">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: #4285F4;">
                                        <i class="fab fa-google text-white"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Google Business</div>
                                        <div class="text-xs text-gray-500" id="gbp-status">Not connected</div>
                                    </div>
                                </div>
                                <button onclick="connectSocial('gbp')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="gbp-btn">
                                    Connect
                                </button>
                            </div>
                            
                            <!-- Facebook -->
                            <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="facebook">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: #1877F2;">
                                        <i class="fab fa-facebook text-white"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Facebook</div>
                                        <div class="text-xs text-gray-500" id="facebook-status">Not connected</div>
                                    </div>
                                </div>
                                <button onclick="connectSocial('facebook')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="facebook-btn">
                                    Connect
                                </button>
                            </div>
                            
                            <!-- Instagram -->
                            <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="instagram">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);">
                                        <i class="fab fa-instagram text-white"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Instagram</div>
                                        <div class="text-xs text-gray-500" id="instagram-status">Not connected</div>
                                    </div>
                                </div>
                                <button onclick="connectSocial('instagram')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="instagram-btn">
                                    Connect
                                </button>
                            </div>
                            
                            <!-- LinkedIn -->
                            <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="linkedin">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: #0A66C2;">
                                        <i class="fab fa-linkedin text-white"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-white text-sm">LinkedIn</div>
                                        <div class="text-xs text-gray-500" id="linkedin-status">Not connected</div>
                                    </div>
                                </div>
                                <button onclick="connectSocial('linkedin')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="linkedin-btn">
                                    Connect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NOTIFICATIONS SECTION (hidden by default) -->
                <div id="settings-section-notifications" class="hidden">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Notification Preferences -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                        <i class="fas fa-bell text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-white">Email Notifications</h3>
                                        <p class="text-sm text-gray-400">Choose what emails you receive</p>
                                    </div>
                                </div>
                                <button onclick="saveNotificationPrefs()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition">
                                    Save Changes
                                </button>
                            </div>
                            
                            <!-- Master Toggle -->
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl mb-6">
                                <div>
                                    <div class="font-medium text-white">Email Notifications</div>
                                    <div class="text-sm text-gray-400">Master toggle for all email notifications</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifEmailEnabled" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            
                            <!-- Content Notifications -->
                            <div class="mb-6">
                                <h4 class="text-white font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-file-alt text-blue-400"></i> Content Notifications
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content scheduled for publishing</span>
                                        <input type="checkbox" id="notifContentScheduled" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content due today (morning reminder)</span>
                                        <input type="checkbox" id="notifContentDueToday" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content published successfully</span>
                                        <input type="checkbox" id="notifContentPublished" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content needs approval</span>
                                        <input type="checkbox" id="notifApprovalNeeded" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Client feedback received</span>
                                        <input type="checkbox" id="notifContentFeedback" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Competitor & Ranking Notifications -->
                            <div class="mb-6">
                                <h4 class="text-white font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-chart-line text-green-400"></i> Competitor & Ranking Alerts
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Competitor publishes new content</span>
                                        <input type="checkbox" id="notifCompetitorContent" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Ranking improved</span>
                                        <input type="checkbox" id="notifRankingImproved" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Ranking dropped</span>
                                        <input type="checkbox" id="notifRankingDropped" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Publishing Notifications -->
                            <div class="mb-6">
                                <h4 class="text-white font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-globe text-purple-400"></i> Publishing Notifications
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">WordPress publishing success</span>
                                        <input type="checkbox" id="notifWpPublished" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">WordPress publishing failed</span>
                                        <input type="checkbox" id="notifWpFailed" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Social media publishing success</span>
                                        <input type="checkbox" id="notifSocialPublished" class="w-4 h-4 text-purple-600 rounded">
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Social media publishing failed</span>
                                        <input type="checkbox" id="notifSocialFailed" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Preferences -->
                    <div class="space-y-6">
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-paper-plane mr-2 text-blue-400"></i>Delivery Settings
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Delivery Frequency</label>
                                    <select id="notifDigestFreq" onchange="updateDigestPreview()" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="instant">Instant (send immediately)</option>
                                        <option value="daily">Daily Digest</option>
                                        <option value="weekly">Weekly Digest</option>
                                    </select>
                                </div>
                                
                                <div id="digestTimeWrapper" class="hidden">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Digest Time</label>
                                    <input type="time" id="notifDigestTime" value="08:00" onchange="updateDigestPreview()"
                                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                </div>
                                
                                <div id="digestDayWrapper" class="hidden">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Digest Day (Weekly)</label>
                                    <select id="notifDigestDay" onchange="updateDigestPreview()" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="0">Monday</option>
                                        <option value="1">Tuesday</option>
                                        <option value="2">Wednesday</option>
                                        <option value="3">Thursday</option>
                                        <option value="4">Friday</option>
                                        <option value="5">Saturday</option>
                                        <option value="6">Sunday</option>
                                    </select>
                                </div>
                                
                                <!-- Next Digest Preview -->
                                <div id="digestPreview" class="hidden p-4 bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/30 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-clock text-blue-400"></i>
                                        <div>
                                            <p class="text-sm text-white font-medium">Next Digest</p>
                                            <p id="nextDigestTime" class="text-xs text-gray-400">Calculating...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quiet Hours -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-moon mr-2 text-indigo-400"></i>Quiet Hours
                            </h3>
                            <p class="text-sm text-gray-400 mb-4">Pause notifications during these hours</p>
                            
                            <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition mb-4">
                                <span class="text-gray-300 text-sm">Enable Quiet Hours</span>
                                <input type="checkbox" id="notifQuietEnabled" class="w-4 h-4 text-purple-600 rounded">
                            </label>
                            
                            <div id="quietHoursConfig" class="space-y-3 opacity-50">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Start Time</label>
                                    <input type="time" id="notifQuietStart" value="22:00" 
                                        class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm" disabled>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">End Time</label>
                                    <input type="time" id="notifQuietEnd" value="07:00" 
                                        class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm" disabled>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Notification -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-vial mr-2 text-amber-400"></i>Test Email
                            </h3>
                            <p class="text-sm text-gray-400 mb-4">Send a test notification to verify email delivery</p>
                            <button onclick="sendTestNotification()" id="testNotifBtn" class="w-full py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-xl font-medium transition">
                                Send Test Email
                            </button>
                        </div>
                        
                        <!-- Notification History -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-history mr-2 text-gray-400"></i>Recent Notifications
                            </h3>
                            <div id="notificationHistory" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500 text-sm">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- End notifications section -->
                
                <!-- Old Integrations Section - hidden, using new one at top -->
                <div id="settings-section-integrations-old" class="hidden">
                <div class="mt-6">
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-plug text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Integrations</h3>
                                <p class="text-sm text-gray-400">Connect external services to enhance your dashboard</p>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Google Analytics 4 -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-orange-500/20 flex items-center justify-center">
                                        <i class="fas fa-chart-bar text-orange-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">Google Analytics 4</h4>
                                        <p id="ga4Status" class="text-xs text-gray-400">Not configured</p>
                                    </div>
                                </div>
                                <input type="text" id="ga4PropertyId" placeholder="GA4 Property ID (e.g., 123456789)"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-orange-500"
                                    onchange="saveIntegration('ga4')">
                                <p class="text-xs text-gray-500">Find in GA4 ‚Üí Admin ‚Üí Property Settings</p>
                            </div>
                            
                            <!-- CallRail -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                                        <i class="fas fa-phone text-green-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">CallRail</h4>
                                        <p id="callrailStatus" class="text-xs text-gray-400">Not configured</p>
                                    </div>
                                </div>
                                <input type="text" id="callrailCompanyId" placeholder="CallRail Company ID"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-green-500"
                                    onchange="saveIntegration('callrail')">
                                <p class="text-xs text-gray-500">Links this client to your CallRail account</p>
                            </div>
                            
                            <!-- Google Search Console -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                                        <i class="fas fa-search text-blue-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">Search Console</h4>
                                        <p id="gscStatus" class="text-xs text-gray-400">Not configured</p>
                                    </div>
                                </div>
                                <input type="text" id="gscSiteUrl" placeholder="Site URL (e.g., https://example.com)"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-blue-500"
                                    onchange="saveIntegration('gsc')">
                                <p class="text-xs text-gray-500">Must match URL in Search Console</p>
                            </div>
                            
                            <!-- WordPress -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-sky-500/20 flex items-center justify-center">
                                        <i class="fab fa-wordpress text-sky-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">WordPress</h4>
                                        <p id="wpStatus" class="text-xs text-gray-400">Not configured</p>
                                    </div>
                                </div>
                                <input type="text" id="wpSiteUrl" placeholder="WordPress URL"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-sky-500">
                                <input type="password" id="wpAppPassword" placeholder="Application Password"
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm mb-2 focus:outline-none focus:border-sky-500"
                                    onchange="saveIntegration('wordpress')">
                                <p class="text-xs text-gray-500">Users ‚Üí Edit ‚Üí Application Passwords</p>
                            </div>
                            
                            <!-- SEMrush -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-orange-600/20 flex items-center justify-center">
                                        <i class="fas fa-rocket text-orange-500"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">SEMrush</h4>
                                        <p id="semrushStatus" class="text-xs text-gray-400">Server-side config</p>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400 p-2 bg-white/5 rounded-lg">
                                    <i class="fas fa-server mr-1"></i> Configured via environment variable
                                    <code class="text-purple-400 ml-1">SEMRUSH_API_KEY</code>
                                </div>
                            </div>
                            
                            <!-- OpenAI -->
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                        <i class="fas fa-brain text-emerald-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-white">OpenAI</h4>
                                        <p id="openaiStatus" class="text-xs text-gray-400">Server-side config</p>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400 p-2 bg-white/5 rounded-lg">
                                    <i class="fas fa-server mr-1"></i> Configured via environment variable
                                    <code class="text-purple-400 ml-1">OPENAI_API_KEY</code>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Button -->
                        <div class="mt-6 flex justify-end">
                            <button onclick="saveAllIntegrations()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                                <i class="fas fa-save mr-2"></i>Save Integrations
                            </button>
                        </div>
                    </div>
                </div>
                </div> <!-- End old integrations hidden section -->
                
                <!-- SYSTEM STATUS SECTION -->
                <div id="settings-section-system" class="hidden">
                <div class="mt-6">
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                    <i class="fas fa-heartbeat text-white text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white">System Status</h3>
                                    <p class="text-sm text-gray-400">Server-side integrations & API connections</p>
                                </div>
                            </div>
                            <button onclick="loadSystemStatus()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                        
                        <div id="systemStatusContent" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500 col-span-full">Loading system status...</p>
                        </div>
                        
                        <div id="systemStatusSummary" class="mt-4 p-4 bg-white/5 rounded-xl hidden">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400">Overall Status</span>
                                <span id="systemStatusPercent" class="text-lg font-bold text-white">--%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                                <div id="systemStatusBar" class="bg-gradient-to-r from-green-500 to-emerald-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- End system status section -->
            </div>
            
            <!-- Chatbot Panel -->
            <div id="panel-chatbot" class="hidden fade-in">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Chatbot Config -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Status Card -->
                        <div class="glass rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                        <i class="fas fa-robot text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-white">AI Website Chatbot</h3>
                                        <p class="text-sm text-gray-400">24/7 Lead capture for your website</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="chatbotEnabled" class="sr-only peer" onchange="toggleChatbot()">
                                    <div class="w-14 h-7 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                            
                            <div id="chatbotStats" class="grid grid-cols-3 gap-4 mb-6">
                                <div class="text-center p-3 glass rounded-xl">
                                    <p id="chatbotConversations" class="text-2xl font-bold text-white">0</p>
                                    <p class="text-xs text-gray-400">Conversations</p>
                                </div>
                                <div class="text-center p-3 glass rounded-xl">
                                    <p id="chatbotLeads" class="text-2xl font-bold text-green-400">0</p>
                                    <p class="text-xs text-gray-400">Leads Captured</p>
                                </div>
                                <div class="text-center p-3 glass rounded-xl">
                                    <p id="chatbotRating" class="text-2xl font-bold text-yellow-400">--</p>
                                    <p class="text-xs text-gray-400">Avg Rating</p>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/30 rounded-xl">
                                <p class="text-sm text-gray-300 mb-2"><i class="fas fa-info-circle text-purple-400 mr-2"></i>Your chatbot is trained on:</p>
                                <ul class="text-sm text-gray-400 space-y-1 ml-6">
                                    <li>‚Ä¢ Business name, services, and location</li>
                                    <li>‚Ä¢ Your target keywords and service areas</li>
                                    <li>‚Ä¢ Unique selling points and FAQs</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Appearance Settings -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-palette mr-2 text-pink-400"></i>Appearance</h3>
                            <div class="grid sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Bot Name</label>
                                    <input type="text" id="chatbotName" value="Support Assistant" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Position</label>
                                    <select id="chatbotPosition" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                        <option value="bottom-right">Bottom Right</option>
                                        <option value="bottom-left">Bottom Left</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Primary Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="chatbotColor" value="#8b5cf6" class="w-12 h-10 rounded cursor-pointer">
                                        <input type="text" id="chatbotColorText" value="#8b5cf6" class="flex-1 px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Secondary Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="chatbotColor2" value="#ec4899" class="w-12 h-10 rounded cursor-pointer">
                                        <input type="text" id="chatbotColor2Text" value="#ec4899" class="flex-1 px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm text-gray-400 mb-2">Welcome Message</label>
                                <textarea id="chatbotWelcome" rows="2" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Hi! How can I help you today?"></textarea>
                            </div>
                        </div>
                        
                        <!-- Lead Capture Settings -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-user-plus mr-2 text-green-400"></i>Lead Capture</h3>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/20">
                                    <div>
                                        <span class="text-white font-medium">Enable Lead Capture</span>
                                        <p class="text-xs text-gray-400">Prompt visitors for contact info</p>
                                    </div>
                                    <input type="checkbox" id="chatbotLeadEnabled" checked class="w-5 h-5 rounded">
                                </label>
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Collect Name</span>
                                    <input type="checkbox" id="chatbotCollectName" checked class="w-5 h-5 rounded">
                                </label>
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Collect Email</span>
                                    <input type="checkbox" id="chatbotCollectEmail" checked class="w-5 h-5 rounded">
                                </label>
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Collect Phone</span>
                                    <input type="checkbox" id="chatbotCollectPhone" checked class="w-5 h-5 rounded">
                                </label>
                                <div class="pt-3">
                                    <label class="block text-sm text-gray-400 mb-2">Prompt for info after</label>
                                    <select id="chatbotLeadTrigger" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                        <option value="after_1_message">1 message</option>
                                        <option value="after_3_messages" selected>3 messages</option>
                                        <option value="after_5_messages">5 messages</option>
                                        <option value="never">Never (manual only)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notifications -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-bell mr-2 text-yellow-400"></i>Notifications</h3>
                            <div class="space-y-4">
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Email notifications for new leads</span>
                                    <input type="checkbox" id="chatbotEmailNotify" checked class="w-5 h-5 rounded">
                                </label>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Notification Email</label>
                                    <input type="email" id="chatbotNotifyEmail" placeholder="your@email.com" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Button -->
                        <button onclick="saveChatbotConfig()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-bold text-lg hover:opacity-90 transition">
                            <i class="fas fa-save mr-2"></i>Save Chatbot Settings
                        </button>
                    </div>
                    
                    <!-- Preview & Embed Code -->
                    <div class="space-y-6">
                        <!-- Live Preview -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-eye mr-2 text-cyan-400"></i>Preview</h3>
                            <div class="relative bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 h-[400px] overflow-hidden">
                                <!-- Mini chat preview -->
                                <div id="chatbotPreview" class="absolute bottom-4 right-4 w-[280px]">
                                    <!-- Bubble -->
                                    <div id="previewBubble" class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg cursor-pointer ml-auto" style="background: linear-gradient(135deg, #8b5cf6, #ec4899);">
                                        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                                        </svg>
                                    </div>
                                    <!-- Window -->
                                    <div id="previewWindow" class="hidden absolute bottom-16 right-0 w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
                                        <div id="previewHeader" class="p-3 text-white" style="background: linear-gradient(135deg, #8b5cf6, #ec4899);">
                                            <div class="flex items-center gap-2">
                                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                                                </div>
                                                <div>
                                                    <div id="previewName" class="font-semibold text-sm">Support Assistant</div>
                                                    <div class="text-xs opacity-75">Online</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="p-3 bg-gray-50 h-[120px]">
                                            <div id="previewMessage" class="bg-gray-200 text-gray-800 text-xs p-2 rounded-lg rounded-bl-none max-w-[80%]">
                                                Hi! How can I help you today?
                                            </div>
                                        </div>
                                        <div class="p-2 border-t flex gap-2">
                                            <input type="text" placeholder="Type a message..." class="flex-1 text-xs px-3 py-2 border rounded-full text-gray-600">
                                            <button class="w-8 h-8 rounded-full flex items-center justify-center" style="background: #8b5cf6;">
                                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-gray-500 text-sm text-center pt-2">Click bubble to preview</p>
                            </div>
                        </div>
                        
                        <!-- Embed Code -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-code mr-2 text-green-400"></i>Embed Code</h3>
                            <p class="text-sm text-gray-400 mb-4">Add this code to your website before the closing <code class="text-pink-400">&lt;/body&gt;</code> tag:</p>
                            <div class="relative">
                                <pre id="chatbotEmbedCode" class="bg-gray-900 p-4 rounded-xl text-xs text-green-400 overflow-x-auto whitespace-pre-wrap break-all">Loading embed code...</pre>
                                <button onclick="copyEmbedCode()" class="absolute top-2 right-2 px-3 py-1 bg-purple-600 rounded text-white text-xs hover:bg-purple-700 transition">
                                    <i class="fas fa-copy mr-1"></i>Copy
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Conversations -->
                        <div class="glass rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-white"><i class="fas fa-comments mr-2 text-blue-400"></i>Recent Chats</h3>
                                <a href="#" onclick="viewAllConversations()" class="text-sm text-purple-400 hover:text-purple-300">View All ‚Üí</a>
                            </div>
                            <div id="recentConversations" class="space-y-3">
                                <p class="text-gray-500 text-sm text-center py-4">No conversations yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Leads Panel -->
            <div id="panel-leads" class="hidden fade-in">
                <!-- Lead Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-xl p-4 text-center">
                        <p class="text-2xl font-bold text-white" id="leadsTotal">0</p>
                        <p class="text-sm text-gray-400">Total Leads</p>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <p class="text-2xl font-bold text-blue-400" id="leadsNew">0</p>
                        <p class="text-sm text-gray-400">New</p>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <p class="text-2xl font-bold text-green-400" id="leadsWon">0</p>
                        <p class="text-sm text-gray-400">Won</p>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <p class="text-2xl font-bold text-purple-400" id="leadsTotalValue">$0</p>
                        <p class="text-sm text-gray-400">Total Value</p>
                    </div>
                </div>
                
                <!-- Leads List -->
                <div class="glass rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-user-plus text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Lead Management</h3>
                                <p class="text-sm text-gray-400">Track and manage your leads</p>
                            </div>
                        </div>
                        <select id="leadStatusFilter" onchange="loadLeads()" class="px-3 py-2 glass rounded-lg text-white text-sm">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="proposal">Proposal</option>
                            <option value="won">Won</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>
                    <div id="leadsList" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-user-plus text-4xl mb-4 opacity-50"></i>
                            <p>No leads captured yet</p>
                            <p class="text-sm mt-2">Leads from calls, forms, and chatbot will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reviews Panel -->
            <div id="panel-reviews" class="hidden fade-in">
                <!-- Review Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-yellow-400" id="reviewsAvgRating">--</div>
                        <div class="text-sm text-gray-400">Avg Rating</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-white" id="reviewsTotal">0</div>
                        <div class="text-sm text-gray-400">Total Reviews</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-green-400" id="reviewsPositive">0</div>
                        <div class="text-sm text-gray-400">Positive (4-5‚òÖ)</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-blue-400" id="reviewsResponded">0%</div>
                        <div class="text-sm text-gray-400">Response Rate</div>
                    </div>
                </div>
                
                <!-- Review Actions -->
                <div class="glass rounded-2xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-magic mr-2 text-purple-400"></i>Quick Actions
                        </h3>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <button onclick="generateAllReviewResponses()" class="p-4 bg-white/5 hover:bg-white/10 rounded-xl text-left transition border border-white/10">
                            <i class="fas fa-robot text-purple-400 text-xl mb-2"></i>
                            <h4 class="text-white font-medium">Auto-Generate Responses</h4>
                            <p class="text-sm text-gray-400">AI generates replies for all pending reviews</p>
                        </button>
                        <button onclick="sendReviewRequests()" class="p-4 bg-white/5 hover:bg-white/10 rounded-xl text-left transition border border-white/10">
                            <i class="fas fa-paper-plane text-blue-400 text-xl mb-2"></i>
                            <h4 class="text-white font-medium">Request Reviews</h4>
                            <p class="text-sm text-gray-400">Send review requests to recent customers</p>
                        </button>
                        <button onclick="showTab('settings')" class="p-4 bg-white/5 hover:bg-white/10 rounded-xl text-left transition border border-white/10">
                            <i class="fab fa-google text-red-400 text-xl mb-2"></i>
                            <h4 class="text-white font-medium">Connect GBP</h4>
                            <p class="text-sm text-gray-400">Link Google Business Profile</p>
                        </button>
                    </div>
                </div>
                
                <!-- Reviews List -->
                <div class="glass rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center">
                                <i class="fas fa-star text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Review Management</h3>
                                <p class="text-sm text-gray-400">Monitor and respond to reviews</p>
                            </div>
                        </div>
                        <button onclick="loadReviews()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <div id="reviewsList" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-star text-4xl mb-4 opacity-50"></i>
                            <p>No reviews synced yet</p>
                            <p class="text-sm mt-2">Connect your Google Business Profile to see reviews</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calls Panel -->
            <div id="panel-calls" class="hidden fade-in">
                <!-- Call Stats Overview -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-green-400" id="callsTotal">0</div>
                        <div class="text-sm text-gray-400">Total Calls</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-blue-400" id="callsAnswered">0</div>
                        <div class="text-sm text-gray-400">Answered</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-amber-400" id="callsAvgDuration">0:00</div>
                        <div class="text-sm text-gray-400">Avg Duration</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400" id="callsLeads">0</div>
                        <div class="text-sm text-gray-400">Leads Generated</div>
                    </div>
                </div>
                
                <!-- Call Intelligence Insights -->
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Top Customer Questions
                        </h3>
                        <div id="topQuestions" class="space-y-2">
                            <p class="text-gray-500 text-sm">Analyzing call transcripts...</p>
                        </div>
                    </div>
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-tags mr-2 text-blue-400"></i>Common Keywords
                        </h3>
                        <div id="callKeywords" class="flex flex-wrap gap-2">
                            <p class="text-gray-500 text-sm">Analyzing call transcripts...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Call List -->
                <div class="glass rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                <i class="fas fa-phone text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Call Intelligence</h3>
                                <p class="text-sm text-gray-400">AI-analyzed call transcripts and insights</p>
                            </div>
                        </div>
                        <button onclick="refreshCallData()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <div id="callsList" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                            <p>No calls analyzed yet</p>
                            <p class="text-sm mt-2">Connect CallRail in Settings ‚Üí Integrations to analyze calls</p>
                            <button onclick="showTab('settings')" class="mt-4 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg text-white text-sm hover:opacity-90 transition">
                                <i class="fas fa-cog mr-2"></i>Connect CallRail
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pages Panel -->
            <div id="panel-pages" class="hidden fade-in">
                <div class="glass rounded-2xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                            <i class="fas fa-file-code text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Website Pages</h3>
                            <p class="text-sm text-gray-400">Manage service pages and landing pages</p>
                        </div>
                    </div>
                    <div id="pagesList" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-file-code text-4xl mb-4 opacity-50"></i>
                            <p>No pages created yet</p>
                            <p class="text-sm mt-2">Generate service pages from the Generate tab</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blog Preview Modal -->
    <div id="blogModal" class="hidden fixed inset-0 bg-black/90 z-50 overflow-y-auto" onclick="if(event.target === this) closeBlogModal()">
        <div class="max-w-4xl mx-auto py-8 px-4">
            <div class="glass-light rounded-2xl overflow-hidden fade-in" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <span id="modalKeyword" class="inline-block px-3 py-1 bg-white/20 rounded-full text-white text-sm mb-2"></span>
                            <h1 id="modalTitle" class="text-2xl md:text-3xl font-bold text-white"></h1>
                            <!-- Edit mode title input -->
                            <input type="text" id="modalTitleEdit" class="hidden w-full text-2xl font-bold bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white placeholder-white/50 mt-2">
                        </div>
                        <button onclick="closeBlogModal()" class="p-2 hover:bg-white/20 rounded-lg transition ml-4">
                            <i class="fas fa-times text-white text-xl"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-4 mt-4 text-white/80 text-sm">
                        <span><i class="fas fa-clock mr-1"></i><span id="modalWordCount">0</span> words</span>
                        <span><i class="fas fa-link mr-1"></i><span id="modalLinkCount">0</span> internal links</span>
                        <span id="modalStatus" class="px-2 py-1 bg-white/20 rounded"></span>
                    </div>
                </div>
                <div class="p-6 md:p-8">
                    <!-- SEO Score Card -->
                    <div id="seoScoreCard" class="mb-6 p-4 bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg"><i class="fas fa-chart-line mr-2 text-green-400"></i>SEO Score</h3>
                            <div class="flex items-center gap-2">
                                <span id="seoScoreValue" class="text-3xl font-bold text-green-400">--</span>
                                <span class="text-gray-400">/100</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-4">
                            <div id="seoScoreBar" class="bg-gradient-to-r from-green-500 to-emerald-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                            <div id="seoWordCount" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Word Count</span>
                            </div>
                            <div id="seoKeywordDensity" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Keyword Density</span>
                            </div>
                            <div id="seoInternalLinks" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Internal Links</span>
                            </div>
                            <div id="seoMetaTitle" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Meta Title</span>
                            </div>
                            <div id="seoMetaDesc" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Meta Description</span>
                            </div>
                            <div id="seoHeadings" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Heading Structure</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Meta fields - View mode -->
                    <div id="metaViewMode" class="mb-6 p-4 bg-gray-50 rounded-xl">
                        <p class="text-sm text-gray-500 mb-1">Meta Title</p>
                        <p id="modalMetaTitle" class="font-medium text-gray-800"></p>
                        <p class="text-sm text-gray-500 mt-3 mb-1">Meta Description</p>
                        <p id="modalMetaDesc" class="text-gray-600"></p>
                    </div>
                    
                    <!-- Meta fields - Edit mode -->
                    <div id="metaEditMode" class="hidden mb-6 p-4 bg-gray-50 rounded-xl space-y-4">
                        <div>
                            <label class="text-sm text-gray-500 mb-1 block">Meta Title <span id="metaTitleCount" class="text-xs">(0/60)</span></label>
                            <input type="text" id="modalMetaTitleEdit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" maxlength="70">
                        </div>
                        <div>
                            <label class="text-sm text-gray-500 mb-1 block">Meta Description <span id="metaDescCount" class="text-xs">(0/160)</span></label>
                            <textarea id="modalMetaDescEdit" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" maxlength="170"></textarea>
                        </div>
                    </div>
                    
                    <!-- Featured Image Section -->
                    <div id="featuredImageSection" class="mb-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-800 flex items-center gap-2">
                                <i class="fas fa-image text-amber-500"></i>Featured Image
                            </h4>
                            <div class="flex gap-2">
                                <button onclick="openImagePicker()" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition flex items-center gap-2">
                                    <i class="fas fa-images"></i> Select from Library
                                </button>
                                <button onclick="generateBlogImage()" id="btnGenerateBlogImage" class="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-sm rounded-lg transition flex items-center gap-2">
                                    <i class="fas fa-wand-magic-sparkles"></i> AI Generate
                                </button>
                            </div>
                        </div>
                        
                        <!-- Title Overlay Options -->
                        <div id="titleOverlaySection" class="mb-3 p-3 bg-white/80 rounded-lg border border-amber-200">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Title Overlay (burned into image)</label>
                            <input type="text" id="featuredTitleOverlay" placeholder="Enter title to overlay on image..." 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-amber-500 focus:ring-2 focus:ring-amber-200 mb-2">
                            <div class="flex gap-2 items-center mb-2">
                                <select id="featuredOverlayTemplate" class="flex-1 px-2 py-1.5 border border-gray-300 rounded-lg text-sm" onchange="toggleProBrandedOptions()">
                                    <option value="branded_right">‚≠ê Pro Branded (Right Box)</option>
                                    <option value="gradient_bottom">Gradient Bottom</option>
                                    <option value="gradient_full">Full Overlay</option>
                                    <option value="banner_bottom">Solid Banner</option>
                                    <option value="banner_branded">Branded Banner</option>
                                    <option value="minimal">Minimal</option>
                                </select>
                                <button onclick="createFeaturedWithOverlay()" class="px-3 py-1.5 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white text-sm rounded-lg transition flex items-center gap-1">
                                    <i class="fas fa-fire"></i> Burn Title
                                </button>
                            </div>
                            <!-- Pro Branded Options (shown when branded_right selected) -->
                            <div id="proBrandedOptions" class="mt-2 p-2 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="featuredPhone" placeholder="Phone: (941) 629-2863" 
                                        class="px-2 py-1.5 border border-gray-300 rounded text-sm">
                                    <input type="text" id="featuredCTA" placeholder="CTA: Call to schedule..." 
                                        class="px-2 py-1.5 border border-gray-300 rounded text-sm">
                                </div>
                                <input type="text" id="featuredLogoUrl" placeholder="Logo URL (optional)" 
                                    class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm mt-2">
                                <p class="text-xs text-blue-600 mt-1">üí° Pro template: Title + Phone + Logo like Nandip's style</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">üí° First select an image from library, then burn the title onto it</p>
                        </div>
                        
                        <!-- Selected Source Image Preview -->
                        <div id="sourceImagePreview" class="hidden mb-3">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Source Image Selected:</label>
                            <div class="relative inline-block">
                                <img id="sourceImageThumb" src="" alt="Source" class="h-20 rounded-lg border-2 border-blue-400">
                                <button onclick="clearSourceImage()" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Final Featured Image Preview -->
                        <div id="featuredImagePreview" class="hidden">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Final Featured Image:</label>
                            <img id="modalFeaturedImage" src="" alt="Featured Image" class="w-full h-48 object-cover rounded-lg mb-2 border-2 border-green-400">
                            <div class="flex gap-2">
                                <a id="featuredImageDownloadLink" href="#" download class="text-xs text-blue-600 hover:text-blue-700">
                                    <i class="fas fa-download mr-1"></i>Download
                                </a>
                                <button onclick="removeFeaturedImage()" class="text-xs text-red-600 hover:text-red-700">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                        <div id="featuredImageEmpty" class="text-center py-6 text-gray-400">
                            <i class="fas fa-image text-3xl mb-2 opacity-50"></i>
                            <p class="text-sm">No featured image yet</p>
                            <p class="text-xs">Select from library or generate with AI</p>
                        </div>
                        <div id="featuredImageLoading" class="hidden text-center py-6">
                            <div class="spinner w-8 h-8 mx-auto mb-2 border-amber-500"></div>
                            <p class="text-sm text-amber-600">Creating featured image...</p>
                        </div>
                    </div>
                    
                    <!-- Body - View mode -->
                    <div id="modalBody" class="blog-content"></div>
                    
                    <!-- Body - Edit mode -->
                    <div id="bodyEditMode" class="hidden">
                        <label class="text-sm text-gray-500 mb-2 block">Blog Content (HTML)</label>
                        <textarea id="modalBodyEdit" rows="20" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-200"></textarea>
                        <p class="text-xs text-gray-400 mt-1">Word count: <span id="editWordCount">0</span></p>
                    </div>
                    
                    <div id="modalFaq" class="mt-8 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-question-circle mr-2 text-purple-500"></i>Frequently Asked Questions</h3>
                        <div id="faqContent" class="space-y-4"></div>
                    </div>
                </div>
                
                <!-- Footer - View mode -->
                <div id="footerViewMode" class="border-t p-4 flex justify-between items-center bg-gray-50 flex-wrap gap-2">
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="copyBlogContent()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-copy mr-1"></i>Copy
                        </button>
                        <button onclick="downloadBlog()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-file-alt mr-1"></i>Markdown
                        </button>
                        <button onclick="downloadBlogHTML()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-code mr-1"></i>HTML
                        </button>
                        <button onclick="downloadBlogWord()" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-file-word mr-1"></i>Word
                        </button>
                        <button onclick="showCurrentSERPPreview()" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg text-sm font-medium transition" title="Preview in Google Search Results">
                            <i class="fab fa-google mr-1"></i>SERP Preview
                        </button>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="enterEditMode()" class="px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="confirmDeleteBlog()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                        <button onclick="showScheduleModal()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-calendar mr-1"></i>Schedule
                        </button>
                        <button onclick="publishToWordPress()" class="px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-lg text-sm font-medium transition" title="Publish to WordPress">
                            <i class="fab fa-wordpress mr-1"></i>WordPress
                        </button>
                        <button onclick="approveBlog()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition">
                            <i class="fas fa-check mr-1"></i>Approve
                        </button>
                    </div>
                </div>
                
                <!-- Footer - Edit mode -->
                <div id="footerEditMode" class="hidden border-t p-4 flex justify-between items-center bg-amber-50">
                    <div class="flex items-center gap-2 text-amber-700">
                        <i class="fas fa-edit"></i>
                        <span class="font-medium">Edit Mode</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="cancelEditMode()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-times mr-1"></i>Cancel
                        </button>
                        <button onclick="saveBlogEdits()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition">
                            <i class="fas fa-save mr-1"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Picker Modal -->
    <div id="imagePickerModal" class="hidden fixed inset-0 bg-black/90 z-[60] overflow-y-auto" onclick="if(event.target === this) closeImagePicker()">
        <div class="min-h-screen py-8 px-4">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between bg-gradient-to-r from-blue-500 to-cyan-500">
                    <h3 class="text-lg font-bold text-white">
                        <i class="fas fa-images mr-2"></i>Select Image from Library
                    </h3>
                    <button onclick="closeImagePicker()" class="text-white/80 hover:text-white text-xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-4">
                    <!-- Category Filter -->
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <button onclick="filterPickerImages('all')" class="picker-category-btn active px-3 py-1.5 bg-blue-500 text-white text-sm rounded-full whitespace-nowrap" data-category="all">
                            All Images
                        </button>
                        <button onclick="filterPickerImages('hero')" class="picker-category-btn px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-full whitespace-nowrap" data-category="hero">
                            Hero
                        </button>
                        <button onclick="filterPickerImages('blog')" class="picker-category-btn px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-full whitespace-nowrap" data-category="blog">
                            Blog
                        </button>
                        <button onclick="filterPickerImages('team')" class="picker-category-btn px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-full whitespace-nowrap" data-category="team">
                            Team
                        </button>
                        <button onclick="filterPickerImages('service')" class="picker-category-btn px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-full whitespace-nowrap" data-category="service">
                            Service
                        </button>
                        <button onclick="filterPickerImages('general')" class="picker-category-btn px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-full whitespace-nowrap" data-category="general">
                            General
                        </button>
                    </div>
                    
                    <!-- Image Grid -->
                    <div id="pickerImageGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 max-h-[60vh] overflow-y-auto">
                        <div class="col-span-full text-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading images...</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                    <p class="text-sm text-gray-500">
                        <span id="pickerImageCount">0</span> images available
                    </p>
                    <div class="flex gap-2">
                        <button onclick="closeImagePicker()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div id="scheduleModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center" onclick="if(event.target === this) closeScheduleModal()">
        <div class="glass-light rounded-2xl p-6 w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Schedule Content</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Publish Date</label>
                    <input type="date" id="scheduleDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Publish Time</label>
                    <input type="time" id="scheduleTime" value="09:00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeScheduleModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition">Cancel</button>
                <button onclick="saveSchedule()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">Schedule</button>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div id="editClientModal" class="hidden fixed inset-0 bg-black/90 z-50 overflow-y-auto" onclick="if(event.target === this) closeEditClient()">
        <div class="max-w-3xl mx-auto py-8 px-4">
            <div class="glass-light rounded-2xl overflow-hidden fade-in" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white">Edit Client</h2>
                            <p class="text-white/70 text-sm">Update client information and SEO settings</p>
                        </div>
                        <button onclick="closeEditClient()" class="p-2 hover:bg-white/20 rounded-lg transition">
                            <i class="fas fa-times text-white text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 space-y-6 bg-gray-900 max-h-[70vh] overflow-y-auto">
                    <!-- Business Info Section -->
                    <div class="border-b border-white/10 pb-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-building mr-2"></i>Business Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Business Name *</label>
                                <input type="text" id="editBusinessName" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Industry</label>
                                <input type="text" id="editIndustry" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Location (City, State)</label>
                                <input type="text" id="editGeo" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Website URL</label>
                                <input type="text" id="editWebsite" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="https://">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Phone</label>
                                <input type="text" id="editPhone" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Email</label>
                                <input type="email" id="editEmail" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Settings Section -->
                    <div class="border-b border-white/10 pb-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-pen-fancy mr-2"></i>Content Settings
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Writing Tone</label>
                                <select id="editTone" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                                    <option value="professional">Professional</option>
                                    <option value="friendly">Friendly</option>
                                    <option value="casual">Casual</option>
                                    <option value="formal">Formal</option>
                                    <option value="conversational">Conversational</option>
                                    <option value="authoritative">Authoritative</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Service Areas (comma separated)</label>
                                <input type="text" id="editServiceAreas" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="Miami, Fort Lauderdale, Palm Beach">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm text-gray-400 mb-1">Unique Selling Points (comma separated)</label>
                            <textarea id="editUSPs" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="24/7 service, Licensed & insured, 20+ years experience"></textarea>
                        </div>
                    </div>
                    
                    <!-- SEO Keywords Section -->
                    <div class="border-b border-white/10 pb-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-search mr-2"></i>SEO Keywords
                        </h3>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Primary Keywords (comma separated)</label>
                            <textarea id="editPrimaryKeywords" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="HVAC repair, AC installation, heating service"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Main keywords for blog content generation</p>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm text-gray-400 mb-1">Secondary Keywords (comma separated)</label>
                            <textarea id="editSecondaryKeywords" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="air conditioning maintenance, furnace repair, ductwork"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Supporting keywords and long-tail variations</p>
                        </div>
                    </div>
                    
                    <!-- Competitors Section -->
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-users mr-2"></i>Competitors
                        </h3>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Competitor Websites (comma separated)</label>
                            <textarea id="editCompetitors" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="competitor1.com, competitor2.com"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Used for competitive analysis and content gap identification</p>
                        </div>
                    </div>
                    
                    <!-- WordPress Integration Section -->
                    <div class="border-t border-white/10 pt-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fab fa-wordpress mr-2"></i>WordPress Integration
                        </h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">WordPress Site URL</label>
                                <input type="text" id="editWordpressUrl" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="https://yoursite.com">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">WordPress Username</label>
                                    <input type="text" id="editWordpressUser" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">App Password</label>
                                    <input type="password" id="editWordpressPassword" autocomplete="off" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="xxxx xxxx xxxx xxxx">
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button type="button" onclick="testWordPressConnection()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition">
                                    <i class="fas fa-plug mr-1"></i>Test Connection
                                </button>
                                <span id="wpTestResult" class="text-sm"></span>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                Generate an App Password in WordPress: Users ‚Üí Profile ‚Üí Application Passwords
                            </p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-4 border-t border-white/10">
                        <button onclick="saveClientEdits()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:opacity-90 transition">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button onclick="closeEditClient()" class="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug logging - ENABLED for troubleshooting
        const DEBUG = true; // Temporarily enabled
        // if (!DEBUG) { console.log = () => {}; console.error = () => {}; }
        console.log('=== MCP Dashboard v5.5.148 Loaded ===');
        
        // ==========================================
        // LOADING STATE UTILITY
        // ==========================================
        function withLoading(btn, asyncFn) {
            return async function(...args) {
                const originalHTML = btn.innerHTML;
                const originalDisabled = btn.disabled;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                btn.disabled = true;
                try {
                    return await asyncFn.apply(this, args);
                } finally {
                    btn.innerHTML = originalHTML;
                    btn.disabled = originalDisabled;
                }
            };
        }
        
        function setButtonLoading(btn, loading, loadingText = 'Processing...') {
            if (loading) {
                btn.dataset.originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}`;
                btn.disabled = true;
            } else {
                btn.innerHTML = btn.dataset.originalHtml || btn.innerHTML;
                btn.disabled = false;
            }
        }
        
        // Mobile navigation toggle
        function toggleMobileNav() {
            const nav = document.getElementById('mobileNav');
            nav.classList.toggle('hidden');
        }
        
        // ==========================================
        // WHITE-LABEL BRANDING
        // ==========================================
        function loadBranding() {
            const saved = localStorage.getItem('mcp_branding');
            if (!saved) return;
            
            try {
                const branding = JSON.parse(saved);
                
                // Update page title
                document.title = `Content Dashboard | ${branding.agencyName}`;
                
                // Update login screen branding
                const loginTitle = document.querySelector('.gradient-text');
                if (loginTitle) loginTitle.textContent = branding.agencyName;
                
                // Update any brand name elements
                document.querySelectorAll('[data-brand="name"]').forEach(el => {
                    el.textContent = branding.agencyName;
                });
                
                // Apply brand colors via CSS variables
                if (branding.primaryColor) {
                    document.documentElement.style.setProperty('--brand-primary', branding.primaryColor);
                }
                if (branding.secondaryColor) {
                    document.documentElement.style.setProperty('--brand-secondary', branding.secondaryColor);
                }
            } catch (e) {
                console.warn('Could not load branding:', e);
            }
        }
        
        // Load branding on page load
        document.addEventListener('DOMContentLoaded', loadBranding);
        
        let API_URL = window.location.origin;
        // Ensure HTTPS in production - CRITICAL FIX
        if (window.location.protocol === 'https:') {
            API_URL = API_URL.replace('http://', 'https://');
        }
        // Double check - force HTTPS if on render.com
        if (API_URL.includes('onrender.com') && !API_URL.startsWith('https://')) {
            API_URL = 'https://' + API_URL.replace('http://', '').replace('https://', '');
        }
        console.log('API_URL:', API_URL);
        let AUTH_TOKEN = '';
        let currentClient = null;
        let allBlogs = [];
        let allSocial = [];
        let isFixingAdmin = false;  // Prevent infinite loops

        // ==========================================
        // GLOBAL ERROR HANDLER
        // ==========================================
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', message, source, lineno);
            // Don't show toast for every error, just log it
            return false;
        };
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // Prevent default handling
            event.preventDefault();
        });

        // ==========================================
        // GLOBAL KEYBOARD SHORTCUTS
        // ==========================================
        document.addEventListener('keydown', function(e) {
            // ESC key closes all modals
            if (e.key === 'Escape') {
                // Close blog modal
                const blogModal = document.getElementById('blogModal');
                if (blogModal && !blogModal.classList.contains('hidden')) {
                    closeBlogModal();
                    return;
                }
                // Close edit client modal
                const editModal = document.getElementById('editClientModal');
                if (editModal && !editModal.classList.contains('hidden')) {
                    closeEditClient();
                    return;
                }
                // Close schedule modal
                const scheduleModal = document.getElementById('scheduleModal');
                if (scheduleModal && !scheduleModal.classList.contains('hidden')) {
                    closeScheduleModal();
                    return;
                }
                // Close OAuth modal
                const oauthModal = document.getElementById('oauth-modal-overlay');
                if (oauthModal && !oauthModal.classList.contains('hidden')) {
                    closeOAuthModal();
                    return;
                }
            }
        });

        // ==========================================
        // GLOBAL FETCH INTERCEPTOR - AUTO-FIX 403s
        // ==========================================
        
        // Store original fetch
        const originalFetch = window.fetch;
        
        // Override global fetch to intercept 403s
        window.fetch = async function(url, options = {}) {
            // Only intercept API calls
            const isApiCall = typeof url === 'string' && url.includes('/api/');
            
            // Make the original request
            const response = await originalFetch(url, options);
            
            // If 403 on API call, try auto-fix
            if (response.status === 403 && isApiCall && !isFixingAdmin && AUTH_TOKEN) {
                // Don't retry auth endpoints
                if (url.includes('/api/auth/')) {
                    return response;
                }
                
                console.log('üîß 403 detected on:', url, '- attempting auto-fix...');
                isFixingAdmin = true;
                
                // Show permission alert after multiple 403s
                if (typeof showPermissionAlert === 'function') {
                    showPermissionAlert();
                }
                
                try {
                    // Use nuclear option - make-me-admin
                    const fixResult = await originalFetch(`${API_URL}/api/auth/make-me-admin`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${AUTH_TOKEN}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (fixResult.ok) {
                        const fixData = await fixResult.json();
                        if (fixData.success) {
                            console.log('‚úÖ Admin role fixed! Retrying request...');
                            if (typeof showToast === 'function') {
                                showToast('Permissions restored!', 'success');
                            }
                            // Hide alert
                            document.getElementById('permissionAlert')?.classList.add('hidden');
                            
                            // Retry the original request
                            isFixingAdmin = false;
                            return originalFetch(url, options);
                        }
                    }
                } catch (e) {
                    console.error('Auto-fix failed:', e);
                }
                
                isFixingAdmin = false;
            }
            
            return response;
        };

        // ==========================================
        // AUTH
        // ==========================================
        
        // Check if bootstrap is needed on page load
        (async function checkBootstrap() {
            try {
                const res = await fetch(`${API_URL}/api/auth/health`);
                const health = await res.json();
                
                if (!health.admin_exists) {
                    // Show bootstrap UI
                    showBootstrapUI();
                }
            } catch (e) {
                console.log('Health check failed:', e);
            }
        })();
        
        function showBootstrapUI() {
            const authContent = document.querySelector('#authModal .relative.bg-white');
            if (authContent) {
                authContent.innerHTML = `
                    <div class="p-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-cog text-2xl text-white"></i>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-800">System Setup</h1>
                            <p class="text-gray-500 mt-2">Create your admin account</p>
                        </div>
                        
                        <div id="bootstrapError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm"></div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="bootstrapEmail" value="admin@karma.marketing"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="bootstrapPassword" autocomplete="new-password" placeholder="Min 8 characters"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                                <input type="password" id="bootstrapConfirm" autocomplete="new-password"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <button onclick="doBootstrap()" id="bootstrapBtn" 
                                class="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl font-semibold hover:opacity-90">
                                Create Admin Account
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        async function doBootstrap() {
            const email = document.getElementById('bootstrapEmail').value;
            const password = document.getElementById('bootstrapPassword').value;
            const confirm = document.getElementById('bootstrapConfirm').value;
            const errorEl = document.getElementById('bootstrapError');
            const btn = document.getElementById('bootstrapBtn');
            
            if (!email || !password) {
                errorEl.textContent = 'Email and password required';
                errorEl.classList.remove('hidden');
                return;
            }
            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }
            if (password.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters';
                errorEl.classList.remove('hidden');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                const res = await fetch(`${API_URL}/api/auth/bootstrap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name: 'Admin' })
                });
                const data = await res.json();
                
                if (res.ok && data.token) {
                    AUTH_TOKEN = data.token;
                    localStorage.setItem('mcp_user_email', email);  // Save for permission fixes
                    showToast('Admin created! Email: ' + email, 'success');
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadClients();
                } else {
                    errorEl.textContent = data.error || 'Setup failed';
                    errorEl.classList.remove('hidden');
                    btn.textContent = 'Create Admin Account';
                    btn.disabled = false;
                }
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.classList.remove('hidden');
                btn.textContent = 'Create Admin Account';
                btn.disabled = false;
            }
        }
        
        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('authError');

            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || `Login failed: ${res.status}`);
                    } catch {
                        throw new Error(`Server error: ${res.status}`);
                    }
                }
                
                const data = await res.json();

                if (data.token) {
                    AUTH_TOKEN = data.token;
                    localStorage.setItem('mcp_user_email', email);  // Save for permission fixes
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadClients();
                } else {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = e.message || 'Connection failed';
                errorEl.classList.remove('hidden');
            }
        }

        // ==========================================
        // DATA LOADING
        // ==========================================
        async function loadClients() {
            try {
                const res = await fetch(`${API_URL}/api/clients/`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                // AUTO-FIX 403 ERRORS
                if (res.status === 403) {
                    console.log('403 detected - attempting auto-fix...');
                    const fixResult = await autoFixAdmin();
                    if (fixResult) {
                        // Retry after fix
                        return loadClients();
                    }
                    throw new Error('Access denied. Please contact admin.');
                }
                
                if (!res.ok) {
                    throw new Error(`Failed to load clients: ${res.status}`);
                }
                const data = await res.json();
                const clients = data.clients || [];
                
                // Sort clients alphabetically by business_name
                clients.sort((a, b) => (a.business_name || '').localeCompare(b.business_name || ''));

                const selector = document.getElementById('clientSelector');
                selector.innerHTML = '<option value="">Select Client</option>';
                clients.forEach(c => {
                    selector.innerHTML += `<option value="${c.id}">${c.business_name}</option>`;
                });

                if (clients.length > 0) {
                    selector.value = clients[0].id;
                    loadClient(clients[0].id);
                }
            } catch (e) {
                console.error('Failed to load clients:', e);
            }
        }
        
        // Auto-fix admin role when 403 occurs
        async function autoFixAdmin() {
            try {
                console.log('Calling fix-admin endpoint...');
                const res = await fetch(`${API_URL}/api/auth/fix-admin`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await res.json();
                
                if (res.ok && data.success) {
                    console.log('Admin role fixed:', data);
                    showToast('Admin access restored!', 'success');
                    return true;
                } else {
                    console.warn('Fix-admin failed:', data);
                    return false;
                }
            } catch (e) {
                console.error('Auto-fix error:', e);
                return false;
            }
        }

        async function loadClient(clientId) {
            if (!clientId) return;

            try {
                // Load client details
                const clientRes = await fetch(`${API_URL}/api/clients/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (!clientRes.ok) {
                    const errorText = await clientRes.text();
                    console.error('Client load error:', clientRes.status, errorText);
                    
                    // Check for token expiry
                    if (clientRes.status === 401 || errorText.includes('expired')) {
                        showToast('Session expired. Please log in again.', 'error');
                        setTimeout(() => window.location.href = '/admin', 2000);
                        return;
                    }
                    
                    throw new Error(`Failed to load client: ${clientRes.status}`);
                }
                currentClient = await clientRes.json();
                
                // Ensure arrays are properly parsed
                if (currentClient.primary_keywords && typeof currentClient.primary_keywords === 'string') {
                    currentClient.primary_keywords = currentClient.primary_keywords.split(',').map(k => k.trim()).filter(k => k);
                }
                if (currentClient.secondary_keywords && typeof currentClient.secondary_keywords === 'string') {
                    currentClient.secondary_keywords = currentClient.secondary_keywords.split(',').map(k => k.trim()).filter(k => k);
                }
                if (currentClient.service_areas && typeof currentClient.service_areas === 'string') {
                    currentClient.service_areas = currentClient.service_areas.split(',').map(k => k.trim()).filter(k => k);
                }
                if (currentClient.competitors && typeof currentClient.competitors === 'string') {
                    currentClient.competitors = currentClient.competitors.split(',').map(k => k.trim()).filter(k => k);
                }
                if (currentClient.unique_selling_points && typeof currentClient.unique_selling_points === 'string') {
                    // USPs might be a long text string - wrap in array
                    currentClient.unique_selling_points = [currentClient.unique_selling_points];
                }

                // Update header
                document.getElementById('clientName').textContent = currentClient.business_name || 'Client';
                document.getElementById('clientMeta').textContent = `${currentClient.industry || ''} ‚Ä¢ ${currentClient.geo || ''}`;

                // Load blogs
                const blogsRes = await fetch(`${API_URL}/api/content/client/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (blogsRes.ok) {
                    const blogsJson = await blogsRes.json();
                    allBlogs = blogsJson.content || blogsJson.blogs || [];
                } else {
                    allBlogs = [];
                }

                // Load social
                const socialRes = await fetch(`${API_URL}/api/social/client/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (socialRes.ok) {
                    const socialData = await socialRes.json();
                    allSocial = socialData.posts || [];
                } else {
                    allSocial = [];
                }

                // Update stats
                updateStats();
                renderBlogs();
                renderSocial();
                renderSEO();
                
                // Load overview data (with error handling)
                try { loadOverviewData(); } catch(e) { console.error('loadOverviewData error:', e); }
                
                // Load image library (with error handling)
                try { loadImageLibrary(); } catch(e) { console.error('loadImageLibrary error:', e); }
                
                // Load integrations settings (with error handling)
                try { loadIntegrations(); } catch(e) { console.error('loadIntegrations error:', e); }
                
                // Load system status (with error handling)
                try { loadSystemStatus(); } catch(e) { console.error('loadSystemStatus error:', e); }
                
                // Load social connections (with error handling)
                try { loadSocialConnections(); } catch(e) { console.error('loadSocialConnections error:', e); }

            } catch (e) {
                console.error('Failed to load client:', e);
                showToast('Failed to load client data', 'error');
            }
        }

        function updateStats() {
            document.getElementById('statBlogs').textContent = allBlogs.length;
            document.getElementById('statSocial').textContent = allSocial.length;
            document.getElementById('statKeywords').textContent = 
                (currentClient?.primary_keywords?.length || 0) + (currentClient?.secondary_keywords?.length || 0);
            document.getElementById('statCompetitors').textContent = currentClient?.competitors?.length || 0;
        }

        function refreshData() {
            const clientId = document.getElementById('clientSelector').value;
            if (clientId) loadClient(clientId);
        }

        // ==========================================
        // CLIENT MANAGEMENT (Edit/Delete)
        // ==========================================
        function showEditClient() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            // Populate form fields
            document.getElementById('editBusinessName').value = currentClient.business_name || '';
            document.getElementById('editIndustry').value = currentClient.industry || '';
            document.getElementById('editGeo').value = currentClient.geo || '';
            document.getElementById('editWebsite').value = currentClient.website_url || '';
            document.getElementById('editPhone').value = currentClient.phone || '';
            document.getElementById('editEmail').value = currentClient.email || '';
            document.getElementById('editTone').value = currentClient.tone || 'professional';
            
            // Helper to safely convert to comma-separated string (handles both arrays and strings)
            const toCommaString = (val) => {
                if (!val) return '';
                if (Array.isArray(val)) return val.join(', ');
                if (typeof val === 'string') return val;
                return String(val);
            };
            
            document.getElementById('editPrimaryKeywords').value = toCommaString(currentClient.primary_keywords);
            document.getElementById('editSecondaryKeywords').value = toCommaString(currentClient.secondary_keywords);
            document.getElementById('editServiceAreas').value = toCommaString(currentClient.service_areas);
            document.getElementById('editUSPs').value = toCommaString(currentClient.unique_selling_points);
            document.getElementById('editCompetitors').value = toCommaString(currentClient.competitors);
            
            // WordPress fields
            document.getElementById('editWordpressUrl').value = currentClient.wordpress_url || '';
            document.getElementById('editWordpressUser').value = currentClient.wordpress_user || '';
            document.getElementById('editWordpressPassword').value = currentClient.wordpress_app_password || '';
            document.getElementById('wpTestResult').textContent = '';
            document.getElementById('wpTestResult').className = 'text-sm';
            
            document.getElementById('editClientModal').classList.remove('hidden');
        }
        
        function closeEditClient() {
            document.getElementById('editClientModal').classList.add('hidden');
        }
        
        async function testWordPressConnection() {
            const url = document.getElementById('editWordpressUrl').value.trim();
            const user = document.getElementById('editWordpressUser').value.trim();
            const pass = document.getElementById('editWordpressPassword').value.trim();
            
            if (!url || !user || !pass) {
                document.getElementById('wpTestResult').textContent = '‚ö†Ô∏è Fill in all WordPress fields first';
                document.getElementById('wpTestResult').className = 'text-sm text-amber-400';
                return;
            }
            
            document.getElementById('wpTestResult').textContent = 'üîÑ Testing...';
            document.getElementById('wpTestResult').className = 'text-sm text-blue-400';
            
            try {
                const response = await fetch(`${API_URL}/api/content/wordpress/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        wordpress_url: url,
                        wordpress_user: user,
                        wordpress_app_password: pass
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('wpTestResult').textContent = `‚úÖ Connected as ${result.user || 'user'}`;
                    document.getElementById('wpTestResult').className = 'text-sm text-green-400';
                } else {
                    document.getElementById('wpTestResult').textContent = `‚ùå ${result.message}`;
                    document.getElementById('wpTestResult').className = 'text-sm text-red-400';
                }
            } catch (error) {
                document.getElementById('wpTestResult').textContent = `‚ùå ${error.message}`;
                document.getElementById('wpTestResult').className = 'text-sm text-red-400';
            }
        }
        
        async function saveClientEdits() {
            if (!currentClient) return;
            
            const businessName = document.getElementById('editBusinessName').value.trim();
            if (!businessName) {
                showToast('Business name is required', 'error');
                return;
            }
            
            const updates = {
                business_name: businessName,
                industry: document.getElementById('editIndustry').value.trim(),
                geo: document.getElementById('editGeo').value.trim(),
                website_url: document.getElementById('editWebsite').value.trim(),
                phone: document.getElementById('editPhone').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                tone: document.getElementById('editTone').value,
                primary_keywords: document.getElementById('editPrimaryKeywords').value.split(',').map(k => k.trim()).filter(k => k),
                secondary_keywords: document.getElementById('editSecondaryKeywords').value.split(',').map(k => k.trim()).filter(k => k),
                service_areas: document.getElementById('editServiceAreas').value.split(',').map(s => s.trim()).filter(s => s),
                unique_selling_points: document.getElementById('editUSPs').value.split(',').map(u => u.trim()).filter(u => u),
                competitors: document.getElementById('editCompetitors').value.split(',').map(c => c.trim()).filter(c => c),
                // WordPress fields
                wordpress_url: document.getElementById('editWordpressUrl').value.trim(),
                wordpress_user: document.getElementById('editWordpressUser').value.trim(),
                wordpress_app_password: document.getElementById('editWordpressPassword').value.trim()
            };
            
            try {
                const response = await fetch(`${API_URL}/api/clients/${currentClient.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(updates)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update client');
                }
                
                const result = await response.json();
                currentClient = result.client;
                
                // Update UI
                document.getElementById('clientName').textContent = currentClient.business_name || 'Client';
                document.getElementById('clientMeta').textContent = `${currentClient.industry || ''} ‚Ä¢ ${currentClient.geo || ''}`;
                
                // Update selector option text
                const selector = document.getElementById('clientSelector');
                const option = selector.querySelector(`option[value="${currentClient.id}"]`);
                if (option) {
                    option.textContent = currentClient.business_name;
                }
                
                closeEditClient();
                showToast('Client updated successfully!', 'success');
                
                // Refresh data and SEO panel
                loadClient(currentClient.id);
                renderSEO();
                
            } catch (error) {
                console.error('Failed to save client:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        function confirmDeleteClient() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const blogCount = allBlogs.length;
            const socialCount = allSocial.length;
            
            let warning = `Are you sure you want to delete "${currentClient.business_name}"?\n\n`;
            warning += `This will permanently delete:\n`;
            warning += `‚Ä¢ ${blogCount} blog posts\n`;
            warning += `‚Ä¢ ${socialCount} social posts\n`;
            warning += `‚Ä¢ All keywords and settings\n\n`;
            warning += `This action cannot be undone!`;
            
            if (confirm(warning)) {
                // Double confirm for safety
                const confirmText = prompt(`Type "DELETE" to confirm deletion of ${currentClient.business_name}:`);
                if (confirmText === 'DELETE') {
                    deleteClient();
                } else if (confirmText !== null) {
                    alert('Deletion cancelled. You must type DELETE exactly to confirm.');
                }
            }
        }
        
        async function deleteClient() {
            if (!currentClient) return;
            
            try {
                // Use hard delete to permanently remove client and content
                const response = await fetch(`${API_URL}/api/clients/${currentClient.id}?hard=true`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete client');
                }
                
                showToast(`"${currentClient.business_name}" has been deleted`, 'success');
                
                // Reset state
                currentClient = null;
                allBlogs = [];
                allSocial = [];
                
                // Reset UI
                document.getElementById('clientName').textContent = 'Select Client';
                document.getElementById('clientMeta').textContent = 'Content Dashboard';
                document.getElementById('clientSelector').value = '';
                updateStats();
                renderBlogs();
                renderSocial();
                
                // Reload client list
                await loadClients();
                
            } catch (error) {
                console.error('Failed to delete client:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // ==========================================
        // TABS
        // ==========================================
        function showTab(tab) {
            const allTabs = ['overview', 'generate', 'blogs', 'social', 'seo', 'calendar', 'reports', 'rankings', 'competitors', 'settings', 'chatbot', 'leads', 'reviews', 'calls', 'pages'];
            
            allTabs.forEach(t => {
                const panel = document.getElementById(`panel-${t}`);
                const tabBtn = document.getElementById(`tab-${t}`);
                if (panel) panel.classList.add('hidden');
                if (tabBtn) {
                    tabBtn.classList.remove('tab-active');
                    if (t !== 'generate') {
                        tabBtn.classList.add('glass', 'text-gray-400');
                    }
                }
            });
            
            const activePanel = document.getElementById(`panel-${tab}`);
            const activeTab = document.getElementById(`tab-${tab}`);
            if (activePanel) activePanel.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.add('tab-active');
                if (tab !== 'generate') {
                    activeTab.classList.remove('glass', 'text-gray-400');
                }
            }
            
            // Load overview data when overview tab is shown
            if (tab === 'overview') {
                loadOverviewData();
            }
            
            // Populate keyword dropdown when generate tab is shown
            if (tab === 'generate') {
                populateKeywordDropdown();
            }
            
            // Render calendar when calendar tab is shown
            if (tab === 'calendar') {
                renderCalendar();
            }
            
            // Update report stats when reports tab is shown
            if (tab === 'reports') {
                updateReportStats();
                refreshGA4Data();
            }
            
            // Load chatbot config when chatbot tab is shown
            if (tab === 'chatbot') {
                loadChatbotConfig();
            }
            
            // Load rankings when rankings tab is shown
            if (tab === 'rankings') {
                loadRankingHistory();
            }
            
            // Load competitor dashboard when competitors tab is shown
            if (tab === 'competitors') {
                refreshCompetitorDashboard();
            }
            
            // Load notification settings when settings tab is shown
            if (tab === 'settings') {
                // Show Integrations section first (most important)
                showSettingsSection('integrations');
                loadNotificationPrefs();
                loadNotificationHistory();
                setTimeout(updateDigestPreview, 100);
            }
            
            // Load leads when leads tab is shown
            if (tab === 'leads') {
                loadLeads();
            }
            
            // Load reviews when reviews tab is shown
            if (tab === 'reviews') {
                loadReviews();
            }
            
            // Load calls when calls tab is shown
            if (tab === 'calls') {
                loadCalls();
            }
            
            // Load pages when pages tab is shown
            if (tab === 'pages') {
                loadPages();
            }
            
            // Load blogs when blogs tab is shown
            if (tab === 'blogs') {
                loadBlogs();
            }
            
            // Load social when social tab is shown
            if (tab === 'social') {
                loadSocialPosts();
                loadSocialConnections();
            }
            
            // Load SEO data when SEO tab is shown
            if (tab === 'seo') {
                loadSEOData();
            }
        }
        
        // ==========================================
        // OVERVIEW DASHBOARD
        // ==========================================
        
        async function loadOverviewData() {
            if (!currentClient) return;
            
            try {
                // Load health score
                loadHealthScore();
                
                // Load leads and calls stats
                loadOverviewStats();
                
                // Load this week's wins
                loadWins();
                
                // Load pending approvals
                loadPendingApprovals();
                
                // Load call intelligence
                loadCallIntelligence();
                
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }
        
        async function loadHealthScore() {
            try {
                // Try the correct health score endpoint
                const response = await fetch(`${API_URL}/api/client/health-score/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                let score = 0;
                if (response.ok) {
                    const data = await response.json();
                    score = data.score || data.health_score || 0;
                } else {
                    // Try analytics health endpoint as fallback
                    const altResponse = await fetch(`${API_URL}/api/analytics/health/${currentClient.id}`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    if (altResponse.ok) {
                        const altData = await altResponse.json();
                        score = altData.score || altData.health_score || 0;
                    } else {
                        // Calculate fallback score from available data
                        score = calculateFallbackHealthScore();
                    }
                }
                
                // Animate the health score circle
                const circle = document.getElementById('health-circle');
                if (circle) {
                    const circumference = 2 * Math.PI * 56; // r=56
                    const offset = circumference - (score / 100) * circumference;
                    
                    setTimeout(() => {
                        circle.style.strokeDashoffset = offset;
                    }, 100);
                }
                
                // Animate the number
                animateNumber('health-score-value', 0, score, 2000);
                
                // Set grade
                const gradeEl = document.getElementById('health-grade');
                if (gradeEl) {
                    if (score >= 90) {
                        gradeEl.textContent = 'A+ Excellent!';
                        gradeEl.className = 'text-emerald-400 font-bold text-lg';
                    } else if (score >= 80) {
                        gradeEl.textContent = 'A Grade';
                        gradeEl.className = 'text-emerald-400 font-bold text-lg';
                    } else if (score >= 70) {
                        gradeEl.textContent = 'B Grade';
                        gradeEl.className = 'text-blue-400 font-bold text-lg';
                    } else if (score >= 60) {
                        gradeEl.textContent = 'C Grade';
                        gradeEl.className = 'text-yellow-400 font-bold text-lg';
                    } else {
                        gradeEl.textContent = 'Needs Work';
                        gradeEl.className = 'text-orange-400 font-bold text-lg';
                    }
                }
            } catch (error) {
                console.error('Error loading health score:', error);
                // Show fallback score
                const fallbackScore = calculateFallbackHealthScore();
                animateNumber('health-score-value', 0, fallbackScore, 2000);
                const gradeEl = document.getElementById('health-grade');
                if (gradeEl) {
                    gradeEl.textContent = fallbackScore >= 70 ? 'Good' : 'Getting Started';
                    gradeEl.className = 'text-blue-400 font-bold text-lg';
                }
            }
        }
        
        function calculateFallbackHealthScore() {
            // Calculate a basic score from available data
            let score = 50; // Base score
            
            // Add points for content
            const publishedBlogs = allBlogs.filter(b => b.status === 'published').length;
            score += Math.min(publishedBlogs * 5, 25); // Up to 25 points
            
            // Add points for having keywords
            const keywordCount = (currentClient?.primary_keywords?.length || 0) + (currentClient?.secondary_keywords?.length || 0);
            score += Math.min(keywordCount * 2, 15); // Up to 15 points
            
            // Add points for social posts
            const socialCount = allSocial?.length || 0;
            score += Math.min(socialCount * 2, 10); // Up to 10 points
            
            return Math.min(score, 100);
        }
        
        async function loadOverviewStats() {
            // Default values
            let leads = 0;
            let calls = 0;
            let answerRate = 0;
            let contentCount = 0;
            let leadsChangeVal = 0;
            
            try {
                // Try to get analytics overview
                const response = await fetch(`${API_URL}/api/analytics/overview/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    leads = data.leads || data.new_leads || 0;
                    calls = data.calls || data.phone_calls || 0;
                    answerRate = data.answer_rate || 0;
                    contentCount = data.content_count || data.blogs_published || 0;
                    leadsChangeVal = data.leads_change || data.lead_growth || 0;
                }
            } catch (error) {
                console.error('Error loading overview stats:', error);
            }
            
            // Fallback: fetch leads count directly if not returned from analytics
            if (leads === 0) {
                try {
                    const leadsResponse = await fetch(`${API_URL}/api/leads?client_id=${currentClient.id}`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    if (leadsResponse.ok) {
                        const leadsData = await leadsResponse.json();
                        // Count leads from this month
                        const now = new Date();
                        const thisMonth = now.getMonth();
                        const thisYear = now.getFullYear();
                        const allLeads = leadsData.leads || [];
                        leads = allLeads.filter(l => {
                            const leadDate = new Date(l.created_at);
                            return leadDate.getMonth() === thisMonth && leadDate.getFullYear() === thisYear;
                        }).length;
                        // If no leads this month, show total
                        if (leads === 0 && allLeads.length > 0) {
                            leads = allLeads.length;
                        }
                    }
                } catch (e) {
                    console.error('Error fetching leads:', e);
                }
            }
            
            // Use fallbacks from local data if API didn't return values
            if (contentCount === 0) {
                contentCount = allBlogs?.filter(b => b.status === 'published').length || 0;
            }
            
            // Animate all stats with either API data or fallbacks
            animateNumber('overview-leads', 0, leads, 1500);
            animateNumber('overview-calls', 0, calls, 1500);
            animateNumber('overview-content', 0, contentCount, 1500);
            
            // Show leads change
            const leadsChange = document.getElementById('leads-change');
            if (leadsChange) {
                if (leadsChangeVal > 0) {
                    leadsChange.innerHTML = `<span class="text-emerald-400">‚Üë ${leadsChangeVal}%</span> vs last month`;
                } else if (leadsChangeVal < 0) {
                    leadsChange.innerHTML = `<span class="text-red-400">‚Üì ${Math.abs(leadsChangeVal)}%</span> vs last month`;
                } else {
                    leadsChange.innerHTML = `<span class="text-gray-400">This month</span>`;
                }
            }
            
            // Animate answer rate bar
            const answerRateBar = document.getElementById('answer-rate-bar');
            const answerRateText = document.getElementById('answer-rate');
            if (answerRateBar && answerRateText) {
                setTimeout(() => {
                    answerRateBar.style.width = (answerRate || 0) + '%';
                    answerRateText.textContent = answerRate || '--';
                }, 500);
            }
        }
        
        async function loadWins() {
            const winsList = document.getElementById('wins-list');
            if (!winsList) return;
            
            let wins = [];
            
            try {
                // Try to get activity feed for wins (correct endpoint)
                const response = await fetch(`${API_URL}/api/client/activity/${currentClient.id}?limit=5`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    wins = (data.activities || data.items || []).slice(0, 5);
                } else {
                    // Try wins-specific endpoint
                    const winsResponse = await fetch(`${API_URL}/api/client/wins/${currentClient.id}`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    if (winsResponse.ok) {
                        const winsData = await winsResponse.json();
                        wins = (winsData.wins || winsData.items || []).slice(0, 5);
                    }
                }
            } catch (error) {
                console.error('Error loading wins:', error);
            }
            
            // If no activities from API, create wins from available data
            if (wins.length === 0) {
                const published = allBlogs?.filter(b => b.status === 'published').length || 0;
                const scheduled = allBlogs?.filter(b => b.status === 'scheduled').length || 0;
                const socialCount = allSocial?.length || 0;
                const keywordCount = (currentClient?.primary_keywords?.length || 0) + (currentClient?.secondary_keywords?.length || 0);
                
                if (published > 0) {
                    wins.push({ message: `${published} blog post${published > 1 ? 's' : ''} published` });
                }
                if (scheduled > 0) {
                    wins.push({ message: `${scheduled} post${scheduled > 1 ? 's' : ''} scheduled for publishing` });
                }
                if (socialCount > 0) {
                    wins.push({ message: `${socialCount} social post${socialCount > 1 ? 's' : ''} created` });
                }
                if (keywordCount > 0) {
                    wins.push({ message: `Tracking ${keywordCount} keyword${keywordCount > 1 ? 's' : ''}` });
                }
                if (currentClient?.competitors?.length > 0) {
                    wins.push({ message: `Monitoring ${currentClient.competitors.length} competitor${currentClient.competitors.length > 1 ? 's' : ''}` });
                }
            }
            
            // Render wins
            if (wins.length > 0) {
                winsList.innerHTML = wins.map((win, i) => `
                    <div class="flex items-center gap-3 text-sm win-item" style="animation-delay: ${i * 0.1}s">
                        <span class="text-emerald-400">‚úì</span>
                        <span class="text-gray-300">${win.message || win.description || win.title}</span>
                    </div>
                `).join('');
            } else {
                winsList.innerHTML = `
                    <div class="flex items-center gap-3 text-sm text-gray-500">
                        <span>üí°</span>
                        <span>Generate your first blog post to see wins here!</span>
                    </div>
                `;
            }
        }
        
        async function loadPendingApprovals() {
            const pendingList = document.getElementById('pending-list');
            const pendingCount = document.getElementById('pending-count');
            
            if (!pendingList || !pendingCount) return;
            
            try {
                // Get blogs that need approval (draft status)
                const pending = allBlogs?.filter(b => b.status === 'draft' || b.status === 'pending') || [];
                
                pendingCount.textContent = pending.length;
                
                if (pending.length > 0) {
                    pendingList.innerHTML = pending.slice(0, 3).map(blog => `
                        <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700/50">
                            <div class="font-medium text-white mb-1">${blog.title || blog.keyword || 'Untitled'}</div>
                            <div class="text-sm text-gray-400 mb-3">${blog.word_count || '~1,500'} words ‚Ä¢ SEO Score: ${blog.seo_score || '--'}</div>
                            <div class="flex gap-2">
                                <button onclick="quickApprove('${blog.id}')" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-2 rounded-lg font-medium transition text-sm">
                                    ‚úì Approve
                                </button>
                                <button onclick="viewBlog('${blog.id}')" class="px-4 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-medium transition text-sm">
                                    View
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    pendingList.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-emerald-400 text-2xl mb-2">‚úì</div>
                            <div class="text-gray-400 text-sm">All caught up! No content pending approval.</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading pending approvals:', error);
                pendingList.innerHTML = `
                    <div class="text-center py-4 text-gray-500 text-sm">
                        Unable to load pending approvals
                    </div>
                `;
            }
        }
        
        async function quickApprove(blogId) {
            try {
                const response = await fetch(`${API_URL}/api/content/blog/${blogId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'approved' })
                });
                
                if (response.ok) {
                    // Refresh the overview
                    loadOverviewData();
                    loadBlogs();
                    showToast('Content approved!', 'success');
                }
            } catch (error) {
                console.error('Error approving blog:', error);
                showToast('Error approving content', 'error');
            }
        }
        
        function viewBlog(blogId) {
            // Switch to blogs tab and highlight the blog
            showTab('blogs');
            setTimeout(() => {
                const blogCard = document.querySelector(`[data-blog-id="${blogId}"]`);
                if (blogCard) {
                    blogCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    blogCard.classList.add('ring-2', 'ring-purple-500');
                    setTimeout(() => blogCard.classList.remove('ring-2', 'ring-purple-500'), 3000);
                }
            }, 100);
        }
        
        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50 slide-up`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ==========================================
        // PERMISSION FIX FUNCTIONS
        // ==========================================
        
        let permission403Count = 0;
        
        function showPermissionAlert() {
            permission403Count++;
            // Show alert if multiple 403s detected
            if (permission403Count >= 2) {
                document.getElementById('permissionAlert')?.classList.remove('hidden');
            }
        }
        
        async function manualFixPermissions() {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Fixing...';
            
            try {
                // Use the nuclear option - make-me-admin
                console.log('Trying make-me-admin...');
                let response = await fetch(`${API_URL}/api/auth/make-me-admin`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                let data = await response.json();
                
                if (data.success) {
                    showToast('Permissions fixed! Reloading...', 'success');
                    document.getElementById('permissionAlert')?.classList.add('hidden');
                    permission403Count = 0;
                    setTimeout(() => location.reload(), 1000);
                    return;
                }
                
                // If that failed, show error with debug info
                console.log('Fix failed:', data);
                
                // Try to get debug info
                const debugResponse = await fetch(`${API_URL}/api/auth/debug-users`);
                const debugData = await debugResponse.json();
                console.log('User debug:', debugData);
                
                showToast('Fix failed: ' + (data.error || 'Unknown error'), 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wrench mr-2"></i>Fix Permissions';
                
            } catch (error) {
                console.error('Fix error:', error);
                showToast('Error: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wrench mr-2"></i>Fix Permissions';
            }
        }
        
        function handleFixSuccess() {
            showToast('Permissions fixed! Reloading...', 'success');
            document.getElementById('permissionAlert')?.classList.add('hidden');
            permission403Count = 0;
            setTimeout(() => location.reload(), 1000);
        }
        
        // ==========================================
        // CALL INTELLIGENCE
        // ==========================================
        
        let callSimulationInterval = null;
        
        function clearCallIntelligenceUI() {
            // Clear all call intelligence UI elements when switching clients
            // This prevents data from one client showing on another client's dashboard
            
            // Clear questions
            const questionsEl = document.getElementById('extracted-questions');
            if (questionsEl) questionsEl.innerHTML = '<div class="text-xs text-gray-400">Loading...</div>';
            
            // Clear keywords
            const keywordsEl = document.getElementById('extracted-keywords');
            if (keywordsEl) keywordsEl.innerHTML = '<span class="text-xs text-gray-400">Loading...</span>';
            
            // Clear pain points
            const painEl = document.getElementById('extracted-pain');
            if (painEl) painEl.innerHTML = '<div class="text-xs text-gray-400">Loading...</div>';
            
            // Clear services/opportunities
            const opportunitiesEl = document.getElementById('content-opportunities');
            if (opportunitiesEl) opportunitiesEl.innerHTML = '<div class="text-xs text-gray-400">Loading...</div>';
            
            // Clear calls count
            const callsToday = document.getElementById('calls-today');
            if (callsToday) callsToday.textContent = '0 calls analyzed';
            
            // Clear phone mockup
            const callerName = document.getElementById('caller-name');
            const callerLocation = document.getElementById('caller-location');
            const callTimer = document.getElementById('call-timer');
            if (callerName) callerName.textContent = 'No calls';
            if (callerLocation) callerLocation.textContent = '';
            if (callTimer) callTimer.textContent = '00:00';
            
            // Stop any running simulation
            if (callSimulationInterval) {
                clearInterval(callSimulationInterval);
                callSimulationInterval = null;
            }
            
            console.log('Cleared call intelligence UI');
        }
        
        async function loadCallIntelligence() {
            console.log('loadCallIntelligence called for client:', currentClient?.id, currentClient?.business_name);
            
            // IMPORTANT: Clear previous client's data before fetching new data
            clearCallIntelligenceUI();
            
            try {
                // First try the full intelligence report which includes AI analysis
                const reportResponse = await fetch(`${API_URL}/api/intelligence/report/${currentClient.id}?days=30&_v=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                console.log('Intelligence API response status:', reportResponse.status);
                
                if (reportResponse.ok) {
                    const report = await reportResponse.json();
                    console.log('Full intelligence report for', currentClient.business_name, ':', JSON.stringify(report, null, 2));
                    
                    // Update calls count
                    const callsToday = document.getElementById('calls-today');
                    if (callsToday) {
                        const callCount = report.call_count || report.total_calls || 0;
                        callsToday.textContent = `${callCount} calls analyzed`;
                    }
                    
                    // Check if we have REAL transcript-based AI insights (must have questions from calls)
                    // Keywords alone from chatbot shouldn't count - we need actual call transcript analysis
                    const hasTranscriptInsights = report.calls_with_transcripts > 0 && 
                                       (report.combined_insights?.top_questions?.length > 0);
                    
                    console.log('Intelligence report:', report);
                    console.log('Calls with transcripts:', report.calls_with_transcripts);
                    console.log('Has transcript insights:', hasTranscriptInsights);
                    console.log('Has metadata insights:', !!report.metadata_insights);
                    
                    if (hasTranscriptInsights) {
                        // Update extracted insights from AI analysis
                        console.log('Showing transcript-based insights');
                        const insights = report.combined_insights || {};
                        
                        // Get services from top_services (actual services customers asked about)
                        // top_services format: [{service: 'name', count: n}]
                        let services = [];
                        
                        // First try combined_insights.services_requested (from transcript analysis)
                        if (insights.services_requested && insights.services_requested.length > 0) {
                            services = insights.services_requested.map(s => {
                                if (typeof s === 'string') return s;
                                return s.service || s.name || s;
                            }).filter(s => s && typeof s === 'string' && s.length < 50);
                        }
                        
                        // Fallback to top_services
                        if (services.length === 0 && insights.top_services && insights.top_services.length > 0) {
                            services = insights.top_services.map(s => {
                                if (typeof s === 'string') return s;
                                return s.service || s.name || s;
                            }).filter(s => s && typeof s === 'string' && s.length < 50);
                        }
                        
                        // Only use content_opportunities as LAST resort, and only show service-type ones
                        if (services.length === 0 && report.content_opportunities) {
                            services = report.content_opportunities
                                .filter(o => o.type === 'service_page' || o.service)
                                .map(o => o.service || o.title)
                                .filter(s => s && !s.includes('|') && !s.includes('FAQ') && s.length < 50);
                        }
                        
                        const opportunities = services.slice(0, 6); // Limit to 6
                        
                        updateExtractedUI(
                            (insights.top_questions || []).map(q => {
                                if (typeof q === 'string') return q;
                                return q.question || q.text || JSON.stringify(q);
                            }),
                            (insights.top_keywords || []).map(k => {
                                if (typeof k === 'string') return k;
                                return k.keyword || k.name || JSON.stringify(k);
                            }),
                            (insights.top_pain_points || []).map(p => {
                                if (typeof p === 'string') return p;
                                return p.pain_point || p.text || JSON.stringify(p);
                            }),
                            opportunities
                        );
                    } else if (report.metadata_insights) {
                        // Show metadata-based insights when no transcripts
                        console.log('Showing metadata insights:', report.metadata_insights);
                        showMetadataInsights(report.metadata_insights, report.transcript_note);
                    } else if (report.call_count > 0) {
                        // Fallback: If we have calls but no metadata_insights object, build it from call_count
                        console.log('Building basic stats from call_count');
                        const basicInsights = {
                            call_summary: {
                                total_calls: report.call_count,
                                answered: report.call_count,
                                answer_rate: 100,
                                voicemails: 0,
                                avg_duration_seconds: 60,
                                avg_duration_formatted: '1:00',
                                long_calls: 0,
                                long_call_rate: 0
                            },
                            peak_times: { busiest_hours: [], busiest_days: [] },
                            recommendations: ['Enable CallRail Conversation Intelligence for deeper insights']
                        };
                        showMetadataInsights(basicInsights, 'Basic call statistics');
                    } else {
                        // No insights at all - show helpful message instead of Loading...
                        console.log('No insights available, showing message');
                        showNoInsightsMessage();
                    }
                    
                    // Get recent call for phone mockup
                    const callsResponse = await fetch(`${API_URL}/api/client/calls/${currentClient.id}?limit=1`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    if (callsResponse.ok) {
                        const callsData = await callsResponse.json();
                        if (callsData.calls && callsData.calls.length > 0) {
                            updatePhoneMockup(callsData.calls[0]);
                            return; // Don't start simulation if we have real call
                        }
                    }
                    
                    // Only simulate if no real calls
                    simulateIncomingCall();
                    
                } else {
                    // Fall back to just getting calls
                    const callsResponse = await fetch(`${API_URL}/api/client/calls/${currentClient.id}?limit=10`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    
                    if (callsResponse.ok) {
                        const data = await callsResponse.json();
                        const calls = data.calls || [];
                        
                        const callsToday = document.getElementById('calls-today');
                        if (callsToday) {
                            callsToday.textContent = `${calls.length} calls today`;
                        }
                        
                        if (calls.length > 0) {
                            updatePhoneMockup(calls[0]);
                        } else {
                            loadDemoCallData();
                        }
                    } else {
                        loadDemoCallData();
                    }
                    
                    // Show no insights message when falling back
                    showNoInsightsMessage();
                }
            } catch (error) {
                console.error('Error loading call intelligence:', error);
                loadDemoCallData();
                showNoInsightsMessage();
            }
        }
        
        function showMetadataInsights(metadata, note) {
            // No transcript data available - show clear message in each section
            
            // Questions section - no real questions without transcripts
            const questionsEl = document.getElementById('extracted-questions');
            if (questionsEl) {
                questionsEl.innerHTML = `
                    <div class="text-xs text-gray-500 italic">
                        No call transcripts available
                    </div>
                `;
            }
            
            // Keywords section - no real keywords without transcripts
            const keywordsEl = document.getElementById('extracted-keywords');
            if (keywordsEl) {
                keywordsEl.innerHTML = `
                    <span class="text-xs text-gray-500 italic">
                        No call transcripts available
                    </span>
                `;
            }
            
            // Pain Points section - no real pain points without transcripts
            const painEl = document.getElementById('extracted-pain');
            if (painEl) {
                painEl.innerHTML = `
                    <div class="text-xs text-gray-500 italic">
                        No call transcripts available
                    </div>
                `;
            }
            
            // Services section - no real services without transcripts
            const opportunitiesEl = document.getElementById('content-opportunities');
            if (opportunitiesEl) {
                opportunitiesEl.innerHTML = `
                    <div class="text-xs text-gray-500 italic">
                        No call transcripts available
                    </div>
                `;
            }
        }
        
        function showNoInsightsMessage() {
            // Update UI elements to show no data message instead of Loading...
            console.log('showNoInsightsMessage called');
            
            // Clear questions
            const questionsEl = document.getElementById('extracted-questions');
            if (questionsEl) {
                questionsEl.innerHTML = '<div class="text-xs text-gray-500 italic">No call data available</div>';
            }
            
            // Clear keywords
            const keywordsEl = document.getElementById('extracted-keywords');
            if (keywordsEl) {
                keywordsEl.innerHTML = '<span class="text-xs text-gray-500 italic">No call data available</span>';
            }
            
            // Clear pain points
            const painEl = document.getElementById('extracted-pain');
            if (painEl) {
                painEl.innerHTML = '<div class="text-xs text-gray-500 italic">No call data available</div>';
            }
            
            // Clear services/opportunities
            const opportunitiesEl = document.getElementById('content-opportunities');
            if (opportunitiesEl) {
                opportunitiesEl.innerHTML = '<div class="text-xs text-gray-500 italic">No call data available</div>';
            }
            
            // Update calls count
            const callsToday = document.getElementById('calls-today');
            if (callsToday) {
                callsToday.textContent = '0 calls analyzed';
            }
        }
        
        
        function loadDemoCallData() {
            // Demo data for visualization
            const demoQuestions = [
                "How much does AC repair cost?",
                "Do you offer emergency service?",
                "What brands do you service?",
                "How long until you can come out?"
            ];
            
            const demoKeywords = [
                "AC repair", "emergency", "same day", 
                "cost estimate", "warranty", "maintenance"
            ];
            
            const demoPainPoints = [
                "AC stopped working suddenly",
                "High energy bills",
                "Uneven cooling in rooms"
            ];
            
            const demoOpportunities = [
                "Create blog: 'Emergency AC Repair Guide'",
                "FAQ: 'AC repair cost breakdown'",
                "Service page: 'Same-day AC service'"
            ];
            
            // Update UI with demo data
            updateExtractedUI(demoQuestions, demoKeywords, demoPainPoints, demoOpportunities);
            
            // Start phone simulation
            simulateIncomingCall();
        }
        
        function updatePhoneMockup(call) {
            const callerName = document.getElementById('caller-name');
            const callerLocation = document.getElementById('caller-location');
            const callTimer = document.getElementById('call-timer');
            const callStatus = document.getElementById('call-status-icon');
            
            if (!callerName || !callerLocation || !callTimer || !callStatus) return;
            
            if (call) {
                callerName.textContent = call.caller_name || 'Customer';
                callerLocation.textContent = call.caller_location || currentClient?.geo || 'Local';
                
                // Format duration
                const duration = call.duration || 0;
                const mins = Math.floor(duration / 60);
                const secs = duration % 60;
                callTimer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                callStatus.textContent = '‚úì';
                callStatus.classList.remove('bg-emerald-500');
                callStatus.classList.add('bg-slate-600');
            }
        }
        
        function updateExtractedInsights(calls) {
            // Aggregate insights from all calls
            let allQuestions = [];
            let allKeywords = [];
            let allPainPoints = [];
            let allOpportunities = [];
            
            calls.forEach(call => {
                if (call.questions) allQuestions = allQuestions.concat(call.questions);
                if (call.keywords) allKeywords = allKeywords.concat(call.keywords);
                if (call.pain_points) allPainPoints = allPainPoints.concat(call.pain_points);
                if (call.opportunities) allOpportunities = allOpportunities.concat(call.opportunities);
            });
            
            // Dedupe and limit
            allQuestions = [...new Set(allQuestions)].slice(0, 4);
            allKeywords = [...new Set(allKeywords)].slice(0, 8);
            allPainPoints = [...new Set(allPainPoints)].slice(0, 3);
            allOpportunities = [...new Set(allOpportunities)].slice(0, 3);
            
            updateExtractedUI(allQuestions, allKeywords, allPainPoints, allOpportunities);
        }
        
        function updateExtractedUI(questions, keywords, painPoints, opportunities) {
            // Update questions
            const questionsEl = document.getElementById('extracted-questions');
            if (questionsEl) {
                if (questions.length > 0) {
                    questionsEl.innerHTML = questions.map((q, i) => `
                        <div class="bg-slate-800/50 rounded-lg p-2 text-xs text-gray-300 fade-in" style="animation-delay: ${i * 0.1}s">
                            ${q}
                        </div>
                    `).join('');
                } else {
                    questionsEl.innerHTML = `<div class="text-xs text-gray-500 italic">No questions detected in calls</div>`;
                }
            }
            
            // Update keywords
            const keywordsEl = document.getElementById('extracted-keywords');
            if (keywordsEl) {
                if (keywords.length > 0) {
                    keywordsEl.innerHTML = keywords.map((k, i) => `
                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded-full text-xs fade-in" style="animation-delay: ${i * 0.1}s">
                            ${k}
                        </span>
                    `).join('');
                } else {
                    keywordsEl.innerHTML = `<div class="text-xs text-gray-500 italic">No keywords detected in calls</div>`;
                }
            }
            
            // Update pain points
            const painEl = document.getElementById('extracted-pain');
            if (painEl) {
                if (painPoints.length > 0) {
                    painEl.innerHTML = painPoints.map((p, i) => `
                        <div class="text-xs text-orange-300 fade-in" style="animation-delay: ${i * 0.15}s">
                            ‚ö†Ô∏è ${p}
                        </div>
                    `).join('');
                } else {
                    painEl.innerHTML = `<div class="text-xs text-gray-500 italic">No pain points detected - callers seem satisfied!</div>`;
                }
            }
            
            // Update opportunities/services
            const opportunitiesEl = document.getElementById('content-opportunities');
            if (opportunitiesEl) {
                if (opportunities.length > 0) {
                    opportunitiesEl.innerHTML = opportunities.map((o, i) => `
                        <div class="text-xs text-emerald-300 fade-in cursor-pointer hover:text-emerald-200" style="animation-delay: ${i * 0.15}s">
                            üí° ${o}
                        </div>
                    `).join('');
                } else {
                    opportunitiesEl.innerHTML = `<div class="text-xs text-gray-500 italic">Analyzing call patterns...</div>`;
                }
            }
        }
        
        function simulateIncomingCall() {
            const names = ['Sarah M.', 'John D.', 'Mike R.', 'Lisa K.', 'Tom B.'];
            const locations = ['Port Charlotte, FL', 'Sarasota, FL', 'Venice, FL', 'Bradenton, FL', 'Punta Gorda, FL'];
            
            const callerName = document.getElementById('caller-name');
            const callerLocation = document.getElementById('caller-location');
            const callTimer = document.getElementById('call-timer');
            const callStatus = document.getElementById('call-status-icon');
            const callsToday = document.getElementById('calls-today');
            
            // Check if elements exist
            if (!callerName || !callerLocation || !callTimer || !callStatus || !callsToday) {
                return;
            }
            
            // Pick random caller
            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomLocation = locations[Math.floor(Math.random() * locations.length)];
            
            callerName.textContent = randomName;
            callerLocation.textContent = randomLocation;
            callStatus.textContent = 'üìû';
            callStatus.classList.remove('bg-slate-600');
            callStatus.classList.add('bg-emerald-500');
            
            // Start timer
            let seconds = 0;
            if (callSimulationInterval) clearInterval(callSimulationInterval);
            
            callSimulationInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                if (callTimer) {
                    callTimer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                
                // End call after random duration (30-180 seconds)
                if (seconds >= 30 + Math.floor(Math.random() * 150)) {
                    clearInterval(callSimulationInterval);
                    if (callStatus) {
                        callStatus.textContent = '‚úì';
                        callStatus.classList.remove('bg-emerald-500');
                        callStatus.classList.add('bg-slate-600');
                    }
                    
                    // Update calls today
                    if (callsToday) {
                        const current = parseInt(callsToday.textContent) || 0;
                        callsToday.textContent = `${current + 1} calls analyzed today`;
                    }
                    
                    // Simulate next call after delay
                    setTimeout(simulateIncomingCall, 10000 + Math.random() * 20000);
                }
            }, 1000);
        }
        
        function animateNumber(elementId, start, end, duration) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            const range = end - start;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + range * easeOut);
                el.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }
        
        // ==========================================
        // BLOGS LOADING
        // ==========================================
        
        async function loadBlogs() {
            if (!currentClient) return;
            
            const container = document.getElementById('blogsList');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-12"><div class="spinner mx-auto mb-4"></div><p class="text-gray-400">Loading blog posts...</p></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/content/client/${currentClient.id}?type=blog`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allBlogs = data.content || data.blogs || [];
                    renderBlogs();
                    updateStats();
                } else {
                    allBlogs = [];
                    renderBlogs();
                }
            } catch (error) {
                console.error('Failed to load blogs:', error);
                allBlogs = [];
                renderBlogs();
            }
        }
        
        // ==========================================
        // SOCIAL POSTS LOADING
        // ==========================================
        
        async function loadSocialPosts() {
            if (!currentClient) return;
            
            const container = document.getElementById('socialList');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-12 col-span-2"><div class="spinner mx-auto mb-4"></div><p class="text-gray-400">Loading social posts...</p></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/content/client/${currentClient.id}?type=social`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allSocial = data.content || data.posts || [];
                    renderSocial();
                    updateSocialCounts();
                } else {
                    allSocial = [];
                    renderSocial();
                }
            } catch (error) {
                console.error('Failed to load social posts:', error);
                allSocial = [];
                renderSocial();
            }
        }
        
        function updateSocialCounts() {
            const all = allSocial.length;
            const gbp = allSocial.filter(p => p.platform === 'gbp' || p.platform === 'google').length;
            const fb = allSocial.filter(p => p.platform === 'facebook').length;
            const ig = allSocial.filter(p => p.platform === 'instagram').length;
            
            document.getElementById('countAll').textContent = all;
            document.getElementById('countGbp').textContent = gbp;
            document.getElementById('countFacebook').textContent = fb;
            const igEl = document.getElementById('countInstagram');
            if (igEl) igEl.textContent = ig;
        }
        
        // ==========================================
        // SEO DATA LOADING
        // ==========================================
        
        async function loadSEOData() {
            if (!currentClient) return;
            
            // Load keywords
            const keywordsEl = document.getElementById('keywordsList');
            if (keywordsEl) {
                const keywords = currentClient.primary_keywords || [];
                const secondary = currentClient.secondary_keywords || [];
                const allKeywords = [...keywords, ...secondary];
                
                if (allKeywords.length === 0) {
                    keywordsEl.innerHTML = '<p class="text-gray-500 text-sm">No keywords configured. Add in client settings.</p>';
                } else {
                    keywordsEl.innerHTML = allKeywords.map((kw, i) => `
                        <div class="flex items-center justify-between p-2 glass rounded-lg">
                            <span class="text-white text-sm">${kw}</span>
                            <span class="text-xs ${i < keywords.length ? 'text-purple-400' : 'text-gray-400'}">${i < keywords.length ? 'Primary' : 'Secondary'}</span>
                        </div>
                    `).join('');
                }
            }
            
            // Load competitors
            const compsEl = document.getElementById('competitorsList');
            if (compsEl) {
                const competitors = currentClient.competitors || [];
                if (competitors.length === 0) {
                    compsEl.innerHTML = '<p class="text-gray-500 text-sm">No competitors tracked. Add in Competitors tab.</p>';
                } else {
                    compsEl.innerHTML = competitors.map(comp => `
                        <div class="flex items-center justify-between p-2 glass rounded-lg">
                            <span class="text-white text-sm">${comp.name || comp.domain || comp}</span>
                            <a href="${comp.url || '#'}" target="_blank" class="text-purple-400 text-xs hover:text-purple-300"><i class="fas fa-external-link-alt"></i></a>
                        </div>
                    `).join('');
                }
            }
            
            // Load service pages
            const pagesEl = document.getElementById('servicePagesList');
            if (pagesEl) {
                const pages = currentClient.service_pages || [];
                if (pages.length === 0) {
                    pagesEl.innerHTML = '<p class="text-gray-500 text-sm">No service pages defined. Add in client settings.</p>';
                } else {
                    pagesEl.innerHTML = pages.slice(0, 5).map(page => `
                        <div class="flex items-center justify-between p-2 glass rounded-lg">
                            <span class="text-white text-sm">${page.title || page.keyword}</span>
                            <a href="${page.url || '#'}" target="_blank" class="text-green-400 text-xs hover:text-green-300"><i class="fas fa-external-link-alt"></i></a>
                        </div>
                    `).join('') + (pages.length > 5 ? `<p class="text-gray-500 text-xs mt-2">+${pages.length - 5} more</p>` : '');
                }
            }
            
            // Load USPs
            const uspsEl = document.getElementById('uspsList');
            if (uspsEl) {
                const usps = currentClient.usp || currentClient.usps || [];
                if (usps.length === 0) {
                    uspsEl.innerHTML = '<p class="text-gray-500 text-sm">No USPs defined. Add unique selling points in client settings.</p>';
                } else {
                    uspsEl.innerHTML = usps.map(usp => `
                        <div class="p-2 glass rounded-lg">
                            <span class="text-white text-sm">${usp}</span>
                        </div>
                    `).join('');
                }
            }
            
            // Load competitor insights
            loadCompetitorInsights();
        }
        
        async function loadCompetitorInsights() {
            if (!currentClient) return;
            
            const tableEl = document.getElementById('competitorInsightsTable');
            if (!tableEl) return;
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/rankings?client_id=${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const keywords = data.keywords || [];
                    
                    if (keywords.length === 0) {
                        tableEl.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-500">No ranking data yet. Check Rankings tab.</td></tr>';
                        return;
                    }
                    
                    tableEl.innerHTML = keywords.slice(0, 10).map(kw => `
                        <tr class="border-b border-white/5">
                            <td class="py-3 text-white">${kw.keyword}</td>
                            <td class="py-3 text-center ${kw.position <= 10 ? 'text-green-400' : 'text-gray-400'}">#${kw.position || '--'}</td>
                            <td class="py-3 text-center text-orange-400">#${kw.competitor_position || '--'}</td>
                            <td class="py-3 text-center ${kw.gap > 0 ? 'text-red-400' : 'text-green-400'}">${kw.gap > 0 ? '+' : ''}${kw.gap || 0}</td>
                        </tr>
                    `).join('');
                } else {
                    tableEl.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-500">Rankings not available. Add SEMrush API key.</td></tr>';
                }
            } catch (error) {
                tableEl.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-500">Could not load insights.</td></tr>';
            }
        }
        
        // ==========================================
        // LEADS MANAGEMENT
        // ==========================================
        
        async function loadLeads() {
            console.log('loadLeads called, currentClient:', currentClient);
            
            if (!currentClient) {
                console.log('No currentClient, returning');
                return;
            }
            
            const container = document.getElementById('leadsList');
            console.log('leadsList container:', container);
            if (!container) {
                console.log('No leadsList container, returning');
                return;
            }
            
            const statusFilter = document.getElementById('leadStatusFilter')?.value || '';
            
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-purple-400"></i><p class="text-gray-400 mt-2">Loading leads...</p></div>';
            
            try {
                let url = `${API_URL}/api/leads/?client_id=${currentClient.id}`;
                if (statusFilter) url += `&status=${statusFilter}`;
                
                console.log('Fetching leads from:', url);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                console.log('Leads response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    const leads = data.leads || [];
                    
                    // Update stats
                    const totalLeads = leads.length;
                    const newLeads = leads.filter(l => l.status === 'new' || !l.status).length;
                    const wonLeads = leads.filter(l => l.status === 'won').length;
                    const totalValue = leads.reduce((sum, l) => sum + (parseFloat(l.value) || 0), 0);
                    
                    document.getElementById('leadsTotal').textContent = totalLeads;
                    document.getElementById('leadsNew').textContent = newLeads;
                    document.getElementById('leadsWon').textContent = wonLeads;
                    document.getElementById('leadsTotalValue').textContent = '$' + totalValue.toLocaleString();
                    
                    if (leads.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-user-plus text-4xl mb-4 opacity-50"></i>
                                <p>No leads ${statusFilter ? 'with status "' + statusFilter + '"' : 'captured yet'}</p>
                                <p class="text-sm mt-2">Leads from calls, forms, and chatbot will appear here</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = leads.map(lead => `
                        <div class="glass rounded-xl p-4 hover:bg-white/5 transition">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-white font-bold">
                                        ${(lead.name || 'L')[0].toUpperCase()}
                                    </div>
                                    <div>
                                        <h4 class="text-white font-medium">${lead.name || 'Unknown'}</h4>
                                        <p class="text-sm text-gray-400">${lead.email || ''} ${lead.email && lead.phone ? '‚Ä¢' : ''} ${lead.phone || ''}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <select onchange="updateLeadStatus('${lead.id}', this.value)" class="px-2 py-1 rounded-full text-xs ${getLeadStatusColor(lead.status)} bg-transparent border-0 cursor-pointer">
                                        <option value="new" ${lead.status === 'new' || !lead.status ? 'selected' : ''}>New</option>
                                        <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                                        <option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>Qualified</option>
                                        <option value="proposal" ${lead.status === 'proposal' ? 'selected' : ''}>Proposal</option>
                                        <option value="won" ${lead.status === 'won' ? 'selected' : ''}>Won</option>
                                        <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Lost</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">${formatDate(lead.created_at)}</p>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center gap-4 text-sm">
                                <span class="text-gray-400"><i class="fas fa-tag mr-1"></i>${lead.source || 'Unknown'}</span>
                                ${lead.value ? `<span class="text-green-400"><i class="fas fa-dollar-sign mr-1"></i>${lead.value}</span>` : ''}
                                ${lead.page_url ? `<a href="${lead.page_url}" target="_blank" class="text-purple-400 hover:text-purple-300"><i class="fas fa-external-link-alt mr-1"></i>Source Page</a>` : ''}
                            </div>
                            ${lead.notes ? `<p class="mt-2 text-sm text-gray-400 italic">"${lead.notes}"</p>` : ''}
                        </div>
                    `).join('');
                } else {
                    const errorText = await response.text();
                    console.error('Leads API error:', response.status, errorText);
                    container.innerHTML = `<div class="text-center py-8 text-red-400">Failed to load leads (${response.status})</div>`;
                }
            } catch (error) {
                console.error('Failed to load leads:', error);
                container.innerHTML = `<div class="text-center py-8 text-red-400">Error loading leads: ${error.message || 'Network error'}</div>`;
            }
        }
        
        async function updateLeadStatus(leadId, status) {
            try {
                const response = await fetch(`${API_URL}/api/leads/${leadId}/status`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    showToast('Lead status updated!', 'success');
                    loadLeads(); // Refresh
                } else {
                    showToast('Failed to update status', 'error');
                }
            } catch (error) {
                showToast('Error updating status', 'error');
            }
        }
        
        function getLeadStatusColor(status) {
            const colors = {
                'new': 'bg-blue-500/20 text-blue-400',
                'contacted': 'bg-yellow-500/20 text-yellow-400',
                'qualified': 'bg-purple-500/20 text-purple-400',
                'proposal': 'bg-orange-500/20 text-orange-400',
                'won': 'bg-green-500/20 text-green-400',
                'lost': 'bg-red-500/20 text-red-400'
            };
            return colors[status] || colors['new'];
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }
        
        // ==========================================
        // REVIEWS MANAGEMENT
        // ==========================================
        
        async function loadReviews() {
            if (!currentClient) return;
            
            const container = document.getElementById('reviewsList');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-yellow-400"></i><p class="text-gray-400 mt-2">Loading reviews...</p></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/reviews?client_id=${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const reviews = data.reviews || [];
                    
                    // Update stats
                    const totalReviews = reviews.length;
                    const avgRating = totalReviews > 0 
                        ? (reviews.reduce((sum, r) => sum + (r.rating || 0), 0) / totalReviews).toFixed(1)
                        : '--';
                    const positiveReviews = reviews.filter(r => r.rating >= 4).length;
                    const respondedReviews = reviews.filter(r => r.reply).length;
                    const responseRate = totalReviews > 0 
                        ? Math.round((respondedReviews / totalReviews) * 100)
                        : 0;
                    
                    document.getElementById('reviewsAvgRating').textContent = avgRating;
                    document.getElementById('reviewsTotal').textContent = totalReviews;
                    document.getElementById('reviewsPositive').textContent = positiveReviews;
                    document.getElementById('reviewsResponded').textContent = responseRate + '%';
                    
                    if (reviews.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-star text-4xl mb-4 opacity-50"></i>
                                <p>No reviews synced yet</p>
                                <p class="text-sm mt-2">Connect your Google Business Profile in Settings ‚Üí Integrations</p>
                                <button onclick="showTab('settings')" class="mt-4 px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 rounded-lg text-white text-sm hover:opacity-90 transition">
                                    <i class="fas fa-cog mr-2"></i>Configure GBP
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = reviews.map(review => `
                        <div class="glass rounded-xl p-4 hover:bg-white/5 transition">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center text-white font-bold">
                                        ${(review.reviewer_name || 'R')[0].toUpperCase()}
                                    </div>
                                    <div>
                                        <h4 class="text-white font-medium">${review.reviewer_name || 'Anonymous'}</h4>
                                        <div class="flex items-center gap-1">
                                            ${getStarRating(review.rating)}
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500">${formatDate(review.created_at)}</p>
                            </div>
                            <p class="mt-3 text-gray-300">${review.text || ''}</p>
                            ${review.reply ? `
                                <div class="mt-3 pl-4 border-l-2 border-purple-500">
                                    <p class="text-sm text-gray-400"><strong>Your reply:</strong> ${review.reply}</p>
                                </div>
                            ` : `
                                <div class="mt-3 flex gap-2">
                                    <button onclick="generateReviewReply('${review.id}')" class="px-3 py-1 text-sm bg-purple-600/20 text-purple-400 rounded-lg hover:bg-purple-600/30 transition">
                                        <i class="fas fa-magic mr-1"></i>Generate AI Reply
                                    </button>
                                    ${review.suggested_response ? `
                                        <button onclick="postReviewReply('${review.id}')" class="px-3 py-1 text-sm bg-green-600/20 text-green-400 rounded-lg hover:bg-green-600/30 transition">
                                            <i class="fas fa-check mr-1"></i>Post Reply
                                        </button>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    `).join('');
                } else if (response.status === 404) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-star text-4xl mb-4 opacity-50"></i>
                            <p>Google Business Profile not connected</p>
                            <p class="text-sm mt-2">Connect GBP in Settings to see and respond to reviews</p>
                            <button onclick="showTab('settings')" class="mt-4 px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 rounded-lg text-white text-sm hover:opacity-90 transition">
                                <i class="fas fa-cog mr-2"></i>Connect GBP
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-red-400">Failed to load reviews</div>';
                }
            } catch (error) {
                console.error('Failed to load reviews:', error);
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-star text-4xl mb-4 opacity-50"></i>
                        <p>Reviews not available</p>
                        <p class="text-sm mt-2">Connect your Google Business Profile to see reviews</p>
                    </div>
                `;
            }
        }
        
        function getStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star text-yellow-400 text-sm"></i>';
                } else {
                    stars += '<i class="fas fa-star text-gray-600 text-sm"></i>';
                }
            }
            return stars;
        }
        
        async function generateReviewReply(reviewId) {
            showToast('Generating AI reply...', 'info');
            try {
                const response = await fetch(`${API_URL}/api/reviews/${reviewId}/generate-response`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast('Reply generated!', 'success');
                    loadReviews(); // Refresh
                } else {
                    showToast('Failed to generate reply', 'error');
                }
            } catch (error) {
                showToast('Error generating reply', 'error');
            }
        }
        
        async function generateAllReviewResponses() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            showToast('Generating replies for all pending reviews...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/api/reviews/generate-all-responses?client_id=${currentClient.id}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`Generated ${data.generated || 0} replies!`, 'success');
                    loadReviews();
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to generate replies', 'error');
                }
            } catch (error) {
                showToast('Error generating replies', 'error');
            }
        }
        
        async function sendReviewRequests() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const count = prompt('How many review requests would you like to send?', '10');
            if (!count) return;
            
            showToast('Sending review requests...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/api/reviews/request/send`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: currentClient.id,
                        count: parseInt(count)
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`Sent ${data.sent || 0} review requests!`, 'success');
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to send requests', 'error');
                }
            } catch (error) {
                showToast('Error sending review requests', 'error');
            }
        }
        
        // ==========================================
        // CALLS MANAGEMENT
        // ==========================================
        
        async function loadCalls() {
            if (!currentClient) return;
            
            const container = document.getElementById('callsList');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-green-400"></i><p class="text-gray-400 mt-2">Loading calls...</p></div>';
            
            try {
                // First try the direct calls endpoint - get 90 days of calls
                const response = await fetch(`${API_URL}/api/intelligence/calls/${currentClient.id}?days=90`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                const data = await response.json();
                
                // Check for configuration errors
                if (data.error) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4 text-yellow-500"></i>
                            <p class="text-yellow-400">${data.error}</p>
                            <p class="text-sm mt-2">${data.message || ''}</p>
                            <button onclick="showTab('settings')" class="mt-4 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg text-white text-sm hover:opacity-90 transition">
                                <i class="fas fa-cog mr-2"></i>Configure CallRail
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const calls = data.calls || [];
                
                // Update stats
                const totalCalls = calls.length;
                const answeredCalls = calls.filter(c => c.answered).length;
                const totalDuration = calls.reduce((sum, c) => sum + (c.duration || 0), 0);
                const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;
                const leadsGenerated = calls.filter(c => c.lead_created || c.first_call).length;
                
                document.getElementById('callsTotal').textContent = totalCalls;
                document.getElementById('callsAnswered').textContent = answeredCalls;
                document.getElementById('callsAvgDuration').textContent = formatCallDuration(avgDuration);
                document.getElementById('callsLeads').textContent = leadsGenerated;
                
                // Update insights (from calls data)
                document.getElementById('topQuestions').innerHTML = '<p class="text-gray-500 text-sm">Analysis requires call transcripts</p>';
                document.getElementById('callKeywords').innerHTML = '<p class="text-gray-500 text-sm">Analysis requires call transcripts</p>';
                
                if (calls.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                            <p>No calls recorded yet</p>
                            <p class="text-sm mt-2">Calls will appear here once they come through CallRail</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = calls.map(call => `
                    <div class="glass rounded-xl p-4 hover:bg-white/5 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br ${call.answered ? 'from-green-500 to-emerald-600' : 'from-red-500 to-rose-600'} flex items-center justify-center text-white">
                                    <i class="fas fa-phone${call.voicemail ? '-slash' : ''}"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-white">${call.caller_name || 'Unknown Caller'}</h4>
                                    <p class="text-sm text-gray-400">${call.caller_number || 'No number'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-400">${formatDate(call.date)}</p>
                                <p class="text-sm ${call.answered ? 'text-green-400' : 'text-red-400'}">${call.duration_formatted || formatCallDuration(call.duration)}</p>
                            </div>
                        </div>
                        ${call.first_call ? '<span class="inline-block mt-2 px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded">First Time Caller</span>' : ''}
                        ${call.has_transcript ? `<p class="mt-2 text-sm text-gray-400 line-clamp-2">${call.transcript_preview || ''}</p>` : ''}
                        <div class="flex gap-2 mt-3">
                            ${call.recording_url ? `<a href="${call.recording_url}" target="_blank" class="text-xs text-blue-400 hover:underline"><i class="fas fa-play mr-1"></i>Recording</a>` : ''}
                            <span class="text-xs text-gray-500">${call.source || 'Direct'}</span>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load calls:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Error loading calls: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function refreshCallData() {
            await loadCalls();
            showToast('Call data refreshed', 'success');
        }
        
        function formatCallDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // ==========================================
        // PAGES MANAGEMENT
        // ==========================================
        
        async function loadPages() {
            if (!currentClient) return;
            
            const container = document.getElementById('pagesList');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-purple-400"></i><p class="text-gray-400 mt-2">Loading pages...</p></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/pages?client_id=${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const pages = data.pages || [];
                    
                    if (pages.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-file-code text-4xl mb-4 opacity-50"></i>
                                <p>No pages created yet</p>
                                <p class="text-sm mt-2">Generate service pages from the Generate tab</p>
                                <button onclick="showTab('generate')" class="mt-4 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg text-white text-sm hover:opacity-90 transition">
                                    <i class="fas fa-magic mr-2"></i>Generate Pages
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="grid gap-4">
                            ${pages.map(page => `
                                <div class="glass rounded-xl p-4 hover:bg-white/5 transition">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <h4 class="text-white font-medium">${page.title}</h4>
                                            <p class="text-sm text-gray-400">${page.slug || page.url || ''}</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="px-2 py-1 rounded-full text-xs ${page.status === 'published' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">
                                                ${page.status || 'draft'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="mt-3 flex items-center gap-4">
                                        ${page.wordpress_url ? `
                                            <a href="${page.wordpress_url}" target="_blank" class="text-sm text-purple-400 hover:text-purple-300">
                                                <i class="fas fa-external-link-alt mr-1"></i>View Live
                                            </a>
                                        ` : ''}
                                        <button onclick="editPage('${page.id}')" class="text-sm text-gray-400 hover:text-white">
                                            <i class="fas fa-edit mr-1"></i>Edit
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-file-code text-4xl mb-4 opacity-50"></i>
                            <p>No pages created yet</p>
                            <p class="text-sm mt-2">Generate service pages from the Generate tab</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load pages:', error);
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-file-code text-4xl mb-4 opacity-50"></i>
                        <p>No pages created yet</p>
                        <p class="text-sm mt-2">Generate service pages from the Generate tab</p>
                    </div>
                `;
            }
        }
        
        function editPage(pageId) {
            showToast('Page editing coming soon!', 'info');
        }
        
        // ==========================================
        // NOTIFICATION SETTINGS
        // ==========================================
        
        let notificationPrefs = null;
        
        async function loadNotificationPrefs() {
            try {
                const response = await fetch(`${API_URL}/api/notifications/preferences`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    notificationPrefs = data.preferences;
                    populateNotificationForm(notificationPrefs);
                }
            } catch (error) {
                console.error('Failed to load notification prefs:', error);
            }
        }
        
        function populateNotificationForm(prefs) {
            // Master toggle
            document.getElementById('notifEmailEnabled').checked = prefs.delivery?.email_enabled !== false;
            
            // Content notifications
            document.getElementById('notifContentScheduled').checked = prefs.content?.scheduled !== false;
            document.getElementById('notifContentDueToday').checked = prefs.content?.due_today !== false;
            document.getElementById('notifContentPublished').checked = prefs.content?.published !== false;
            document.getElementById('notifApprovalNeeded').checked = prefs.content?.approval_needed !== false;
            document.getElementById('notifContentFeedback').checked = prefs.content?.feedback !== false;
            
            // Competitor notifications
            document.getElementById('notifCompetitorContent').checked = prefs.competitor?.new_content !== false;
            document.getElementById('notifRankingImproved').checked = prefs.competitor?.ranking_improved !== false;
            document.getElementById('notifRankingDropped').checked = prefs.competitor?.ranking_dropped !== false;
            
            // Publishing notifications
            document.getElementById('notifWpPublished').checked = prefs.publishing?.wordpress_published !== false;
            document.getElementById('notifWpFailed').checked = prefs.publishing?.wordpress_failed !== false;
            document.getElementById('notifSocialPublished').checked = prefs.publishing?.social_published === true;
            document.getElementById('notifSocialFailed').checked = prefs.publishing?.social_failed !== false;
            
            // Delivery settings
            document.getElementById('notifDigestFreq').value = prefs.delivery?.digest_frequency || 'instant';
            document.getElementById('notifDigestTime').value = prefs.delivery?.digest_time || '08:00';
            document.getElementById('notifDigestDay').value = prefs.delivery?.digest_day || 0;
            
            // Show/hide digest options
            updateDigestVisibility();
            
            // Quiet hours
            document.getElementById('notifQuietEnabled').checked = prefs.quiet_hours?.enabled === true;
            document.getElementById('notifQuietStart').value = prefs.quiet_hours?.start || '22:00';
            document.getElementById('notifQuietEnd').value = prefs.quiet_hours?.end || '07:00';
            updateQuietHoursVisibility();
        }
        
        function updateDigestVisibility() {
            const freq = document.getElementById('notifDigestFreq').value;
            const timeWrapper = document.getElementById('digestTimeWrapper');
            const dayWrapper = document.getElementById('digestDayWrapper');
            
            if (freq === 'instant') {
                timeWrapper.classList.add('hidden');
                dayWrapper.classList.add('hidden');
            } else if (freq === 'daily') {
                timeWrapper.classList.remove('hidden');
                dayWrapper.classList.add('hidden');
            } else {
                timeWrapper.classList.remove('hidden');
                dayWrapper.classList.remove('hidden');
            }
        }
        
        function updateQuietHoursVisibility() {
            const enabled = document.getElementById('notifQuietEnabled').checked;
            const config = document.getElementById('quietHoursConfig');
            const inputs = config.querySelectorAll('input');
            
            if (enabled) {
                config.classList.remove('opacity-50');
                inputs.forEach(i => i.disabled = false);
            } else {
                config.classList.add('opacity-50');
                inputs.forEach(i => i.disabled = true);
            }
        }
        
        // Add event listeners for digest and quiet hours toggles
        document.addEventListener('DOMContentLoaded', function() {
            const digestFreq = document.getElementById('notifDigestFreq');
            const quietEnabled = document.getElementById('notifQuietEnabled');
            
            if (digestFreq) digestFreq.addEventListener('change', updateDigestVisibility);
            if (quietEnabled) quietEnabled.addEventListener('change', updateQuietHoursVisibility);
            
            // Handle OAuth callback if present
            handleOAuthCallback();
        });
        
        async function saveNotificationPrefs() {
            const prefs = {
                email_enabled: document.getElementById('notifEmailEnabled').checked,
                
                // Content
                content_scheduled: document.getElementById('notifContentScheduled').checked,
                content_due_today: document.getElementById('notifContentDueToday').checked,
                content_published: document.getElementById('notifContentPublished').checked,
                content_approval_needed: document.getElementById('notifApprovalNeeded').checked,
                content_feedback: document.getElementById('notifContentFeedback').checked,
                
                // Competitor
                competitor_new_content: document.getElementById('notifCompetitorContent').checked,
                ranking_improved: document.getElementById('notifRankingImproved').checked,
                ranking_dropped: document.getElementById('notifRankingDropped').checked,
                
                // Publishing
                wordpress_published: document.getElementById('notifWpPublished').checked,
                wordpress_failed: document.getElementById('notifWpFailed').checked,
                social_published: document.getElementById('notifSocialPublished').checked,
                social_failed: document.getElementById('notifSocialFailed').checked,
                
                // Delivery
                digest_frequency: document.getElementById('notifDigestFreq').value,
                digest_time: document.getElementById('notifDigestTime').value,
                digest_day: parseInt(document.getElementById('notifDigestDay').value),
                
                // Quiet hours
                quiet_hours_enabled: document.getElementById('notifQuietEnabled').checked,
                quiet_start: document.getElementById('notifQuietStart').value,
                quiet_end: document.getElementById('notifQuietEnd').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/notifications/preferences`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(prefs)
                });
                
                if (response.ok) {
                    showToast('Notification preferences saved!', 'success');
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to save preferences', 'error');
                }
            } catch (error) {
                showToast('Error saving preferences', 'error');
            }
        }
        
        function updateDigestPreview() {
            const freq = document.getElementById('notifDigestFreq').value;
            const timeWrapper = document.getElementById('digestTimeWrapper');
            const dayWrapper = document.getElementById('digestDayWrapper');
            const preview = document.getElementById('digestPreview');
            const nextTime = document.getElementById('nextDigestTime');
            
            if (freq === 'instant') {
                timeWrapper.classList.add('hidden');
                dayWrapper.classList.add('hidden');
                preview.classList.add('hidden');
            } else {
                timeWrapper.classList.remove('hidden');
                preview.classList.remove('hidden');
                
                if (freq === 'weekly') {
                    dayWrapper.classList.remove('hidden');
                } else {
                    dayWrapper.classList.add('hidden');
                }
                
                // Calculate next digest time
                const time = document.getElementById('notifDigestTime').value || '08:00';
                const dayIndex = parseInt(document.getElementById('notifDigestDay').value) || 0;
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                
                const now = new Date();
                let nextDate = new Date();
                
                if (freq === 'daily') {
                    const [hours, mins] = time.split(':').map(Number);
                    nextDate.setHours(hours, mins, 0, 0);
                    if (nextDate <= now) {
                        nextDate.setDate(nextDate.getDate() + 1);
                    }
                    nextTime.textContent = `Tomorrow at ${time} (then daily)`;
                } else if (freq === 'weekly') {
                    const [hours, mins] = time.split(':').map(Number);
                    const currentDay = now.getDay();
                    const targetDay = (dayIndex + 1) % 7; // Convert to JS day (0=Sun)
                    let daysUntil = targetDay - currentDay;
                    if (daysUntil <= 0) daysUntil += 7;
                    
                    nextDate.setDate(now.getDate() + daysUntil);
                    nextDate.setHours(hours, mins, 0, 0);
                    
                    nextTime.textContent = `${days[dayIndex]} at ${time} (${nextDate.toLocaleDateString()})`;
                }
            }
        }
        
        // Initialize digest preview on settings load
        document.getElementById('notifDigestFreq')?.addEventListener('change', updateDigestPreview);
        
        async function sendTestNotification() {
            const btn = document.getElementById('testNotifBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                const response = await fetch(`${API_URL}/api/notifications/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast('Test email sent! Check your inbox.', 'success');
                } else {
                    showToast(data.error || 'Failed to send test email', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Test Email';
            }
        }
        
        async function loadNotificationHistory() {
            try {
                const response = await fetch(`${API_URL}/api/notifications/history?limit=10`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderNotificationHistory(data.notifications);
                }
            } catch (error) {
                console.error('Failed to load notification history:', error);
            }
        }
        
        function renderNotificationHistory(notifications) {
            const container = document.getElementById('notificationHistory');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No notifications sent yet</p>';
                return;
            }
            
            container.innerHTML = notifications.map(n => {
                const statusColor = n.status === 'sent' ? 'text-green-400' : 
                                   n.status === 'failed' ? 'text-red-400' : 'text-yellow-400';
                const statusIcon = n.status === 'sent' ? 'fa-check-circle' : 
                                  n.status === 'failed' ? 'fa-times-circle' : 'fa-clock';
                const date = new Date(n.created_at).toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                
                return `
                    <div class="p-2 bg-white/5 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">${date}</span>
                            <i class="fas ${statusIcon} ${statusColor}"></i>
                        </div>
                        <div class="text-sm text-white truncate mt-1">${n.subject}</div>
                    </div>
                `;
            }).join('');
        }
        
        // ==========================================
        // INTEGRATIONS
        // ==========================================
        
        // ==========================================
        // SETTINGS SUB-NAVIGATION
        // ==========================================
        
        function showSettingsSection(section) {
            // Hide all sections
            document.getElementById('settings-section-integrations').classList.add('hidden');
            document.getElementById('settings-section-notifications').classList.add('hidden');
            document.getElementById('settings-section-system').classList.add('hidden');
            
            // Reset all tab buttons
            document.getElementById('settings-tab-integrations').className = 'px-4 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white glass transition whitespace-nowrap';
            document.getElementById('settings-tab-notifications').className = 'px-4 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white glass transition whitespace-nowrap';
            document.getElementById('settings-tab-system').className = 'px-4 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white glass transition whitespace-nowrap';
            
            // Show selected section and highlight tab
            document.getElementById(`settings-section-${section}`).classList.remove('hidden');
            document.getElementById(`settings-tab-${section}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white transition whitespace-nowrap';
            
            // Load data for section
            if (section === 'integrations') {
                loadIntegrationsTop();
            } else if (section === 'system') {
                loadSystemStatus();
            }
        }
        
        async function loadIntegrationsTop() {
            if (!currentClient) return;
            
            // Populate fields from client data
            const ga4Input = document.getElementById('ga4PropertyIdTop');
            const callrailInput = document.getElementById('callrailCompanyIdTop');
            const wpUrlInput = document.getElementById('wpSiteUrlTop');
            const wpUserInput = document.getElementById('wpUsernameTop');
            const wpPasswordInput = document.getElementById('wpAppPasswordTop');
            
            if (ga4Input) ga4Input.value = currentClient.ga4_property_id || '';
            if (callrailInput) callrailInput.value = currentClient.callrail_company_id || '';
            if (wpUrlInput) wpUrlInput.value = currentClient.wordpress_url || '';
            if (wpUserInput) wpUserInput.value = currentClient.wordpress_user || '';
            if (wpPasswordInput) wpPasswordInput.value = currentClient.wordpress_app_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
            
            // Update status indicators
            updateIntegrationStatusTop('ga4', currentClient.ga4_property_id);
            updateIntegrationStatusTop('callrail', currentClient.callrail_company_id);
            updateIntegrationStatusTop('wp', currentClient.wordpress_url);
            
            // Check server-side APIs
            checkServerApisTop();
        }
        
        function updateIntegrationStatusTop(type, value) {
            const statusEl = document.getElementById(`${type}StatusTop`);
            if (!statusEl) return;
            
            if (value) {
                statusEl.textContent = '‚úì Connected';
                statusEl.className = 'text-xs text-green-400';
            } else {
                statusEl.textContent = 'Not configured';
                statusEl.className = 'text-xs text-gray-400';
            }
        }
        
        async function checkServerApisTop() {
            try {
                const response = await fetch(`${API_URL}/api/settings/integrations/status`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // OpenAI
                    const openaiEl = document.getElementById('openaiStatusTop');
                    if (openaiEl) {
                        openaiEl.textContent = data.openai_configured ? '‚úì Ready' : '‚úó Missing';
                        openaiEl.className = data.openai_configured ? 'text-green-400' : 'text-red-400';
                    }
                    
                    // SEMrush
                    const semrushEl = document.getElementById('semrushStatusTop');
                    if (semrushEl) {
                        semrushEl.textContent = data.semrush_configured ? '‚úì Ready' : '‚úó Missing';
                        semrushEl.className = data.semrush_configured ? 'text-green-400' : 'text-yellow-400';
                    }
                    
                    // SendGrid
                    const sendgridEl = document.getElementById('sendgridStatusTop');
                    if (sendgridEl) {
                        sendgridEl.textContent = data.sendgrid_configured ? '‚úì Ready' : '‚Äì Optional';
                        sendgridEl.className = data.sendgrid_configured ? 'text-green-400' : 'text-gray-400';
                    }
                }
            } catch (error) {
                console.error('Failed to check server APIs:', error);
            }
        }
        
        async function saveIntegrationsTop() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const updates = {
                ga4_property_id: document.getElementById('ga4PropertyIdTop')?.value.trim() || null,
                callrail_company_id: document.getElementById('callrailCompanyIdTop')?.value.trim() || null,
                wordpress_url: document.getElementById('wpSiteUrlTop')?.value.trim() || null,
                wordpress_user: document.getElementById('wpUsernameTop')?.value.trim() || null
            };
            
            const wpPass = document.getElementById('wpAppPasswordTop')?.value;
            if (wpPass && !wpPass.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                updates.wordpress_app_password = wpPass;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/clients/${currentClient.id}/integrations`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(updates)
                });
                
                if (response.ok) {
                    Object.assign(currentClient, updates);
                    loadIntegrationsTop();
                    showToast('Integrations saved!', 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error || 'Failed to save', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        // ==========================================
        // INTEGRATIONS (OLD)
        // ==========================================
        
        async function loadIntegrations() {
            if (!currentClient) return;
            
            // Load from current client data
            const ga4Input = document.getElementById('ga4PropertyId');
            const callrailInput = document.getElementById('callrailCompanyId');
            const gscInput = document.getElementById('gscSiteUrl');
            const wpUrlInput = document.getElementById('wpSiteUrl');
            const wpPasswordInput = document.getElementById('wpAppPassword');
            
            if (ga4Input) ga4Input.value = currentClient.ga4_property_id || '';
            if (callrailInput) callrailInput.value = currentClient.callrail_company_id || '';
            if (gscInput) gscInput.value = currentClient.gsc_site_url || '';
            if (wpUrlInput) wpUrlInput.value = currentClient.wordpress_url || '';
            if (wpPasswordInput) wpPasswordInput.value = currentClient.wordpress_app_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
            
            // Update status indicators
            updateIntegrationStatus('ga4', currentClient.ga4_property_id);
            updateIntegrationStatus('callrail', currentClient.callrail_company_id);
            updateIntegrationStatus('gsc', currentClient.gsc_site_url);
            updateIntegrationStatus('wp', currentClient.wordpress_url);
            
            // Check server-side integrations
            checkServerIntegrations();
        }
        
        function updateIntegrationStatus(type, value) {
            const statusEl = document.getElementById(`${type}Status`);
            if (!statusEl) return;
            
            if (value) {
                statusEl.textContent = '‚úì Connected';
                statusEl.className = 'text-xs text-green-400';
            } else {
                statusEl.textContent = 'Not configured';
                statusEl.className = 'text-xs text-gray-400';
            }
        }
        
        async function checkServerIntegrations() {
            try {
                const response = await fetch(`${API_URL}/api/settings/integrations/status`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const openaiStatus = document.getElementById('openaiStatus');
                    const semrushStatus = document.getElementById('semrushStatus');
                    
                    if (openaiStatus) {
                        if (data.openai_configured) {
                            openaiStatus.textContent = '‚úì Configured';
                            openaiStatus.className = 'text-xs text-green-400';
                        } else {
                            openaiStatus.textContent = '‚úó Not configured';
                            openaiStatus.className = 'text-xs text-red-400';
                        }
                    }
                    
                    if (semrushStatus) {
                        if (data.semrush_configured) {
                            semrushStatus.textContent = '‚úì Configured';
                            semrushStatus.className = 'text-xs text-green-400';
                        } else {
                            semrushStatus.textContent = 'Not configured';
                            semrushStatus.className = 'text-xs text-gray-400';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to check server integrations:', error);
            }
        }
        
        async function saveIntegration(type) {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const updates = {};
            
            switch(type) {
                case 'ga4':
                    updates.ga4_property_id = document.getElementById('ga4PropertyId').value.trim();
                    break;
                case 'callrail':
                    updates.callrail_company_id = document.getElementById('callrailCompanyId').value.trim();
                    break;
                case 'gsc':
                    updates.gsc_site_url = document.getElementById('gscSiteUrl').value.trim();
                    break;
                case 'wordpress':
                    updates.wordpress_url = document.getElementById('wpSiteUrl').value.trim();
                    const wpPass = document.getElementById('wpAppPassword').value;
                    if (wpPass && !wpPass.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                        updates.wordpress_app_password = wpPass;
                    }
                    break;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/clients/${currentClient.id}/integrations`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(updates)
                });
                
                if (response.ok) {
                    // Update local client data
                    Object.assign(currentClient, updates);
                    updateIntegrationStatus(type, Object.values(updates)[0]);
                    showToast(`${type.toUpperCase()} integration saved!`, 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error || 'Failed to save integration', 'error');
                }
            } catch (error) {
                console.error('Integration save error:', error);
                showToast('Failed to save integration', 'error');
            }
        }
        
        async function saveAllIntegrations() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const updates = {
                ga4_property_id: document.getElementById('ga4PropertyId')?.value.trim() || null,
                callrail_company_id: document.getElementById('callrailCompanyId')?.value.trim() || null,
                gsc_site_url: document.getElementById('gscSiteUrl')?.value.trim() || null,
                wordpress_url: document.getElementById('wpSiteUrl')?.value.trim() || null
            };
            
            const wpPass = document.getElementById('wpAppPassword')?.value;
            if (wpPass && !wpPass.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                updates.wordpress_app_password = wpPass;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/clients/${currentClient.id}/integrations`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(updates)
                });
                
                if (response.ok) {
                    Object.assign(currentClient, updates);
                    loadIntegrations(); // Refresh status
                    showToast('All integrations saved!', 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error || 'Failed to save integrations', 'error');
                }
            } catch (error) {
                console.error('Integration save error:', error);
                showToast('Failed to save integrations', 'error');
            }
        }
        
        async function loadSystemStatus() {
            const container = document.getElementById('systemStatusContent');
            const summary = document.getElementById('systemStatusSummary');
            
            try {
                const response = await fetch(`${API_URL}/api/settings/system-status`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (!response.ok) {
                    container.innerHTML = '<p class="text-red-400 col-span-full">Failed to load system status</p>';
                    return;
                }
                
                const data = await response.json();
                
                // Render each integration
                const statusColors = {
                    'ready': 'text-green-400',
                    'not_configured': 'text-red-400',
                    'per_client': 'text-blue-400',
                    'manual_only': 'text-yellow-400'
                };
                
                const statusIcons = {
                    'ready': 'fa-check-circle',
                    'not_configured': 'fa-times-circle',
                    'per_client': 'fa-user-cog',
                    'manual_only': 'fa-hand-paper'
                };
                
                const statusLabels = {
                    'ready': 'Ready',
                    'not_configured': 'Not Configured',
                    'per_client': 'Per-Client',
                    'manual_only': 'Manual Only'
                };
                
                container.innerHTML = Object.entries(data.integrations).map(([key, int]) => `
                    <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-white">${int.name}</span>
                            <span class="${statusColors[int.status]}">
                                <i class="fas ${statusIcons[int.status]} mr-1"></i>${statusLabels[int.status]}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            ${int.features.slice(0, 3).join(' ‚Ä¢ ')}
                        </div>
                        ${int.status !== 'ready' ? `
                            <div class="text-xs text-gray-400 mt-2 p-2 bg-black/20 rounded">
                                <strong>Needs:</strong> ${int.required_env.slice(0, 2).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
                // Show summary
                summary.classList.remove('hidden');
                document.getElementById('systemStatusPercent').textContent = `${data.summary.percentage}%`;
                document.getElementById('systemStatusBar').style.width = `${data.summary.percentage}%`;
                
            } catch (error) {
                console.error('System status error:', error);
                container.innerHTML = '<p class="text-red-400 col-span-full">Error loading system status</p>';
            }
        }
        
        // ==========================================
        // CALENDAR
        // ==========================================
        let calendarDate = new Date();
        let scheduledContent = [];
        
        function changeMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day and days in month
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            // Build calendar grid
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="h-24 rounded-lg bg-white/5"></div>`;
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const dayContent = getScheduledForDate(dateStr);
                
                grid.innerHTML += `
                    <div class="h-24 rounded-lg ${isToday ? 'bg-purple-500/20 border border-purple-500' : 'bg-white/5 hover:bg-white/10'} p-2 transition cursor-pointer" onclick="showDateContent('${dateStr}')">
                        <div class="text-sm font-medium ${isToday ? 'text-purple-400' : 'text-gray-300'}">${day}</div>
                        <div class="mt-1 space-y-1 overflow-hidden">
                            ${dayContent}
                        </div>
                    </div>
                `;
            }
            
            // Update scheduled list
            renderScheduledList();
        }
        
        function getScheduledForDate(dateStr) {
            const items = scheduledContent.filter(c => c.scheduled_date === dateStr);
            if (items.length === 0) return '';
            
            return items.slice(0, 3).map(item => {
                const colors = {
                    blog: 'bg-green-500',
                    gbp: 'bg-blue-500',
                    facebook: 'bg-indigo-500',
                    instagram: 'bg-pink-500'
                };
                return `<div class="w-full h-1.5 rounded ${colors[item.type] || 'bg-gray-500'}" title="${item.title || item.topic}"></div>`;
            }).join('');
        }
        
        function renderScheduledList() {
            const container = document.getElementById('scheduledList');
            
            // Combine blogs and social posts with REAL dates
            scheduledContent = [];
            
            // Add blogs - use actual scheduled_for from database
            allBlogs.forEach((blog) => {
                let scheduledDate = null;
                if (blog.scheduled_for) {
                    scheduledDate = blog.scheduled_for.split('T')[0];
                }
                scheduledContent.push({
                    id: blog.id,
                    type: 'blog',
                    title: blog.title,
                    scheduled_date: scheduledDate,
                    status: blog.status
                });
            });
            
            // Add social posts - use actual scheduled_for
            allSocial.forEach((post) => {
                let scheduledDate = null;
                if (post.scheduled_for) {
                    scheduledDate = post.scheduled_for.split('T')[0];
                }
                scheduledContent.push({
                    id: post.id,
                    type: post.platform,
                    topic: post.topic || post.content?.substring(0, 50),
                    scheduled_date: scheduledDate,
                    status: post.status
                });
            });
            
            // Filter to only scheduled items and sort by date
            const scheduledOnly = scheduledContent.filter(c => c.scheduled_date);
            scheduledOnly.sort((a, b) => a.scheduled_date.localeCompare(b.scheduled_date));
            
            // Stats
            const scheduledCount = scheduledOnly.length;
            const unscheduledCount = scheduledContent.length - scheduledCount;
            
            if (scheduledContent.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No content yet. Generate content first.</p>';
                return;
            }
            
            if (scheduledCount === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-400 text-sm mb-3">${unscheduledCount} items not scheduled</p>
                        <button onclick="autoScheduleContent()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-magic mr-1"></i>Auto-Schedule All
                        </button>
                    </div>
                `;
                return;
            }
            
            // Show scheduled items
            let html = '';
            if (unscheduledCount > 0) {
                html += `
                    <div class="mb-4 p-3 bg-amber-500/20 border border-amber-500/50 rounded-lg">
                        <p class="text-amber-400 text-sm">${unscheduledCount} items not scheduled</p>
                        <button onclick="autoScheduleContent()" class="mt-2 px-3 py-1 bg-amber-500 hover:bg-amber-600 text-white rounded text-xs font-medium transition">
                            <i class="fas fa-magic mr-1"></i>Auto-Schedule
                        </button>
                    </div>
                `;
            }
            
            html += scheduledOnly.slice(0, 10).map(item => {
                const colors = {
                    blog: 'from-green-500 to-emerald-600',
                    gbp: 'from-blue-500 to-cyan-600',
                    facebook: 'from-indigo-500 to-blue-600',
                    instagram: 'from-pink-500 to-rose-600'
                };
                const icons = {
                    blog: 'fa-file-alt',
                    gbp: 'fab fa-google',
                    facebook: 'fab fa-facebook',
                    instagram: 'fab fa-instagram'
                };
                const statusColors = {
                    'draft': 'bg-gray-500/20 text-gray-400',
                    'scheduled': 'bg-blue-500/20 text-blue-400',
                    'approved': 'bg-green-500/20 text-green-400',
                    'published': 'bg-emerald-500/20 text-emerald-400'
                };
                return `
                    <div class="flex items-center gap-4 p-3 glass rounded-lg">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${colors[item.type] || 'from-gray-500 to-gray-600'} flex items-center justify-center">
                            <i class="${icons[item.type] || 'fas fa-file'} text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium text-sm truncate">${item.title || item.topic || 'Untitled'}</p>
                            <p class="text-gray-400 text-xs">${item.type.charAt(0).toUpperCase() + item.type.slice(1)} ‚Ä¢ ${formatDate(item.scheduled_date)}</p>
                        </div>
                        <span class="px-2 py-1 ${statusColors[item.status] || statusColors.draft} rounded text-xs whitespace-nowrap">
                            ${item.status || 'draft'}
                        </span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function formatCalendarDate(dateStr) {
            if (!dateStr) return 'Not scheduled';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        async function autoScheduleContent() {
            if (!currentClient) return;
            
            const unscheduledBlogs = allBlogs.filter(b => !b.scheduled_for);
            const unscheduledSocial = allSocial.filter(s => !s.scheduled_for);
            
            if (unscheduledBlogs.length === 0 && unscheduledSocial.length === 0) {
                showToast('All content is already scheduled!', 'info');
                return;
            }
            
            const confirmMsg = `This will schedule:\n‚Ä¢ ${unscheduledBlogs.length} blogs (every 3 days)\n‚Ä¢ ${unscheduledSocial.length} social posts (daily)\n\nContinue?`;
            if (!confirm(confirmMsg)) return;
            
            const today = new Date();
            let blogDay = 1;
            let socialDay = 1;
            let errors = 0;
            
            // Schedule blogs
            for (const blog of unscheduledBlogs) {
                const scheduleDate = new Date(today);
                scheduleDate.setDate(scheduleDate.getDate() + (blogDay * 3));
                scheduleDate.setHours(9, 0, 0, 0);
                
                try {
                    const response = await fetch(`${API_URL}/api/content/${blog.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            status: 'scheduled',
                            scheduled_for: scheduleDate.toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        blog.status = 'scheduled';
                        blog.scheduled_for = scheduleDate.toISOString();
                        blogDay++;
                    } else {
                        errors++;
                    }
                } catch (e) {
                    errors++;
                }
            }
            
            // Schedule social posts
            for (const post of unscheduledSocial) {
                const scheduleDate = new Date(today);
                scheduleDate.setDate(scheduleDate.getDate() + socialDay);
                scheduleDate.setHours(10, 0, 0, 0);
                
                try {
                    const response = await fetch(`${API_URL}/api/social/${post.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            status: 'scheduled',
                            scheduled_for: scheduleDate.toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        post.status = 'scheduled';
                        post.scheduled_for = scheduleDate.toISOString();
                        socialDay++;
                    } else {
                        errors++;
                    }
                } catch (e) {
                    errors++;
                }
            }
            
            renderCalendar();
            renderBlogs();
            renderSocial();
            
            if (errors > 0) {
                alert(`Scheduled ${blogDay - 1} blogs and ${socialDay - 1} social posts.\n${errors} items failed.`);
            } else {
                alert(`‚úì Scheduled ${blogDay - 1} blogs and ${socialDay - 1} social posts!`);
            }
        }
        
        // Legacy function name
        function autoSchedule() {
            autoScheduleContent();
        }
        
        function showDateContent(dateStr) {
            const items = scheduledContent.filter(c => c.scheduled_date === dateStr);
            if (items.length === 0) {
                alert(`No content scheduled for ${formatDate(dateStr)}\n\nClick on a blog or social post to schedule it.`);
                return;
            }
            
            const content = items.map(i => `‚Ä¢ ${i.type}: ${i.title || i.topic}`).join('\n');
            alert(`Content for ${formatDate(dateStr)}:\n\n${content}`);
        }

        // ==========================================
        // BLOGS
        // ==========================================
        let bulkSelectMode = false;
        let selectedBlogs = new Set();
        
        function toggleBulkSelect() {
            bulkSelectMode = !bulkSelectMode;
            selectedBlogs.clear();
            
            if (bulkSelectMode) {
                document.getElementById('bulkActionBar').classList.remove('hidden');
                document.getElementById('bulkSelectBtn').innerHTML = '<i class="fas fa-times mr-1"></i>Cancel Select';
                document.getElementById('bulkSelectBtn').className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm transition';
            } else {
                document.getElementById('bulkActionBar').classList.add('hidden');
                document.getElementById('bulkSelectBtn').innerHTML = '<i class="fas fa-check-square mr-1"></i>Bulk Select';
                document.getElementById('bulkSelectBtn').className = 'px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm transition';
            }
            
            updateSelectedCount();
            renderBlogs();
        }
        
        function cancelBulkSelect() {
            bulkSelectMode = false;
            selectedBlogs.clear();
            document.getElementById('bulkActionBar').classList.add('hidden');
            document.getElementById('bulkSelectBtn').innerHTML = '<i class="fas fa-check-square mr-1"></i>Bulk Select';
            document.getElementById('bulkSelectBtn').className = 'px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm transition';
            renderBlogs();
        }
        
        function toggleBlogSelect(blogId, event) {
            if (event) event.stopPropagation();
            
            if (selectedBlogs.has(blogId)) {
                selectedBlogs.delete(blogId);
            } else {
                selectedBlogs.add(blogId);
            }
            updateSelectedCount();
        }
        
        function toggleSelectAllBlogs() {
            const selectAll = document.getElementById('selectAllBlogs').checked;
            
            if (selectAll) {
                allBlogs.forEach(b => selectedBlogs.add(b.id));
            } else {
                selectedBlogs.clear();
            }
            
            updateSelectedCount();
            renderBlogs();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedBlogs.size;
            document.getElementById('selectAllBlogs').checked = selectedBlogs.size === allBlogs.length && allBlogs.length > 0;
        }
        
        async function bulkApproveBlogs() {
            if (selectedBlogs.size === 0) {
                showToast('No blogs selected', 'warning');
                return;
            }
            
            if (!confirm(`Approve ${selectedBlogs.size} blogs?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/bulk-approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ ids: Array.from(selectedBlogs) })
                });
                
                const result = await response.json();
                
                // Update local data
                selectedBlogs.forEach(id => {
                    const blog = allBlogs.find(b => b.id === id);
                    if (blog) blog.status = 'approved';
                });
                
                showToast(`${result.approved} blogs approved`, 'success');
                cancelBulkSelect();
                renderBlogs();
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function bulkDeleteBlogs() {
            if (selectedBlogs.size === 0) {
                showToast('No blogs selected', 'warning');
                return;
            }
            
            if (!confirm(`Delete ${selectedBlogs.size} blogs?\n\nThis action cannot be undone.`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/bulk-delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ ids: Array.from(selectedBlogs) })
                });
                
                const result = await response.json();
                
                // Remove from local data
                allBlogs = allBlogs.filter(b => !selectedBlogs.has(b.id));
                
                showToast(`${result.deleted} blogs deleted`, 'success');
                cancelBulkSelect();
                renderBlogs();
                updateStats();
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        function renderBlogs(filteredBlogs = null) {
            const container = document.getElementById('blogsList');
            const blogsToRender = filteredBlogs || allBlogs;

            if (blogsToRender.length === 0) {
                const hasFilters = document.getElementById('blogSearchInput')?.value || document.getElementById('blogStatusFilter')?.value;
                container.innerHTML = `
                    <div class="glass rounded-xl p-12 text-center">
                        <i class="fas fa-${hasFilters ? 'search' : 'file-alt'} text-4xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400">${hasFilters ? 'No blogs match your filters' : 'No blog posts yet'}</p>
                        ${hasFilters ? '<button onclick="clearBlogFilters()" class="mt-3 text-purple-400 hover:text-purple-300 text-sm">Clear filters</button>' : ''}
                    </div>
                `;
                return;
            }

            container.innerHTML = blogsToRender.map(blog => {
                const statusColors = {
                    'draft': 'bg-gray-500/20 text-gray-300',
                    'scheduled': 'bg-blue-500/20 text-blue-300',
                    'approved': 'bg-green-500/20 text-green-300',
                    'published': 'bg-emerald-500/20 text-emerald-300'
                };
                const scheduledInfo = blog.scheduled_for 
                    ? `<span class="text-blue-400 text-xs"><i class="fas fa-calendar mr-1"></i>${new Date(blog.scheduled_for).toLocaleDateString()}</span>` 
                    : '';
                
                const isSelected = selectedBlogs.has(blog.id);
                const checkbox = bulkSelectMode 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onclick="toggleBlogSelect('${blog.id}', event)" class="w-5 h-5 rounded mr-3 flex-shrink-0">`
                    : '';
                
                // Featured image thumbnail
                const featuredImage = blog.featured_image_url 
                    ? `<div class="w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 bg-white/5">
                         <img src="${blog.featured_image_url}" alt="" class="w-full h-full object-cover">
                       </div>`
                    : '';
                
                // SEO Score badge
                const seoScore = blog.seo_score || 0;
                const seoScoreColor = seoScore >= 80 ? 'text-green-400 bg-green-500/20' : 
                                      seoScore >= 60 ? 'text-yellow-400 bg-yellow-500/20' : 
                                      seoScore >= 40 ? 'text-orange-400 bg-orange-500/20' : 'text-red-400 bg-red-500/20';
                const seoScoreBadge = seoScore > 0 
                    ? `<span class="px-2 py-1 ${seoScoreColor} rounded text-xs font-bold" title="SEO Score">
                         <i class="fas fa-chart-line mr-1"></i>${seoScore}
                       </span>` 
                    : '';
                
                return `
                <div class="content-card glass rounded-xl p-6 ${isSelected ? 'ring-2 ring-purple-500' : ''}" data-blog-id="${blog.id}">
                    <div class="flex items-start gap-4">
                        ${checkbox}
                        ${featuredImage}
                        <div class="flex-1 cursor-pointer" onclick="${bulkSelectMode ? `toggleBlogSelect('${blog.id}')` : `openBlogModal('${blog.id}')`}">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs font-medium">
                                    ${blog.primary_keyword || 'Blog'}
                                </span>
                                <span class="px-2 py-1 ${statusColors[blog.status] || statusColors.draft} rounded text-xs">
                                    ${blog.status || 'draft'}
                                </span>
                                ${seoScoreBadge}
                                ${scheduledInfo}
                                ${blog.featured_image_url ? '<span class="text-amber-400 text-xs"><i class="fas fa-image"></i></span>' : ''}
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">${blog.title || 'Untitled'}</h3>
                            <p class="text-gray-400 text-sm line-clamp-2">${blog.meta_description || ''}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold gradient-text">${blog.word_count || 0}</p>
                            <p class="text-xs text-gray-500">words</p>
                        </div>
                    </div>
                    ${!bulkSelectMode ? `
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-white/10">
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span><i class="fas fa-link mr-1"></i>${countInternalLinks(blog.body)} links</span>
                            <span><i class="fas fa-question-circle mr-1"></i>${blog.faq_content?.length || 0} FAQs</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); openBlogModal('${blog.id}')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="event.stopPropagation(); quickEditBlog('${blog.id}')" class="p-2 text-gray-400 hover:text-blue-400 hover:bg-blue-500/10 rounded-lg transition" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); quickDeleteBlog('${blog.id}', '${(blog.title || '').replace(/'/g, "\\'")}')" class="p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }
        
        function filterBlogs() {
            const searchTerm = document.getElementById('blogSearchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('blogStatusFilter')?.value || '';
            
            let filtered = allBlogs;
            
            if (searchTerm) {
                filtered = filtered.filter(blog => 
                    (blog.title || '').toLowerCase().includes(searchTerm) ||
                    (blog.primary_keyword || '').toLowerCase().includes(searchTerm) ||
                    (blog.meta_title || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(blog => blog.status === statusFilter);
            }
            
            renderBlogs(filtered);
        }
        
        function clearBlogFilters() {
            const searchInput = document.getElementById('blogSearchInput');
            const statusFilter = document.getElementById('blogStatusFilter');
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            renderBlogs();
        }
        
        function quickEditBlog(blogId) {
            openBlogModal(blogId);
            // Wait for modal to open then enter edit mode
            setTimeout(() => enterEditMode(), 100);
        }
        
        function quickDeleteBlog(blogId, title) {
            if (confirm(`Delete "${title}"?\n\nThis action cannot be undone.`)) {
                deleteBlogById(blogId);
            }
        }
        
        async function deleteBlogById(blogId) {
            try {
                const response = await fetch(`${API_URL}/api/content/${blogId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                allBlogs = allBlogs.filter(b => b.id !== blogId);
                renderBlogs();
                updateStats();
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        function countInternalLinks(body) {
            if (!body) return 0;
            const matches = body.match(/<a[^>]*href=[^>]*>/gi);
            return matches ? matches.length : 0;
        }
        
        function calculateSEOScore(blog) {
            if (!blog) return { score: 0, checks: {} };
            
            const checks = {};
            let score = 0;
            
            // Word count (20 points) - target 800+ for pass, ideal 1200+
            const wordCount = blog.word_count || 0;
            checks.wordCount = wordCount >= 800;  // More reasonable threshold
            if (wordCount >= 1800) score += 20;
            else if (wordCount >= 1500) score += 17;
            else if (wordCount >= 1200) score += 14;
            else if (wordCount >= 800) score += 10;
            else if (wordCount >= 500) score += 5;
            
            // Keyword density (15 points) - target 1-2%
            const body = blog.body || '';
            const bodyText = body.replace(/<[^>]*>/g, '').toLowerCase();
            const keyword = (blog.primary_keyword || '').toLowerCase();
            if (keyword && bodyText) {
                const keywordCount = (bodyText.match(new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
                const totalWords = bodyText.split(/\s+/).filter(w => w.length > 0).length;
                const density = totalWords > 0 ? (keywordCount / totalWords) * 100 : 0;
                checks.keywordDensity = density >= 0.5 && density <= 3;
                if (density >= 1 && density <= 2) score += 15;
                else if (density >= 0.5 && density <= 3) score += 10;
                else if (density > 0) score += 5;
            } else {
                checks.keywordDensity = false;
            }
            
            // Internal links (15 points) - target 1+ for pass, ideal 3+
            const linkCount = countInternalLinks(body);
            checks.internalLinks = linkCount >= 1;  // At least 1 link
            if (linkCount >= 6) score += 15;
            else if (linkCount >= 4) score += 12;
            else if (linkCount >= 2) score += 8;
            else if (linkCount >= 1) score += 5;
            
            // Meta title (15 points) - target 40-65 chars (more flexible)
            const metaTitle = blog.meta_title || '';
            const titleLen = metaTitle.length;
            const titleHasKeyword = keyword && metaTitle.toLowerCase().includes(keyword);
            checks.metaTitle = titleLen >= 40 && titleLen <= 65;  // More flexible range
            if (titleLen >= 50 && titleLen <= 60) score += 8;
            else if (titleLen >= 40 && titleLen <= 65) score += 6;
            else if (titleLen >= 30 && titleLen <= 70) score += 4;
            if (titleHasKeyword) score += 7;
            
            // Meta description (15 points) - target 120-165 chars (more flexible)
            const metaDesc = blog.meta_description || '';
            const descLen = metaDesc.length;
            const descHasKeyword = keyword && metaDesc.toLowerCase().includes(keyword);
            checks.metaDesc = descLen >= 120 && descLen <= 165;  // More flexible range
            if (descLen >= 150 && descLen <= 160) score += 8;
            else if (descLen >= 120 && descLen <= 165) score += 6;
            else if (descLen >= 100 && descLen <= 180) score += 4;
            if (descHasKeyword) score += 7;
            
            // Heading structure (20 points) - H2s and H3s with location
            const h2Count = (body.match(/<h2/gi) || []).length;
            const h3Count = (body.match(/<h3/gi) || []).length;
            checks.headings = h2Count >= 4 && h3Count >= 3;
            if (h2Count >= 5) score += 10;
            else if (h2Count >= 4) score += 8;
            else if (h2Count >= 3) score += 6;
            else if (h2Count >= 2) score += 4;
            if (h3Count >= 4) score += 10;
            else if (h3Count >= 3) score += 8;
            else if (h3Count >= 2) score += 6;
            else if (h3Count >= 1) score += 3;
            
            return { score: Math.min(100, score), checks };
        }
        
        function updateSEOScoreDisplay(seoResult) {
            const { score, checks } = seoResult;
            
            // Update score value and bar
            const scoreValueEl = document.getElementById('seoScoreValue');
            const scoreBarEl = document.getElementById('seoScoreBar');
            
            if (scoreValueEl) scoreValueEl.textContent = score;
            if (scoreBarEl) scoreBarEl.style.width = `${score}%`;
            
            // Update color based on score
            const scoreEl = document.getElementById('seoScoreValue');
            const barEl = document.getElementById('seoScoreBar');
            if (scoreEl && barEl) {
                if (score >= 80) {
                    scoreEl.className = 'text-3xl font-bold text-green-400';
                    barEl.className = 'bg-gradient-to-r from-green-500 to-emerald-400 h-2 rounded-full transition-all';
                } else if (score >= 60) {
                    scoreEl.className = 'text-3xl font-bold text-yellow-400';
                    barEl.className = 'bg-gradient-to-r from-yellow-500 to-orange-400 h-2 rounded-full transition-all';
                } else {
                    scoreEl.className = 'text-3xl font-bold text-red-400';
                    barEl.className = 'bg-gradient-to-r from-red-500 to-orange-400 h-2 rounded-full transition-all';
                }
            }
            
            // Update check indicators
            const updateCheck = (id, passed) => {
                const el = document.getElementById(id);
                if (!el) return;
                const icon = el.querySelector('i');
                if (!icon) return;
                if (passed) {
                    icon.className = 'fas fa-check-circle text-green-400';
                } else {
                    icon.className = 'fas fa-times-circle text-red-400';
                }
            };
            
            updateCheck('seoWordCount', checks.wordCount);
            updateCheck('seoKeywordDensity', checks.keywordDensity);
            updateCheck('seoInternalLinks', checks.internalLinks);
            updateCheck('seoMetaTitle', checks.metaTitle);
            updateCheck('seoMetaDesc', checks.metaDesc);
            updateCheck('seoHeadings', checks.headings);
        }

        let currentBlog = null;

        function openBlogModal(blogId) {
            currentBlog = allBlogs.find(b => b.id === blogId);
            if (!currentBlog) return;

            document.getElementById('modalKeyword').textContent = currentBlog.primary_keyword || '';
            document.getElementById('modalTitle').textContent = currentBlog.title || 'Untitled';
            document.getElementById('modalWordCount').textContent = currentBlog.word_count || 0;
            document.getElementById('modalLinkCount').textContent = countInternalLinks(currentBlog.body);
            document.getElementById('modalStatus').textContent = currentBlog.status || 'draft';
            document.getElementById('modalMetaTitle').textContent = currentBlog.meta_title || '';
            document.getElementById('modalMetaDesc').textContent = currentBlog.meta_description || '';
            document.getElementById('modalBody').innerHTML = DOMPurify.sanitize(currentBlog.body || '');
            
            // Featured Image
            const imagePreview = document.getElementById('featuredImagePreview');
            const imageEmpty = document.getElementById('featuredImageEmpty');
            const imageLoading = document.getElementById('featuredImageLoading');
            
            imageLoading.classList.add('hidden');
            
            if (currentBlog.featured_image_url) {
                document.getElementById('modalFeaturedImage').src = currentBlog.featured_image_url;
                imagePreview.classList.remove('hidden');
                imageEmpty.classList.add('hidden');
            } else {
                imagePreview.classList.add('hidden');
                imageEmpty.classList.remove('hidden');
            }
            
            // Use database SEO score if available, otherwise calculate
            let seoResult;
            if (currentBlog.seo_score && currentBlog.seo_score > 0) {
                // Use stored score from database but still check factors for display
                const checks = {
                    wordCount: (currentBlog.word_count || 0) >= 800,
                    keywordDensity: true, // Assume passed if score stored
                    internalLinks: countInternalLinks(currentBlog.body || '') >= 1,
                    metaTitle: (currentBlog.meta_title || '').length >= 40 && (currentBlog.meta_title || '').length <= 70,
                    metaDesc: (currentBlog.meta_description || '').length >= 100 && (currentBlog.meta_description || '').length <= 180,
                    headings: (currentBlog.body || '').match(/<h2/gi)?.length >= 3
                };
                seoResult = { score: currentBlog.seo_score, checks };
            } else {
                seoResult = calculateSEOScore(currentBlog);
            }
            updateSEOScoreDisplay(seoResult);

            // FAQs
            const faqSection = document.getElementById('modalFaq');
            const faqContent = document.getElementById('faqContent');
            if (currentBlog.faq_content && currentBlog.faq_content.length > 0) {
                faqSection.classList.remove('hidden');
                faqContent.innerHTML = currentBlog.faq_content.map(faq => `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="font-semibold text-gray-800 mb-2">${faq.question || faq.q || ''}</p>
                        <p class="text-gray-600">${faq.answer || faq.a || ''}</p>
                    </div>
                `).join('');
            } else {
                faqSection.classList.add('hidden');
            }

            document.getElementById('blogModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeBlogModal() {
            document.getElementById('blogModal').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        function showCurrentSERPPreview() {
            if (!currentBlog) return;
            
            const title = currentBlog.meta_title || currentBlog.title || 'Page Title';
            const description = currentBlog.meta_description || '';
            
            // Build URL, avoiding double slashes
            let baseUrl = currentClient?.website_url || 'https://example.com';
            baseUrl = baseUrl.replace(/\/+$/, ''); // Remove trailing slashes
            const slug = currentBlog.slug || currentBlog.title?.toLowerCase().replace(/[^a-z0-9]+/g, '-') || 'blog-post';
            const url = `${baseUrl}/${slug}/`;
            
            showSERPPreview(title, description, url);
        }
        
        async function generateBlogImage() {
            if (!currentBlog) return;
            
            const btn = document.getElementById('btnGenerateBlogImage');
            const imagePreview = document.getElementById('featuredImagePreview');
            const imageEmpty = document.getElementById('featuredImageEmpty');
            const imageLoading = document.getElementById('featuredImageLoading');
            
            btn.disabled = true;
            imageEmpty.classList.add('hidden');
            imagePreview.classList.add('hidden');
            imageLoading.classList.remove('hidden');
            
            try {
                // Generate image based on blog keyword/title
                const prompt = `${currentBlog.primary_keyword || currentBlog.title} - professional blog header image`;
                
                const response = await fetch(`${API_URL}/api/images/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        style: 'blog_header',
                        size: '1792x1024',
                        client_id: currentClient?.id
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.url) {
                    // Update blog with featured image
                    const updateResponse = await fetch(`${API_URL}/api/content/blog/${currentBlog.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            featured_image_url: result.url
                        })
                    });
                    
                    if (updateResponse.ok) {
                        // Update UI
                        currentBlog.featured_image_url = result.url;
                        document.getElementById('modalFeaturedImage').src = result.url;
                        imagePreview.classList.remove('hidden');
                        
                        // Update the blog in allBlogs array
                        const blogIndex = allBlogs.findIndex(b => b.id === currentBlog.id);
                        if (blogIndex >= 0) {
                            allBlogs[blogIndex].featured_image_url = result.url;
                            renderBlogs(); // Refresh the list
                        }
                    }
                } else {
                    alert('Image generation failed: ' + (result.error || 'No image providers configured'));
                    imageEmpty.classList.remove('hidden');
                }
            } catch (error) {
                alert('Error generating image: ' + error.message);
                imageEmpty.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                imageLoading.classList.add('hidden');
            }
        }
        
        async function removeFeaturedImage() {
            if (!currentBlog) return;
            
            if (!confirm('Remove the featured image from this blog post?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/blog/${currentBlog.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        featured_image_url: null
                    })
                });
                
                if (response.ok) {
                    currentBlog.featured_image_url = null;
                    document.getElementById('featuredImagePreview').classList.add('hidden');
                    document.getElementById('featuredImageEmpty').classList.remove('hidden');
                    
                    // Update the blog in allBlogs array
                    const blogIndex = allBlogs.findIndex(b => b.id === currentBlog.id);
                    if (blogIndex >= 0) {
                        allBlogs[blogIndex].featured_image_url = null;
                        renderBlogs();
                    }
                }
            } catch (error) {
                alert('Error removing image: ' + error.message);
            }
        }
        
        // ========== IMAGE PICKER FOR FEATURED IMAGES ==========
        let selectedSourceImage = null; // Store selected source image for overlay
        let pickerImages = [];
        
        async function openImagePicker() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            document.getElementById('imagePickerModal').classList.remove('hidden');
            await loadPickerImages();
        }
        
        function closeImagePicker() {
            document.getElementById('imagePickerModal').classList.add('hidden');
        }
        
        async function loadPickerImages(category = 'all') {
            const grid = document.getElementById('pickerImageGrid');
            grid.innerHTML = `<div class="col-span-full text-center py-8 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading images...</p>
            </div>`;
            
            try {
                let url = `${API_URL}/api/images/library/${currentClient.id}`;
                if (category && category !== 'all') {
                    url += `?category=${category}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                const data = await response.json();
                pickerImages = data.images || [];
                
                document.getElementById('pickerImageCount').textContent = pickerImages.length;
                
                if (pickerImages.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center py-8 text-gray-400">
                        <i class="fas fa-image text-4xl mb-2 opacity-50"></i>
                        <p>No images found</p>
                        <p class="text-xs mt-1">Upload images in the Image Library tab</p>
                    </div>`;
                    return;
                }
                
                renderPickerImages(pickerImages);
            } catch (error) {
                grid.innerHTML = `<div class="col-span-full text-center py-8 text-red-400">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p>Error loading images</p>
                </div>`;
            }
        }
        
        function renderPickerImages(images) {
            const grid = document.getElementById('pickerImageGrid');
            
            grid.innerHTML = images.map(img => `
                <div class="picker-image-item cursor-pointer group relative aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 transition-all"
                     onclick="selectPickerImage('${img.id}', '${img.file_url}')"
                     data-id="${img.id}" data-url="${img.file_url}">
                    <img src="${img.file_url}" alt="${img.alt_text || ''}" 
                         class="w-full h-full object-cover" loading="lazy"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2212%22>No Image</text></svg>'">
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <i class="fas fa-check-circle text-white text-2xl"></i>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 truncate">
                        ${img.category || 'general'}
                    </div>
                </div>
            `).join('');
        }
        
        function filterPickerImages(category) {
            // Update button styles
            document.querySelectorAll('.picker-category-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-blue-500', 'text-white', 'active');
                } else {
                    btn.classList.remove('bg-blue-500', 'text-white', 'active');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
            
            loadPickerImages(category);
        }
        
        function selectPickerImage(imageId, imageUrl) {
            selectedSourceImage = { id: imageId, url: imageUrl };
            
            // Show selected source image preview
            document.getElementById('sourceImageThumb').src = imageUrl;
            document.getElementById('sourceImagePreview').classList.remove('hidden');
            
            // Auto-fill title from blog if available
            if (currentBlog && currentBlog.title) {
                document.getElementById('featuredTitleOverlay').value = currentBlog.title;
            }
            
            closeImagePicker();
            showToast('Image selected! Now enter a title and click "Burn Title"', 'success');
        }
        
        function clearSourceImage() {
            selectedSourceImage = null;
            document.getElementById('sourceImagePreview').classList.add('hidden');
        }
        
        function toggleProBrandedOptions() {
            const template = document.getElementById('featuredOverlayTemplate').value;
            const proBrandedOptions = document.getElementById('proBrandedOptions');
            if (template === 'branded_right') {
                proBrandedOptions.classList.remove('hidden');
            } else {
                proBrandedOptions.classList.add('hidden');
            }
        }
        
        async function createFeaturedWithOverlay() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const title = document.getElementById('featuredTitleOverlay').value.trim();
            if (!title) {
                showToast('Please enter a title to overlay', 'warning');
                return;
            }
            
            if (!selectedSourceImage) {
                showToast('Please select a source image first', 'warning');
                return;
            }
            
            const template = document.getElementById('featuredOverlayTemplate').value;
            
            // Get pro branded options
            const phone = document.getElementById('featuredPhone')?.value.trim() || currentClient.phone || '';
            const ctaText = document.getElementById('featuredCTA')?.value.trim() || '';
            const logoUrl = document.getElementById('featuredLogoUrl')?.value.trim() || '';
            
            // Show loading
            document.getElementById('featuredImageLoading').classList.remove('hidden');
            document.getElementById('featuredImageEmpty').classList.add('hidden');
            
            try {
                const requestBody = {
                    title: title,
                    source_image_id: selectedSourceImage.id,
                    template: template,
                    subtitle: currentClient.geo || ''
                };
                
                // Add pro branded options if using that template
                if (template === 'branded_right') {
                    if (phone) requestBody.phone = phone;
                    if (ctaText) requestBody.cta_text = ctaText;
                    if (logoUrl) requestBody.logo_url = logoUrl;
                }
                
                const response = await fetch(`${API_URL}/api/images/featured/${currentClient.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                document.getElementById('featuredImageLoading').classList.add('hidden');
                
                if (data.success) {
                    // Show the featured image
                    document.getElementById('modalFeaturedImage').src = data.file_url;
                    document.getElementById('featuredImageDownloadLink').href = data.file_url;
                    document.getElementById('featuredImagePreview').classList.remove('hidden');
                    document.getElementById('featuredImageEmpty').classList.add('hidden');
                    
                    // Update blog with featured image
                    if (currentBlog) {
                        await updateBlogFeaturedImage(data.file_url);
                    }
                    
                    // Clear source image selection
                    clearSourceImage();
                    
                    showToast('Featured image created with title overlay!', 'success');
                } else {
                    document.getElementById('featuredImageEmpty').classList.remove('hidden');
                    showToast('Failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                document.getElementById('featuredImageLoading').classList.add('hidden');
                document.getElementById('featuredImageEmpty').classList.remove('hidden');
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function updateBlogFeaturedImage(imageUrl) {
            if (!currentBlog) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/blog/${currentBlog.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        featured_image_url: imageUrl
                    })
                });
                
                if (response.ok) {
                    currentBlog.featured_image_url = imageUrl;
                    
                    // Update the blog in allBlogs array
                    const blogIndex = allBlogs.findIndex(b => b.id === currentBlog.id);
                    if (blogIndex >= 0) {
                        allBlogs[blogIndex].featured_image_url = imageUrl;
                        renderBlogs();
                    }
                }
            } catch (error) {
                console.error('Error updating blog featured image:', error);
            }
        }
        // ========== END IMAGE PICKER ==========

        function copyBlogContent() {
            if (!currentBlog) return;
            const content = `${currentBlog.title}\n\n${currentBlog.body?.replace(/<[^>]*>/g, '')}`;
            navigator.clipboard.writeText(content);
            showToast('Content copied to clipboard!', 'success');
        }

        function downloadBlog() {
            if (!currentBlog) return;
            const content = `# ${currentBlog.title}\n\n${currentBlog.body?.replace(/<[^>]*>/g, '')}`;
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBlog.title?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'blog'}.md`;
            a.click();
        }
        
        // Helper to escape HTML attributes
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;')
                     .replace(/"/g, '&quot;')
                     .replace(/'/g, '&#39;');
        }
        
        function downloadBlogHTML() {
            if (!currentBlog) return;
            
            const safeTitle = escapeHtml(currentBlog.meta_title || currentBlog.title);
            const safeDesc = escapeHtml(currentBlog.meta_description || '');
            
            const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${safeTitle}</title>
    <meta name="description" content="${safeDesc}">
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; line-height: 1.6; color: #333; }
        h1 { color: #1a1a1a; margin-bottom: 0.5rem; }
        h2 { color: #2a2a2a; margin-top: 2rem; }
        h3 { color: #3a3a3a; margin-top: 1.5rem; }
        a { color: #6366f1; }
        .meta { color: #666; font-size: 0.9rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
        .faq { background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 2rem; }
        .faq h3 { margin-top: 0; }
        .faq-item { margin-bottom: 1rem; }
        .faq-q { font-weight: 600; color: #1a1a1a; }
        .faq-a { color: #4a4a4a; margin-top: 0.25rem; }
    </style>
</head>
<body>
    <article>
        <h1>${currentBlog.title}</h1>
        <div class="meta">
            <strong>Keyword:</strong> ${escapeHtml(currentBlog.primary_keyword || '')} | 
            <strong>Words:</strong> ${currentBlog.word_count || 0}
        </div>
        ${currentBlog.body || ''}
        ${currentBlog.faq_content?.length > 0 ? `
        <div class="faq">
            <h3>Frequently Asked Questions</h3>
            ${currentBlog.faq_content.map(faq => `
            <div class="faq-item">
                <p class="faq-q">${escapeHtml(faq.question || faq.q)}</p>
                <p class="faq-a">${escapeHtml(faq.answer || faq.a)}</p>
            </div>
            `).join('')}
        </div>
        ` : ''}
    </article>
</body>
</html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBlog.title?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'blog'}.html`;
            a.click();
        }
        
        function downloadBlogWord() {
            if (!currentBlog) return;
            
            // Create Word-compatible HTML
            const safeTitle = escapeHtml(currentBlog.title);
            const safeKeyword = escapeHtml(currentBlog.primary_keyword || '');
            const safeMetaTitle = escapeHtml(currentBlog.meta_title || '');
            const safeMetaDesc = escapeHtml(currentBlog.meta_description || '');
            
            const wordDoc = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
<head>
    <meta charset="UTF-8">
    <title>${safeTitle}</title>
    <style>
        body { font-family: Calibri, sans-serif; font-size: 11pt; line-height: 1.5; }
        h1 { font-size: 24pt; color: #1a1a1a; margin-bottom: 12pt; }
        h2 { font-size: 16pt; color: #2a2a2a; margin-top: 18pt; margin-bottom: 6pt; }
        h3 { font-size: 13pt; color: #3a3a3a; margin-top: 12pt; margin-bottom: 6pt; }
        p { margin-bottom: 10pt; }
        a { color: #0563C1; }
        .meta { color: #666; font-size: 10pt; border-bottom: 1pt solid #ccc; padding-bottom: 12pt; margin-bottom: 18pt; }
        .faq { background: #f5f5f5; padding: 12pt; margin-top: 24pt; }
        .faq-q { font-weight: bold; margin-bottom: 3pt; }
        .faq-a { margin-bottom: 12pt; color: #444; }
    </style>
</head>
<body>
    <h1>${safeTitle}</h1>
    <div class="meta">
        <b>Target Keyword:</b> ${safeKeyword}<br>
        <b>Meta Title:</b> ${safeMetaTitle}<br>
        <b>Meta Description:</b> ${safeMetaDesc}<br>
        <b>Word Count:</b> ${currentBlog.word_count || 0}
    </div>
    ${currentBlog.body || ''}
    ${currentBlog.faq_content?.length > 0 ? `
    <div class="faq">
        <h2>Frequently Asked Questions</h2>
        ${currentBlog.faq_content.map(faq => `
        <p class="faq-q">${escapeHtml(faq.question || faq.q)}</p>
        <p class="faq-a">${escapeHtml(faq.answer || faq.a)}</p>
        `).join('')}
    </div>
    ` : ''}
</body>
</html>`;
            
            const blob = new Blob([wordDoc], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBlog.title?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'blog'}.doc`;
            a.click();
        }
        
        // ==========================================
        // BLOG EDIT/DELETE/SCHEDULE
        // ==========================================
        let isEditMode = false;
        
        function enterEditMode() {
            if (!currentBlog) return;
            isEditMode = true;
            
            // Show edit fields, hide view fields
            document.getElementById('modalTitle').classList.add('hidden');
            document.getElementById('modalTitleEdit').classList.remove('hidden');
            document.getElementById('modalTitleEdit').value = currentBlog.title || '';
            
            document.getElementById('metaViewMode').classList.add('hidden');
            document.getElementById('metaEditMode').classList.remove('hidden');
            document.getElementById('modalMetaTitleEdit').value = currentBlog.meta_title || '';
            document.getElementById('modalMetaDescEdit').value = currentBlog.meta_description || '';
            updateMetaCounts();
            
            document.getElementById('modalBody').classList.add('hidden');
            document.getElementById('bodyEditMode').classList.remove('hidden');
            document.getElementById('modalBodyEdit').value = currentBlog.body || '';
            updateEditWordCount();
            
            document.getElementById('footerViewMode').classList.add('hidden');
            document.getElementById('footerEditMode').classList.remove('hidden');
            
            // Hide SEO card in edit mode
            document.getElementById('seoScoreCard').classList.add('hidden');
        }
        
        function cancelEditMode() {
            isEditMode = false;
            
            // Restore view mode
            document.getElementById('modalTitle').classList.remove('hidden');
            document.getElementById('modalTitleEdit').classList.add('hidden');
            
            document.getElementById('metaViewMode').classList.remove('hidden');
            document.getElementById('metaEditMode').classList.add('hidden');
            
            document.getElementById('modalBody').classList.remove('hidden');
            document.getElementById('bodyEditMode').classList.add('hidden');
            
            document.getElementById('footerViewMode').classList.remove('hidden');
            document.getElementById('footerEditMode').classList.add('hidden');
            
            document.getElementById('seoScoreCard').classList.remove('hidden');
        }
        
        function updateMetaCounts() {
            const titleLen = document.getElementById('modalMetaTitleEdit').value.length;
            const descLen = document.getElementById('modalMetaDescEdit').value.length;
            document.getElementById('metaTitleCount').textContent = `(${titleLen}/60)`;
            document.getElementById('metaDescCount').textContent = `(${descLen}/160)`;
            document.getElementById('metaTitleCount').className = titleLen > 60 ? 'text-xs text-red-500' : 'text-xs text-gray-500';
            document.getElementById('metaDescCount').className = descLen > 160 ? 'text-xs text-red-500' : 'text-xs text-gray-500';
        }
        
        function updateEditWordCount() {
            const text = document.getElementById('modalBodyEdit').value.replace(/<[^>]*>/g, ' ');
            const words = text.split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('editWordCount').textContent = words.toLocaleString();
        }
        
        // Add event listeners for edit fields
        document.addEventListener('DOMContentLoaded', function() {
            const metaTitle = document.getElementById('modalMetaTitleEdit');
            const metaDesc = document.getElementById('modalMetaDescEdit');
            const bodyEdit = document.getElementById('modalBodyEdit');
            
            if (metaTitle) metaTitle.addEventListener('input', updateMetaCounts);
            if (metaDesc) metaDesc.addEventListener('input', updateMetaCounts);
            if (bodyEdit) bodyEdit.addEventListener('input', updateEditWordCount);
        });
        
        async function saveBlogEdits() {
            if (!currentBlog) return;
            
            const newTitle = document.getElementById('modalTitleEdit').value.trim();
            const newMetaTitle = document.getElementById('modalMetaTitleEdit').value.trim();
            const newMetaDesc = document.getElementById('modalMetaDescEdit').value.trim();
            const newBody = document.getElementById('modalBodyEdit').value;
            
            if (!newTitle) {
                showToast('Title is required', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        title: newTitle,
                        meta_title: newMetaTitle,
                        meta_description: newMetaDesc,
                        body: newBody
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save');
                }
                
                const result = await response.json();
                
                // Update local data
                const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                if (idx !== -1) {
                    allBlogs[idx] = result.content;
                }
                currentBlog = result.content;
                
                // Exit edit mode and refresh display
                cancelEditMode();
                
                // Update modal display
                document.getElementById('modalTitle').textContent = currentBlog.title;
                document.getElementById('modalMetaTitle').textContent = currentBlog.meta_title || '';
                document.getElementById('modalMetaDesc').textContent = currentBlog.meta_description || '';
                document.getElementById('modalBody').innerHTML = DOMPurify.sanitize(currentBlog.body || '');
                document.getElementById('modalWordCount').textContent = currentBlog.word_count || 0;
                
                // Recalculate SEO score
                calculateSEOScore(currentBlog);
                
                // Refresh blog list
                renderBlogs();
                
                alert('‚úì Blog saved successfully!');
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        function confirmDeleteBlog() {
            if (!currentBlog) return;
            
            if (confirm(`Are you sure you want to delete "${currentBlog.title}"?\n\nThis action cannot be undone.`)) {
                deleteBlog();
            }
        }
        
        async function deleteBlog() {
            if (!currentBlog) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                // Remove from local array
                allBlogs = allBlogs.filter(b => b.id !== currentBlog.id);
                
                // Close modal and refresh
                closeBlogModal();
                renderBlogs();
                updateStats();
                
                alert('‚úì Blog deleted successfully');
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function approveBlog() {
            if (!currentBlog) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        status: 'approved'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to approve');
                }
                
                const result = await response.json();
                
                // Update local data
                const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                if (idx !== -1) {
                    allBlogs[idx].status = 'approved';
                }
                currentBlog.status = 'approved';
                
                // Update modal status display
                document.getElementById('modalStatus').textContent = 'Approved';
                document.getElementById('modalStatus').className = 'px-2 py-1 bg-green-500/30 text-green-300 rounded';
                
                // Refresh blog list
                renderBlogs();
                
                alert('‚úì Blog approved!');
                
            } catch (error) {
                console.error('Approve error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function publishToWordPress() {
            if (!currentBlog) return;
            
            // Check if WordPress is configured (all 3 fields required)
            const wpUrl = currentClient?.wordpress_url;
            const wpUser = currentClient?.wordpress_user;
            const wpPass = currentClient?.wordpress_app_password;
            
            if (!wpUrl || !wpUser || !wpPass) {
                const missing = [];
                if (!wpUrl) missing.push('WordPress URL');
                if (!wpUser) missing.push('Username');
                if (!wpPass) missing.push('App Password');
                
                alert(`WordPress not configured for this client.\n\nMissing: ${missing.join(', ')}\n\nGo to Edit Client ‚Üí Integrations to add your WordPress credentials.`);
                return;
            }
            
            const status = currentBlog.status === 'approved' || currentBlog.status === 'published' 
                ? 'publish' 
                : 'draft';
            
            const confirmMsg = status === 'publish'
                ? `Publish "${currentBlog.title}" to WordPress?\n\nThis will publish the blog immediately on your WordPress site.`
                : `Save "${currentBlog.title}" as draft on WordPress?\n\nApprove the blog first to publish it directly.`;
            
            if (!confirm(confirmMsg)) return;
            
            // Find the WordPress button and show loading state
            const wpButtons = document.querySelectorAll('[onclick*="publishToWordPress"]');
            wpButtons.forEach(btn => setButtonLoading(btn, true, 'Publishing...'));
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}/publish-wordpress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local data
                    if (result.post_id) {
                        currentBlog.wordpress_post_id = result.post_id;
                        const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                        if (idx !== -1) {
                            allBlogs[idx].wordpress_post_id = result.post_id;
                            if (result.blog_status) {
                                allBlogs[idx].status = result.blog_status;
                            }
                        }
                    }
                    
                    let msg = `‚úì ${result.message}`;
                    if (result.post_url) {
                        msg += `\n\nView post: ${result.post_url}`;
                    }
                    alert(msg);
                    
                    // Update status if published
                    if (status === 'publish') {
                        document.getElementById('modalStatus').textContent = 'Published';
                        document.getElementById('modalStatus').className = 'px-2 py-1 bg-emerald-500/30 text-emerald-300 rounded';
                        currentBlog.status = 'published';
                        renderBlogs();
                    }
                    
                } else {
                    alert(`‚ùå WordPress Error: ${result.message}`);
                }
                
            } catch (error) {
                console.error('WordPress publish error:', error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                // Reset loading state
                const wpButtons = document.querySelectorAll('[onclick*="publishToWordPress"]');
                wpButtons.forEach(btn => setButtonLoading(btn, false));
            }
        }
        
        // Schedule Modal
        function showScheduleModal() {
            if (!currentBlog) return;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('scheduleTime').value = '09:00';
            
            document.getElementById('scheduleModal').classList.remove('hidden');
        }
        
        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
        }
        
        async function saveSchedule() {
            if (!currentBlog) return;
            
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const scheduledFor = new Date(`${date}T${time || '09:00'}:00`);
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        status: 'scheduled',
                        scheduled_for: scheduledFor.toISOString()
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to schedule');
                }
                
                // Update local data
                const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                if (idx !== -1) {
                    allBlogs[idx].status = 'scheduled';
                    allBlogs[idx].scheduled_for = scheduledFor.toISOString();
                }
                currentBlog.status = 'scheduled';
                currentBlog.scheduled_for = scheduledFor.toISOString();
                
                closeScheduleModal();
                
                // Update modal status
                document.getElementById('modalStatus').textContent = `Scheduled: ${scheduledFor.toLocaleDateString()}`;
                document.getElementById('modalStatus').className = 'px-2 py-1 bg-blue-500/30 text-blue-300 rounded';
                
                renderBlogs();
                renderCalendar();
                
                alert(`‚úì Scheduled for ${scheduledFor.toLocaleDateString()} at ${scheduledFor.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`);
                
            } catch (error) {
                console.error('Schedule error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        // Legacy function for backwards compatibility
        function publishBlog() {
            approveBlog();
        }

        // ==========================================
        // SOCIAL
        // ==========================================
        let socialFilter = 'all';

        function renderSocial() {
            const container = document.getElementById('socialList');

            // Update counts
            document.getElementById('countAll').textContent = allSocial.length;
            document.getElementById('countGbp').textContent = allSocial.filter(s => s.platform === 'gbp').length;
            document.getElementById('countFacebook').textContent = allSocial.filter(s => s.platform === 'facebook').length;

            const filtered = socialFilter === 'all' ? allSocial : allSocial.filter(s => s.platform === socialFilter);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="glass rounded-xl p-12 text-center col-span-2">
                        <i class="fas fa-share-alt text-4xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400">No social posts yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(post => {
                const statusColors = {
                    'draft': 'bg-gray-500/20 text-gray-300',
                    'scheduled': 'bg-blue-500/20 text-blue-300',
                    'approved': 'bg-green-500/20 text-green-300',
                    'published': 'bg-emerald-500/20 text-emerald-300'
                };
                const scheduledInfo = post.scheduled_for 
                    ? `<span class="text-xs text-blue-400"><i class="fas fa-calendar mr-1"></i>${new Date(post.scheduled_for).toLocaleDateString()}</span>` 
                    : '';
                
                // Show publish button only for draft/approved posts
                const showPublish = post.status !== 'published';
                
                return `
                <div class="glass rounded-xl p-4 social-${post.platform}">
                    <div class="flex items-center gap-2 mb-3">
                        ${getPlatformIcon(post.platform)}
                        <span class="text-sm font-medium text-white">${getPlatformName(post.platform)}</span>
                        <span class="ml-auto px-2 py-1 ${statusColors[post.status] || statusColors.draft} rounded text-xs">
                            ${post.status || 'draft'}
                        </span>
                    </div>
                    <p class="text-gray-300 text-sm mb-3">${post.content || ''}</p>
                    ${post.hashtags?.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${post.hashtags.map(h => `<span class="text-xs text-purple-400">#${h}</span>`).join(' ')}
                        </div>
                    ` : ''}
                    <div class="flex items-center justify-between pt-3 border-t border-white/10">
                        ${scheduledInfo}
                        <div class="flex items-center gap-1 ml-auto">
                            ${showPublish ? `
                            <button onclick="publishSocialPost('${post.id}', '${post.platform}')" 
                                    class="px-2 py-1 text-xs bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded hover:opacity-90 transition" 
                                    title="Publish Now">
                                <i class="fas fa-paper-plane mr-1"></i>Publish
                            </button>
                            ` : ''}
                            <button onclick="copySocialPost('${post.id}')" class="p-1.5 text-gray-400 hover:text-white hover:bg-white/10 rounded transition" title="Copy">
                                <i class="fas fa-copy text-xs"></i>
                            </button>
                            <button onclick="deleteSocialPost('${post.id}')" class="p-1.5 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded transition" title="Delete">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        function copySocialPost(postId) {
            const post = allSocial.find(p => p.id === postId);
            if (!post) return;
            
            let text = post.content || '';
            if (post.hashtags?.length > 0) {
                text += '\n\n' + post.hashtags.map(h => '#' + h).join(' ');
            }
            
            navigator.clipboard.writeText(text);
            showToast('‚úì Copied to clipboard!', 'success');
        }
        
        async function publishSocialPost(postId, platform) {
            const post = allSocial.find(p => p.id === postId);
            if (!post) {
                showToast('Post not found', 'error');
                return;
            }
            
            if (!currentClient) {
                showToast('No client selected', 'error');
                return;
            }
            
            // Confirm before publishing
            if (!confirm(`Publish this post to ${getPlatformName(platform)}?\n\n"${post.content?.substring(0, 100)}..."`)) {
                return;
            }
            
            // Find the button and show loading
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`${API_URL}/api/social/publish-now/${currentClient.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        platforms: [platform],
                        content: post.content + (post.hashtags?.length > 0 ? '\n\n' + post.hashtags.map(h => '#' + h).join(' ') : ''),
                        image_url: post.image_url || null,
                        link_url: post.link_url || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const platformResult = result.results?.[platform] || result[platform];
                    
                    if (platformResult?.success) {
                        showToast(`‚úì Published to ${getPlatformName(platform)}!`, 'success');
                        
                        // Update post status locally
                        post.status = 'published';
                        renderSocial();
                        
                        // Also update on server
                        try {
                            await fetch(`${API_URL}/api/content/${postId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${AUTH_TOKEN}`
                                },
                                body: JSON.stringify({ status: 'published' })
                            });
                        } catch (e) {
                            console.log('Could not update post status:', e);
                        }
                    } else {
                        const error = platformResult?.error || 'Publishing failed';
                        showToast(`Failed: ${error}`, 'error');
                        
                        // Show more details if not connected
                        if (error.includes('Not connected')) {
                            alert(`‚ö†Ô∏è ${getPlatformName(platform)} is not connected.\n\nGo to Settings ‚Üí Social Connections to connect your account.`);
                        }
                    }
                } else {
                    showToast(result.error || 'Publishing failed', 'error');
                }
            } catch (error) {
                console.error('Publish error:', error);
                showToast('Error publishing: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
        
        async function deleteSocialPost(postId) {
            if (!confirm('Delete this social post?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/social/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                allSocial = allSocial.filter(s => s.id !== postId);
                renderSocial();
                updateStats();
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        function filterSocial(filter) {
            socialFilter = filter;
            ['all', 'gbp', 'facebook', 'instagram'].forEach(f => {
                const el = document.getElementById(`social-${f}`);
                if (el) {
                    el.classList.remove('border-2', 'border-purple-500');
                }
            });
            const activeEl = document.getElementById(`social-${filter}`);
            if (activeEl) {
                activeEl.classList.add('border-2', 'border-purple-500');
            }
            renderSocial();
        }

        function getPlatformIcon(platform) {
            const icons = {
                'gbp': '<i class="fab fa-google text-blue-400"></i>',
                'facebook': '<i class="fab fa-facebook text-blue-500"></i>',
                'instagram': '<i class="fab fa-instagram text-pink-500"></i>'
            };
            return icons[platform] || '<i class="fas fa-share-alt text-gray-400"></i>';
        }

        function getPlatformName(platform) {
            const names = { 'gbp': 'Google Business', 'facebook': 'Facebook', 'instagram': 'Instagram', 'linkedin': 'LinkedIn' };
            return names[platform] || platform || 'Social Post';
        }

        // ==========================================
        // SEO
        // ==========================================
        function renderSEO() {
            // Keywords
            const keywordsEl = document.getElementById('keywordsList');
            const allKeywords = [...(currentClient?.primary_keywords || []), ...(currentClient?.secondary_keywords || [])];
            keywordsEl.innerHTML = allKeywords.length > 0 
                ? allKeywords.map((k, i) => `
                    <div class="flex items-center gap-2 p-2 rounded-lg ${i < (currentClient?.primary_keywords?.length || 0) ? 'bg-purple-500/20' : 'bg-white/5'}">
                        <span class="text-sm text-gray-300">${k}</span>
                        ${i < (currentClient?.primary_keywords?.length || 0) ? '<span class="ml-auto text-xs text-purple-400">Primary</span>' : ''}
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No keywords defined</p>';

            // Competitors
            const compsEl = document.getElementById('competitorsList');
            compsEl.innerHTML = currentClient?.competitors?.length > 0
                ? currentClient.competitors.map(c => `
                    <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                        <i class="fas fa-globe text-orange-400"></i>
                        <span class="text-sm text-gray-300">${c}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No competitors defined</p>';

            // Service Pages
            const servicesEl = document.getElementById('servicePagesList');
            servicesEl.innerHTML = currentClient?.service_pages?.length > 0
                ? currentClient.service_pages.map(s => `
                    <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                        <i class="fas fa-link text-green-400"></i>
                        <div class="flex-1">
                            <span class="text-sm text-gray-300">${s.title || s.keyword}</span>
                            <span class="text-xs text-gray-500 block">${s.url}</span>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No service pages defined</p>';

            // USPs
            const uspsEl = document.getElementById('uspsList');
            uspsEl.innerHTML = currentClient?.unique_selling_points?.length > 0
                ? currentClient.unique_selling_points.map(u => `
                    <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                        <i class="fas fa-star text-yellow-400"></i>
                        <span class="text-sm text-gray-300">${u}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No USPs defined</p>';
            
            // Load competitor insights
            loadCompetitorInsights();
        }
        
        // ==========================================
        // CONTENT GENERATION
        // ==========================================
        
        function populateKeywordDropdown() {
            const select = document.getElementById('blogKeyword');
            if (!currentClient) return;
            
            select.innerHTML = '<option value="">Choose a keyword...</option>';
            
            // Add primary keywords
            if (currentClient.primary_keywords?.length > 0) {
                const primaryGroup = document.createElement('optgroup');
                primaryGroup.label = 'üéØ Primary Keywords';
                currentClient.primary_keywords.forEach(kw => {
                    const option = document.createElement('option');
                    option.value = kw;
                    option.textContent = kw;
                    primaryGroup.appendChild(option);
                });
                select.appendChild(primaryGroup);
            }
            
            // Add secondary keywords
            if (currentClient.secondary_keywords?.length > 0) {
                const secondaryGroup = document.createElement('optgroup');
                secondaryGroup.label = 'üìù Secondary Keywords';
                currentClient.secondary_keywords.forEach(kw => {
                    const option = document.createElement('option');
                    option.value = kw;
                    option.textContent = kw;
                    secondaryGroup.appendChild(option);
                });
                select.appendChild(secondaryGroup);
            }
        }
        
        async function generateBlog() {
            const keyword = document.getElementById('customBlogKeyword').value.trim() || 
                           document.getElementById('blogKeyword').value;
            
            if (!keyword) {
                alert('Please select or enter a keyword');
                return;
            }
            
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const wordCount = parseInt(document.getElementById('blogWordCount').value);
            const faqCount = parseInt(document.getElementById('blogFaqs').value);
            const generateImage = document.getElementById('blogGenerateImage').checked;
            
            const btn = document.getElementById('btnGenerateBlog');
            const progress = document.getElementById('blogProgress');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            document.getElementById('blogProgressText').textContent = 'Generating blog post (this may take 30-60 seconds)...';
            
            try {
                // Use synchronous generation endpoint
                document.getElementById('blogProgressText').textContent = 'Connecting to AI service...';
                
                const response = await fetch('/api/content/blog/generate-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        client_id: currentClient.id,
                        keyword: keyword,
                        word_count: wordCount,
                        include_faq: faqCount > 0,
                        faq_count: faqCount
                    })
                });
                
                document.getElementById('blogProgressText').textContent = 'Processing response...';
                
                // Try to parse as JSON, handle non-JSON responses
                let result;
                const responseText = await response.text();
                
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response:', responseText.substring(0, 500));
                    // Check if it's an HTML error page
                    if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                        throw new Error('Server timeout or error. Please try again with a lower word count.');
                    }
                    throw new Error('Invalid server response. Please try again.');
                }
                
                if (!response.ok || result.error) {
                    throw new Error(result.error || `Server error: ${response.status}`);
                }
                
                const blogId = result.blog_id;
                const blogTitle = result.title || keyword;
                
                document.getElementById('blogProgressText').textContent = '‚úì Blog generated!';
                
                // Generate featured image if enabled
                if (generateImage && blogId) {
                    document.getElementById('blogProgressText').textContent = '‚úì Blog created! Generating featured image...';
                    
                    try {
                        const imageResponse = await fetch(`${API_URL}/api/images/generate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${AUTH_TOKEN}`
                            },
                            body: JSON.stringify({
                                prompt: `${keyword} - professional blog header image for ${currentClient.business_name || 'business'}`,
                                style: 'blog_header',
                                size: '1792x1024',
                                client_id: currentClient.id
                            })
                        });
                        
                        const imageResult = await imageResponse.json();
                        
                        if (imageResult.success && imageResult.url) {
                            await fetch(`${API_URL}/api/content/blog/${blogId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${AUTH_TOKEN}`
                                },
                                body: JSON.stringify({
                                    featured_image_url: imageResult.url
                                })
                            });
                        }
                    } catch (imgError) {
                        console.warn('Image generation failed:', imgError);
                    }
                }
                
                // Refresh the blogs list
                setTimeout(() => {
                    progress.classList.add('hidden');
                    loadClient(currentClient.id);
                    showTab('blogs');
                    showToast(`Blog post "${blogTitle}" generated successfully!`, 'success');
                }, 500);
                
            } catch (error) {
                console.error('Blog generation error:', error);
                document.getElementById('blogProgressText').textContent = `Error: ${error.message}`;
                showToast(`Failed to generate blog: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Blog Post';
                progress.classList.add('hidden');
            }
        }
        
        // ==========================================
        // BULK BLOG GENERATION
        // ==========================================
        
        async function generateBulkBlogs() {
            const keywordsText = document.getElementById('bulkKeywords').value.trim();
            if (!keywordsText) {
                showToast('Please enter at least one keyword', 'warning');
                return;
            }
            
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const keywords = keywordsText.split('\n').map(k => k.trim()).filter(k => k.length > 0);
            if (keywords.length === 0) {
                showToast('No valid keywords found', 'warning');
                return;
            }
            
            const wordCount = parseInt(document.getElementById('bulkWordCount').value);
            const faqCount = parseInt(document.getElementById('bulkFaqCount').value);
            
            const btn = document.getElementById('btnBulkGenerate');
            const progress = document.getElementById('bulkProgress');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressCount = document.getElementById('bulkProgressCount');
            const progressLog = document.getElementById('bulkProgressLog');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            progressLog.innerHTML = '';
            progressCount.textContent = `0/${keywords.length}`;
            progressBar.style.width = '0%';
            
            let completed = 0;
            let succeeded = 0;
            const results = [];
            
            for (const keyword of keywords) {
                try {
                    progressLog.innerHTML += `<div class="text-yellow-400"><i class="fas fa-spinner fa-spin mr-1"></i> Generating: ${keyword}...</div>`;
                    progressLog.scrollTop = progressLog.scrollHeight;
                    
                    // Use synchronous generation
                    const response = await fetch('/api/content/blog/generate-sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            client_id: currentClient.id,
                            keyword: keyword,
                            word_count: wordCount,
                            include_faq: faqCount > 0,
                            faq_count: faqCount
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || result.error) {
                        throw new Error(result.error || 'Generation failed');
                    }
                    
                    succeeded++;
                    results.push({ keyword, success: true, blogId: result.blog_id });
                    
                    // Update progress log
                    const lines = progressLog.innerHTML.split('</div>');
                    lines.pop(); // Remove last empty
                    lines.pop(); // Remove generating line
                    progressLog.innerHTML = lines.join('</div>') + '</div>';
                    progressLog.innerHTML += `<div class="text-green-400"><i class="fas fa-check mr-1"></i> ${keyword} - Created!</div>`;
                    
                } catch (error) {
                    results.push({ keyword, success: false, error: error.message });
                    // Update progress log
                    const lines = progressLog.innerHTML.split('</div>');
                    lines.pop();
                    lines.pop();
                    progressLog.innerHTML = lines.join('</div>') + '</div>';
                    progressLog.innerHTML += `<div class="text-red-400"><i class="fas fa-times mr-1"></i> ${keyword} - ${error.message}</div>`;
                }
                
                completed++;
                progressCount.textContent = `${completed}/${keywords.length}`;
                progressBar.style.width = `${(completed / keywords.length) * 100}%`;
                progressLog.scrollTop = progressLog.scrollHeight;
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rocket"></i> Generate All Blogs';
            
            showToast(`Bulk generation complete: ${succeeded}/${keywords.length} blogs created`, succeeded === keywords.length ? 'success' : 'warning');
            
            // Refresh blogs list
            loadBlogs();
        }
        
        // ==========================================
        // REAL-TIME SEO ANALYSIS
        // ==========================================
        
        async function analyzeSEO(content, keyword, location) {
            try {
                const response = await fetch('/api/monitoring/seo-score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        content: content,
                        target_keyword: keyword,
                        location: location || currentClient?.geo || ''
                    })
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('SEO analysis error:', error);
            }
            return null;
        }
        
        function renderSEOAnalysis(seoResult, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !seoResult) return;
            
            const { total_score, grade, factors, recommendations } = seoResult;
            
            const gradeColors = {
                'A+': 'text-green-400 bg-green-500/20',
                'A': 'text-green-400 bg-green-500/20',
                'B': 'text-yellow-400 bg-yellow-500/20',
                'C': 'text-orange-400 bg-orange-500/20',
                'D': 'text-red-400 bg-red-500/20',
                'F': 'text-red-500 bg-red-500/20'
            };
            
            const gradeColor = gradeColors[grade] || gradeColors['F'];
            
            container.innerHTML = `
                <div class="p-4 bg-slate-800/50 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="text-4xl font-bold ${gradeColor.split(' ')[0]}">${total_score}</div>
                            <div>
                                <span class="px-2 py-1 rounded text-sm font-bold ${gradeColor}">${grade}</span>
                                <p class="text-xs text-gray-500 mt-1">SEO Score</p>
                            </div>
                        </div>
                        <div class="w-24 h-24">
                            <svg viewBox="0 0 36 36" class="w-full h-full">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="#334155" stroke-width="3"/>
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="${total_score >= 80 ? '#22c55e' : total_score >= 60 ? '#eab308' : '#ef4444'}" 
                                    stroke-width="3" stroke-dasharray="${total_score}, 100"/>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${Object.entries(factors).map(([key, data]) => `
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-400">${formatFactorName(key)}</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-20 bg-gray-700 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full ${data.score >= data.max * 0.8 ? 'bg-green-500' : data.score >= data.max * 0.5 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                            style="width: ${(data.score / data.max) * 100}%"></div>
                                    </div>
                                    <span class="text-white w-12 text-right">${data.score}/${data.max}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${recommendations.length > 0 ? `
                        <div class="border-t border-white/10 pt-3">
                            <p class="text-xs font-medium text-gray-400 mb-2">Recommendations:</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                ${recommendations.slice(0, 5).map(r => `<li class="flex items-start gap-2"><i class="fas fa-lightbulb text-yellow-500 mt-0.5"></i>${r}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function formatFactorName(key) {
            const names = {
                'keyword_in_title': 'Keyword in Title',
                'keyword_in_h1': 'Keyword in H1',
                'keyword_in_first_100_words': 'Keyword in Intro',
                'keyword_density': 'Keyword Density',
                'word_count': 'Word Count',
                'heading_structure': 'Heading Structure',
                'meta_title_length': 'Meta Title',
                'meta_description_length': 'Meta Description',
                'readability': 'Readability',
                'internal_links': 'Internal Links',
                'external_links': 'External Links',
                'image_optimization': 'Image Alt Text',
                'content_depth': 'Content Depth'
            };
            return names[key] || key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }
        
        // SERP Preview Generator
        function generateSERPPreview(title, description, url) {
            return `
                <div class="bg-white rounded-lg p-4 max-w-xl">
                    <div class="text-sm text-green-700 mb-1">${url || 'https://example.com/page'}</div>
                    <div class="text-xl text-blue-800 hover:underline cursor-pointer mb-1" style="font-family: arial, sans-serif;">
                        ${title || 'Page Title Goes Here'}
                    </div>
                    <div class="text-sm text-gray-600" style="font-family: arial, sans-serif;">
                        ${description || 'Meta description will appear here. Make it compelling to increase click-through rates from search results.'}
                    </div>
                </div>
            `;
        }
        
        async function generateSocial() {
            const topic = document.getElementById('socialTopic').value.trim();
            
            if (!topic) {
                alert('Please enter a topic');
                return;
            }
            
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const platforms = [];
            if (document.getElementById('platformGbp').checked) platforms.push('gbp');
            if (document.getElementById('platformFacebook').checked) platforms.push('facebook');
            if (document.getElementById('platformInstagram').checked) platforms.push('instagram');
            
            if (platforms.length === 0) {
                alert('Please select at least one platform');
                return;
            }
            
            const btn = document.getElementById('btnGenerateSocial');
            const progress = document.getElementById('socialProgress');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            
            let generated = 0;
            
            for (const platform of platforms) {
                document.getElementById('socialProgressText').textContent = `Generating ${platform.toUpperCase()} post...`;
                
                try {
                    const response = await fetch(`${API_URL}/api/content/social/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            client_id: currentClient.id,
                            topic: topic,
                            platform: platform
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        generated++;
                    } else {
                        console.error(`Social generation failed (${platform}):`, result.error || 'Unknown error');
                        // Show error to user
                        if (result.error && result.error.includes('API key')) {
                            alert(`‚ö†Ô∏è ${platform.toUpperCase()}: OpenAI API key not configured. Please add OPENAI_API_KEY to your environment.`);
                        }
                    }
                } catch (error) {
                    console.error(`Social generation error (${platform}):`, error);
                }
            }
            
            document.getElementById('socialProgressText').textContent = `‚úì Generated ${generated} social posts!`;
            
            setTimeout(() => {
                progress.classList.add('hidden');
                loadClient(currentClient.id);
                showTab('social');
            }, 1500);
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate Social Posts';
        }
        
        // ==========================================
        // AI IMAGE GENERATION
        // ==========================================
        
        let lastGeneratedImageUrl = null;
        
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            
            if (!prompt) {
                alert('Please describe the image you want to create');
                return;
            }
            
            const style = document.getElementById('imageStyle').value;
            const size = document.getElementById('imageSize').value;
            
            const btn = document.getElementById('btnGenerateImage');
            const progress = document.getElementById('imageProgress');
            const preview = document.getElementById('imagePreview');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            preview.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_URL}/api/images/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        style: style,
                        size: size,
                        client_id: currentClient?.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.url) {
                    // Show preview
                    lastGeneratedImageUrl = data.url;
                    document.getElementById('generatedImage').src = data.url;
                    document.getElementById('imageDownload').href = data.url;
                    document.getElementById('imageProvider').textContent = `Generated with ${data.provider?.toUpperCase() || 'AI'}`;
                    preview.classList.remove('hidden');
                    
                    document.getElementById('imageProgressText').textContent = '‚úì Image generated!';
                } else {
                    alert('Image generation failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate Image';
                setTimeout(() => progress.classList.add('hidden'), 1500);
            }
        }
        
        async function generateSocialImages() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            
            if (!prompt) {
                alert('Please describe the image you want to create');
                return;
            }
            
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const btn = document.getElementById('btnGenerateSocialImages');
            const progress = document.getElementById('imageProgress');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            document.getElementById('imageProgressText').textContent = 'Generating images for all platforms...';
            
            try {
                const response = await fetch(`${API_URL}/api/images/generate-for-social`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        topic: prompt,
                        client_id: currentClient.id,
                        platforms: ['facebook', 'instagram', 'linkedin']
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('imageProgressText').textContent = 
                        `‚úì Generated ${data.generated_count}/${data.total_platforms} platform images!`;
                    
                    // Show first successful image in preview
                    for (const [platform, result] of Object.entries(data.images || {})) {
                        if (result.success && result.url) {
                            lastGeneratedImageUrl = result.url;
                            document.getElementById('generatedImage').src = result.url;
                            document.getElementById('imageDownload').href = result.url;
                            document.getElementById('imageProvider').textContent = `${platform} - ${result.provider?.toUpperCase() || 'AI'}`;
                            document.getElementById('imagePreview').classList.remove('hidden');
                            break;
                        }
                    }
                } else {
                    alert('Image generation failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                setTimeout(() => progress.classList.add('hidden'), 2000);
            }
        }
        
        function copyImageUrl() {
            if (lastGeneratedImageUrl) {
                // Construct full URL
                const fullUrl = lastGeneratedImageUrl.startsWith('http') 
                    ? lastGeneratedImageUrl 
                    : window.location.origin + lastGeneratedImageUrl;
                
                navigator.clipboard.writeText(fullUrl).then(() => {
                    // Show brief feedback
                    const btn = event.target.closest('button');
                    const originalIcon = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check text-green-400 text-sm"></i>';
                    setTimeout(() => {
                        btn.innerHTML = originalIcon;
                    }, 1000);
                });
            }
        }
        
        // ==========================================
        // IMAGE LIBRARY FUNCTIONS
        // ==========================================
        
        let clientImageLibrary = [];
        let selectedLibraryImage = null;
        
        async function loadImageLibrary() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/images/library/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    clientImageLibrary = data.images || [];
                    renderImageLibrary();
                }
            } catch (error) {
                console.error('Failed to load image library:', error);
            }
        }
        
        function renderImageLibrary() {
            const grid = document.getElementById('imageLibraryGrid');
            
            if (clientImageLibrary.length === 0) {
                grid.innerHTML = '<p class="col-span-3 text-center text-gray-500 text-sm py-4">Upload images to see them here</p>';
                return;
            }
            
            grid.innerHTML = clientImageLibrary.map(img => `
                <div class="relative group cursor-pointer rounded-lg overflow-hidden ${selectedLibraryImage === img.id ? 'ring-2 ring-pink-500' : ''}" 
                     onclick="selectLibraryImage('${img.id}')" title="${img.title || img.filename || 'Image'}">
                    <img src="${img.file_url}" alt="${img.alt_text || img.title || 'Image'}" 
                         class="w-full h-20 object-cover bg-slate-700"
                         onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23475569%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2212%22 fill=%22%239ca3af%22 text-anchor=%22middle%22>Lost on deploy</text></svg>'; this.classList.add('opacity-50');">
                    <div class="absolute bottom-0 left-0 right-0 bg-black/70 px-1 py-0.5 text-xs text-gray-300 truncate">
                        ${(img.title || img.filename || 'Image').substring(0, 20)}${(img.title || img.filename || '').length > 20 ? '...' : ''}
                    </div>
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                        <i class="fas fa-check text-white"></i>
                    </div>
                    <button onclick="event.stopPropagation(); deleteLibraryImage('${img.id}')" 
                            class="absolute top-1 right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs opacity-0 group-hover:opacity-100 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function selectLibraryImage(imageId) {
            selectedLibraryImage = selectedLibraryImage === imageId ? null : imageId;
            renderImageLibrary();
        }
        
        // Handle drag and drop
        function handleImageDrop(event) {
            event.preventDefault();
            event.target.classList.remove('border-pink-500');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                uploadLibraryImages({ target: { files: files } });
            }
        }
        
        async function uploadLibraryImages(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            // Validate file types
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const validFiles = files.filter(file => {
                if (!validTypes.includes(file.type)) {
                    showToast(`Skipped ${file.name}: invalid type`, 'warning');
                    return false;
                }
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`Skipped ${file.name}: too large`, 'warning');
                    return false;
                }
                return true;
            });
            
            if (!validFiles.length) {
                showToast('No valid files to upload', 'error');
                return;
            }
            
            const category = document.getElementById('uploadCategory').value;
            
            // Show progress
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            progressDiv.classList.remove('hidden');
            
            let uploaded = 0;
            let failed = 0;
            
            // Upload files one by one for better progress tracking
            for (let i = 0; i < validFiles.length; i++) {
                const file = validFiles[i];
                const progress = Math.round(((i) / validFiles.length) * 100);
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${i}/${validFiles.length}`;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);
                formData.append('title', file.name.replace(/\.[^/.]+$/, ''));
                
                try {
                    const response = await fetch(`${API_URL}/api/images/library/${currentClient.id}/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        uploaded++;
                        // Show storage type
                        if (data.storage === 'ftp') {
                            console.log(`${file.name} uploaded to FTP: ${data.image.file_url}`);
                        }
                    } else {
                        failed++;
                        console.error(`Failed to upload ${file.name}:`, data.error);
                    }
                } catch (error) {
                    failed++;
                    console.error(`Upload error for ${file.name}:`, error);
                }
            }
            
            // Complete
            progressBar.style.width = '100%';
            progressText.textContent = `${validFiles.length}/${validFiles.length}`;
            
            setTimeout(() => {
                progressDiv.classList.add('hidden');
                progressBar.style.width = '0%';
            }, 1000);
            
            // Show result
            if (uploaded > 0) {
                showToast(`Uploaded ${uploaded} image${uploaded > 1 ? 's' : ''}${failed > 0 ? `, ${failed} failed` : ''}`, 'success');
                loadImageLibrary();
            } else {
                showToast('All uploads failed', 'error');
            }
            
            // Reset file input
            if (event.target.value) event.target.value = '';
        }
        
        // Keep old function name for compatibility
        async function uploadLibraryImage(event) {
            return uploadLibraryImages(event);
        }
        
        async function deleteLibraryImage(imageId) {
            if (!confirm('Delete this image?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/images/library/${currentClient.id}/${imageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    showToast('Image deleted', 'success');
                    loadImageLibrary();
                }
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }
        
        async function createFeaturedImage() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const title = document.getElementById('featuredImageTitle').value.trim();
            if (!title) {
                alert('Please enter a title for the featured image');
                return;
            }
            
            const template = document.getElementById('featuredImageTemplate').value;
            const externalUrl = document.getElementById('featuredImageUrl').value.trim();
            
            let endpoint, requestBody;
            
            if (externalUrl) {
                // Use external URL endpoint
                if (!externalUrl.startsWith('http')) {
                    alert('Please enter a valid URL starting with http:// or https://');
                    return;
                }
                endpoint = `${API_URL}/api/images/featured/from-url`;
                requestBody = {
                    image_url: externalUrl,
                    title: title,
                    template: template,
                    subtitle: currentClient.geo || ''
                };
            } else {
                // Use client library
                endpoint = `${API_URL}/api/images/featured/${currentClient.id}`;
                requestBody = {
                    title: title,
                    template: template,
                    subtitle: currentClient.geo || ''
                };
                
                // If an image is selected, use it
                if (selectedLibraryImage) {
                    requestBody.source_image_id = selectedLibraryImage;
                } else {
                    // Otherwise, auto-select from library
                    requestBody.category = 'hero';
                }
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('featuredImageResult').src = data.file_url;
                    document.getElementById('featuredImageDownload').href = data.file_url;
                    document.getElementById('featuredImagePreview').classList.remove('hidden');
                    showToast('Featured image created!', 'success');
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function generateBulk() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const blogCount = parseInt(document.getElementById('bulkBlogCount').value);
            const socialCount = parseInt(document.getElementById('bulkSocialCount').value);
            
            if (blogCount === 0 && socialCount === 0) {
                alert('Please select at least one item to generate');
                return;
            }
            
            // Check if client has keywords
            const availableKeywords = [
                ...(currentClient.primary_keywords || []),
                ...(currentClient.secondary_keywords || [])
            ];
            
            if (blogCount > 0 && availableKeywords.length === 0) {
                alert('This client has no keywords defined. Please add keywords first or use the single blog generator with a custom keyword.');
                return;
            }
            
            if (blogCount > availableKeywords.length) {
                if (!confirm(`This client only has ${availableKeywords.length} keyword(s). Generate ${availableKeywords.length} blogs instead of ${blogCount}?`)) {
                    return;
                }
            }
            
            const btn = document.getElementById('btnGenerateBulk');
            const progress = document.getElementById('oldBulkProgress');
            const progressBar = document.getElementById('oldBulkProgressBar');
            const progressCount = document.getElementById('oldBulkProgressCount');
            const progressLog = document.getElementById('oldBulkProgressLog');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            progressLog.innerHTML = '';
            
            const actualBlogCount = Math.min(blogCount, availableKeywords.length);
            const actualSocialTopics = Math.min(socialCount, availableKeywords.length);
            const totalItems = actualBlogCount + (actualSocialTopics * 3); // 3 platforms
            let completed = 0;
            
            // Get keywords for blogs
            const keywords = availableKeywords.slice(0, actualBlogCount);
            
            // Generate blogs
            for (let i = 0; i < keywords.length; i++) {
                const keyword = keywords[i];
                progressLog.innerHTML += `<div class="text-blue-400">üìù Generating blog: ${keyword}...</div>`;
                progressLog.scrollTop = progressLog.scrollHeight;
                
                try {
                    const response = await fetch('/api/content/blog/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            client_id: currentClient.id,
                            keyword: keyword,
                            word_count: 1500,
                            include_faq: true,
                            faq_count: 5,
                            generate_schema: true
                        })
                    });
                    
                    if (response.ok) {
                        progressLog.innerHTML += `<div class="text-green-400">‚úì Blog: ${keyword}</div>`;
                    } else {
                        progressLog.innerHTML += `<div class="text-red-400">‚úó Failed: ${keyword}</div>`;
                    }
                } catch (error) {
                    progressLog.innerHTML += `<div class="text-red-400">‚úó Error: ${keyword}</div>`;
                }
                
                completed++;
                progressCount.textContent = `${completed} / ${totalItems}`;
                progressBar.style.width = totalItems > 0 ? `${(completed / totalItems) * 100}%` : '100%';
            }
            
            // Generate social posts
            const platforms = ['gbp', 'facebook', 'instagram'];
            const topics = availableKeywords.slice(0, socialCount);
            
            if (socialCount > 0 && topics.length === 0) {
                progressLog.innerHTML += `<div class="text-yellow-400">‚ö† No keywords for social posts - skipping</div>`;
            }
            
            for (const topic of topics) {
                for (const platform of platforms) {
                    progressLog.innerHTML += `<div class="text-blue-400">üì± Generating ${platform}: ${topic}...</div>`;
                    progressLog.scrollTop = progressLog.scrollHeight;
                    
                    try {
                        const response = await fetch(`${API_URL}/api/content/social/generate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${AUTH_TOKEN}`
                            },
                            body: JSON.stringify({
                                client_id: currentClient.id,
                                topic: topic,
                                platform: platform
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            progressLog.innerHTML += `<div class="text-green-400">‚úì ${platform}: ${topic}</div>`;
                        } else {
                            progressLog.innerHTML += `<div class="text-red-400">‚úó ${platform}: ${result.error || 'Failed'}</div>`;
                        }
                    } catch (error) {
                        progressLog.innerHTML += `<div class="text-red-400">‚úó ${platform}: ${topic}</div>`;
                    }
                    
                    completed++;
                    progressCount.textContent = `${completed} / ${totalItems}`;
                    progressBar.style.width = totalItems > 0 ? `${(completed / totalItems) * 100}%` : '100%';
                }
            }
            
            progressLog.innerHTML += `<div class="text-purple-400 font-bold mt-2">üéâ Bulk generation complete!</div>`;
            
            setTimeout(() => {
                loadClient(currentClient.id);
                showTab('blogs');
            }, 2000);
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rocket"></i> Generate All';
        }
        
        // ==========================================
        // ONBOARDING TOUR
        // ==========================================
        const tourSteps = [
            {
                element: '#tab-generate',
                title: 'Generate Content',
                content: 'Click here to create new blog posts and social media content with AI. Select a keyword and click generate!',
                position: 'bottom'
            },
            {
                element: '#tab-blogs',
                title: 'Blog Posts',
                content: 'View all your generated blog posts here. Click any post to preview, edit, or export it.',
                position: 'bottom'
            },
            {
                element: '#tab-social',
                title: 'Social Media',
                content: 'Manage your social media content for Google Business, Facebook, and Instagram.',
                position: 'bottom'
            },
            {
                element: '#tab-calendar',
                title: 'Content Calendar',
                content: 'Plan and schedule your content. Use Auto-Schedule to create a posting plan automatically.',
                position: 'bottom'
            },
            {
                element: '#clientSelector',
                title: 'Switch Clients',
                content: 'Use this dropdown to switch between different client accounts.',
                position: 'bottom'
            }
        ];
        
        let currentTourStep = 0;
        let tourActive = false;
        
        function startTour() {
            if (tourSteps.length === 0) return;
            tourActive = true;
            currentTourStep = 0;
            showTourStep(0);
        }
        
        function showTourStep(index) {
            // Remove any existing tour elements
            document.querySelectorAll('.tour-tooltip, .tour-highlight').forEach(el => el.remove());
            
            if (index >= tourSteps.length) {
                endTour();
                return;
            }
            
            const step = tourSteps[index];
            const element = document.querySelector(step.element);
            
            if (!element) {
                // Skip to next step if element not found
                showTourStep(index + 1);
                return;
            }
            
            // Add highlight
            element.classList.add('tour-highlight');
            
            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = `tour-tooltip ${step.position}`;
            tooltip.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-lightbulb text-purple-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">${step.title}</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">${step.content}</p>
                <div class="flex items-center justify-between">
                    <div class="tour-progress">
                        ${tourSteps.map((_, i) => `<div class="tour-progress-dot ${i === index ? 'active' : ''}"></div>`).join('')}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="endTour()" class="px-3 py-1 text-gray-500 text-sm hover:text-gray-700">Skip</button>
                        <button onclick="nextTourStep()" class="px-4 py-1 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                            ${index === tourSteps.length - 1 ? 'Finish' : 'Next'}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tooltip);
            
            // Position tooltip
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let top, left;
            switch (step.position) {
                case 'bottom':
                    top = rect.bottom + 16;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    break;
                case 'top':
                    top = rect.top - tooltipRect.height - 16;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    break;
                case 'left':
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    left = rect.left - tooltipRect.width - 16;
                    break;
                case 'right':
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    left = rect.right + 16;
                    break;
            }
            
            // Keep tooltip in viewport
            left = Math.max(16, Math.min(left, window.innerWidth - tooltipRect.width - 16));
            top = Math.max(16, Math.min(top, window.innerHeight - tooltipRect.height - 16));
            
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }
        
        function nextTourStep() {
            const currentElement = document.querySelector(tourSteps[currentTourStep]?.element);
            if (currentElement) currentElement.classList.remove('tour-highlight');
            
            currentTourStep++;
            if (currentTourStep >= tourSteps.length) {
                endTour();
            } else {
                showTourStep(currentTourStep);
            }
        }
        
        function endTour() {
            tourActive = false;
            document.querySelectorAll('.tour-tooltip, .tour-highlight').forEach(el => {
                if (el.classList.contains('tour-highlight')) {
                    el.classList.remove('tour-highlight');
                } else {
                    el.remove();
                }
            });
            
            // Mark tour as completed
            localStorage.setItem('mcp_tour_completed', 'true');
        }
        
        // Show tour for first-time users
        // ==========================================
        // REPORTS
        // ==========================================
        function updateReportStats() {
            if (!currentClient) return;
            
            document.getElementById('reportBlogs').textContent = allBlogs.length;
            document.getElementById('reportSocial').textContent = allSocial.length;
            
            const totalWords = allBlogs.reduce((sum, b) => sum + (b.word_count || 0), 0);
            document.getElementById('reportWords').textContent = totalWords.toLocaleString();
            
            // Calculate average SEO score
            if (allBlogs.length > 0) {
                const scores = allBlogs.map(b => calculateSEOScore(b).score);
                const avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                document.getElementById('reportSeoScore').textContent = avgScore + '/100';
            } else {
                document.getElementById('reportSeoScore').textContent = '--';
            }
        }
        
        function generateMonthlyReport() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const branding = JSON.parse(localStorage.getItem('mcp_branding') || '{}');
            const agencyName = branding.agencyName || 'MCP Framework';
            const totalWords = allBlogs.reduce((sum, b) => sum + (b.word_count || 0), 0);
            const avgScore = allBlogs.length > 0 
                ? Math.round(allBlogs.map(b => calculateSEOScore(b).score).reduce((a, b) => a + b, 0) / allBlogs.length)
                : 0;
            
            // Get status counts
            const statusCounts = {
                draft: allBlogs.filter(b => b.status === 'draft').length,
                scheduled: allBlogs.filter(b => b.status === 'scheduled').length,
                approved: allBlogs.filter(b => b.status === 'approved').length,
                published: allBlogs.filter(b => b.status === 'published').length
            };
            
            const reportHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monthly Content Report - ${currentClient.business_name}</title>
    <style>
        @page { size: letter; margin: 0.5in; }
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; max-width: 850px; margin: 0 auto; padding: 20px; line-height: 1.5; }
        .no-print { position: fixed; top: 20px; right: 20px; z-index: 100; }
        .no-print button { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .no-print button:hover { background: #5a67d8; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px; border-radius: 16px; margin-bottom: 30px; }
        .header h1 { margin: 0 0 10px 0; font-size: 28px; font-weight: 700; }
        .header p { margin: 0; opacity: 0.9; font-size: 16px; }
        .header .date { font-size: 14px; margin-top: 15px; opacity: 0.8; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-box h3 { margin: 0; font-size: 32px; color: #667eea; font-weight: 700; }
        .stat-box p { margin: 5px 0 0 0; color: #64748b; font-size: 13px; }
        .section { margin-bottom: 30px; background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .section h2 { color: #1e293b; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-top: 0; font-size: 18px; }
        .content-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .content-table th { background: #f1f5f9; padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        .content-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .content-table tr:last-child td { border-bottom: none; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-draft { background: #f1f5f9; color: #64748b; }
        .status-scheduled { background: #dbeafe; color: #1d4ed8; }
        .status-approved { background: #dcfce7; color: #15803d; }
        .status-published { background: #d1fae5; color: #047857; }
        .keyword-tag { display: inline-block; background: #ede9fe; color: #7c3aed; padding: 4px 10px; border-radius: 6px; font-size: 12px; margin: 3px; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px; }
        .footer { text-align: center; color: #94a3b8; font-size: 12px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="no-print">
        <button onclick="window.print()">üìÑ Print / Save as PDF</button>
    </div>
    
    <div class="header">
        <h1>Monthly Content Report</h1>
        <p>${currentClient.business_name}</p>
        <p class="date">Report Period: ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</p>
    </div>
    
    <div class="stats">
        <div class="stat-box">
            <h3>${allBlogs.length}</h3>
            <p>Blog Posts</p>
        </div>
        <div class="stat-box">
            <h3>${allSocial.length}</h3>
            <p>Social Posts</p>
        </div>
        <div class="stat-box">
            <h3>${totalWords.toLocaleString()}</h3>
            <p>Total Words</p>
        </div>
        <div class="stat-box">
            <h3>${avgScore}/100</h3>
            <p>Avg SEO Score</p>
        </div>
    </div>
    
    <div class="section">
        <h2>üìä Content Status Summary</h2>
        <div class="summary-grid">
            <div class="summary-item"><span>Draft</span><strong>${statusCounts.draft}</strong></div>
            <div class="summary-item"><span>Scheduled</span><strong>${statusCounts.scheduled}</strong></div>
            <div class="summary-item"><span>Approved</span><strong>${statusCounts.approved}</strong></div>
            <div class="summary-item"><span>Published</span><strong>${statusCounts.published}</strong></div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìù Blog Posts Created</h2>
        ${allBlogs.length > 0 ? `
        <table class="content-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Keyword</th>
                    <th>Words</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${allBlogs.slice(0, 20).map(b => `
                <tr>
                    <td>${b.title || 'Untitled'}</td>
                    <td>${b.primary_keyword || '-'}</td>
                    <td>${b.word_count || 0}</td>
                    <td><span class="status-badge status-${b.status || 'draft'}">${b.status || 'draft'}</span></td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        ${allBlogs.length > 20 ? `<p style="text-align:center; color:#64748b; margin-top:10px;">...and ${allBlogs.length - 20} more posts</p>` : ''}
        ` : '<p style="color:#64748b">No blog posts created yet</p>'}
    </div>
    
    <div class="section">
        <h2>üéØ Keywords Targeted</h2>
        <div>
            ${(currentClient.primary_keywords || []).map(k => `<span class="keyword-tag">${k}</span>`).join('')}
            ${(currentClient.primary_keywords || []).length === 0 ? '<p style="color:#64748b">No keywords defined</p>' : ''}
        </div>
    </div>
    
    <div class="footer">
        <p>Generated by ${agencyName}</p>
        <p>${new Date().toLocaleString()}</p>
    </div>
</body>
</html>`;
            
            // Open in new window for print/PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
        }
        
        function exportInventoryCSV() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            let csv = '';
            
            if (document.getElementById('exportBlogs').checked && allBlogs.length > 0) {
                csv += 'BLOG POSTS\n';
                csv += 'Title,Keyword,Word Count,Status,Created\n';
                allBlogs.forEach(b => {
                    csv += `"${(b.title || '').replace(/"/g, '""')}","${b.primary_keyword || ''}",${b.word_count || 0},"${b.status || 'draft'}","${b.created_at || ''}"\n`;
                });
                csv += '\n';
            }
            
            if (document.getElementById('exportSocial').checked && allSocial.length > 0) {
                csv += 'SOCIAL POSTS\n';
                csv += 'Platform,Topic,Status,Created\n';
                allSocial.forEach(s => {
                    csv += `"${s.platform || ''}","${(s.topic || '').replace(/"/g, '""')}","${s.status || 'draft'}","${s.created_at || ''}"\n`;
                });
                csv += '\n';
            }
            
            if (document.getElementById('exportKeywords').checked) {
                csv += 'KEYWORDS\n';
                csv += 'Keyword,Type\n';
                (currentClient.primary_keywords || []).forEach(k => {
                    csv += `"${k}","primary"\n`;
                });
                (currentClient.secondary_keywords || []).forEach(k => {
                    csv += `"${k}","secondary"\n`;
                });
            }
            
            if (!csv) {
                alert('No data selected for export');
                return;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClient.business_name?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'client'}-content-inventory.csv`;
            a.click();
        }
        
        function exportInventoryHTML() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            let content = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Content Inventory - ${currentClient.business_name}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { color: #1e293b; }
        h2 { color: #334155; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #64748b; font-weight: 600; }
        .status-draft { color: #f59e0b; }
        .status-published { color: #10b981; }
    </style>
</head>
<body>
    <h1>Content Inventory: ${currentClient.business_name}</h1>
    <p>Generated: ${new Date().toLocaleString()}</p>
`;
            
            if (document.getElementById('exportBlogs').checked && allBlogs.length > 0) {
                content += `<h2>Blog Posts (${allBlogs.length})</h2><table><tr><th>Title</th><th>Keyword</th><th>Words</th><th>Status</th></tr>`;
                allBlogs.forEach(b => {
                    content += `<tr><td>${escapeHtml(b.title || 'Untitled')}</td><td>${escapeHtml(b.primary_keyword || '')}</td><td>${b.word_count || 0}</td><td class="status-${b.status || 'draft'}">${b.status || 'draft'}</td></tr>`;
                });
                content += '</table>';
            }
            
            if (document.getElementById('exportSocial').checked && allSocial.length > 0) {
                content += `<h2>Social Posts (${allSocial.length})</h2><table><tr><th>Platform</th><th>Topic</th><th>Status</th></tr>`;
                allSocial.forEach(s => {
                    content += `<tr><td>${escapeHtml(s.platform || '')}</td><td>${escapeHtml(s.topic || '')}</td><td class="status-${s.status || 'draft'}">${s.status || 'draft'}</td></tr>`;
                });
                content += '</table>';
            }
            
            if (document.getElementById('exportKeywords').checked) {
                const keywords = [...(currentClient.primary_keywords || []), ...(currentClient.secondary_keywords || [])];
                if (keywords.length > 0) {
                    content += `<h2>Keywords (${keywords.length})</h2><ul>`;
                    keywords.forEach(k => content += `<li>${escapeHtml(k)}</li>`);
                    content += '</ul>';
                }
            }
            
            content += '</body></html>';
            
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClient.business_name?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'client'}-content-inventory.html`;
            a.click();
        }
        
        function generateClientSummary() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const branding = JSON.parse(localStorage.getItem('mcp_branding') || '{}');
            const agencyName = branding.agencyName || 'MCP Framework';
            const totalWords = allBlogs.reduce((sum, b) => sum + (b.word_count || 0), 0);
            
            const summaryHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Client Summary - ${currentClient.business_name}</title>
    <style>
        @page { size: letter; margin: 0.5in; }
        body { font-family: Arial, sans-serif; color: #333; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 3px solid #667eea; margin-bottom: 30px; }
        .header h1 { margin: 0; color: #1e293b; }
        .header .agency { color: #667eea; font-weight: bold; }
        .client-info { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .client-info h2 { margin: 0 0 10px 0; color: #667eea; }
        .metrics { display: flex; gap: 20px; margin-bottom: 30px; }
        .metric { flex: 1; text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; }
        .metric h3 { margin: 0; font-size: 32px; }
        .metric p { margin: 5px 0 0 0; opacity: 0.9; }
        .section { margin-bottom: 25px; }
        .section h3 { color: #334155; margin-bottom: 10px; }
        .tag { display: inline-block; background: #e2e8f0; padding: 4px 12px; border-radius: 20px; margin: 4px; font-size: 14px; }
        .footer { text-align: center; color: #94a3b8; font-size: 11px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Client Summary</h1>
        <div class="agency">${escapeHtml(agencyName)}</div>
    </div>
    
    <div class="client-info">
        <h2>${escapeHtml(currentClient.business_name || 'Client')}</h2>
        <p><strong>Industry:</strong> ${escapeHtml(currentClient.industry || 'N/A')} | <strong>Location:</strong> ${escapeHtml(currentClient.geo || 'N/A')}</p>
    </div>
    
    <div class="metrics">
        <div class="metric">
            <h3>${allBlogs.length}</h3>
            <p>Blog Posts</p>
        </div>
        <div class="metric">
            <h3>${allSocial.length}</h3>
            <p>Social Posts</p>
        </div>
        <div class="metric">
            <h3>${totalWords.toLocaleString()}</h3>
            <p>Words Written</p>
        </div>
    </div>
    
    <div class="section">
        <h3>Target Keywords</h3>
        <div>
            ${(currentClient.primary_keywords || []).slice(0, 8).map(k => `<span class="tag">${escapeHtml(k)}</span>`).join('')}
            ${(currentClient.primary_keywords || []).length > 8 ? `<span class="tag">+${(currentClient.primary_keywords || []).length - 8} more</span>` : ''}
        </div>
    </div>
    
    <div class="section">
        <h3>Recent Content</h3>
        <ul>
            ${allBlogs.slice(0, 5).map(b => `<li>${escapeHtml(b.title || 'Untitled')} (${b.word_count || 0} words)</li>`).join('')}
            ${allBlogs.length === 0 ? '<li>No content yet</li>' : ''}
        </ul>
    </div>
    
    <div class="section">
        <h3>Next Steps</h3>
        <ul>
            <li>Continue publishing ${currentClient.primary_keywords?.[0] || 'targeted'} content weekly</li>
            <li>Maintain social media posting schedule (3x/week)</li>
            <li>Monitor keyword rankings and adjust strategy</li>
        </ul>
    </div>
    
    <div class="footer">
        <p>Prepared by ${escapeHtml(agencyName)} ‚Ä¢ ${new Date().toLocaleDateString()}</p>
    </div>
</body>
</html>`;
            
            const blob = new Blob([summaryHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClient.business_name?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'client'}-summary.html`;
            a.click();
        }
        
        function checkFirstTimeUser() {
            const tourCompleted = localStorage.getItem('mcp_tour_completed');
            if (!tourCompleted) {
                // Wait a moment for the dashboard to load, then offer the tour
                setTimeout(() => {
                    if (confirm('Welcome! Would you like a quick tour of the Content Dashboard?')) {
                        startTour();
                    } else {
                        localStorage.setItem('mcp_tour_completed', 'true');
                    }
                }, 1000);
            }
        }
        
        // Call after login
        const originalLoadClients = loadClients;
        loadClients = async function() {
            await originalLoadClients();
            checkFirstTimeUser();
        };
        
        // ==========================================
        // GOOGLE ANALYTICS 4
        // ==========================================
        
        async function refreshGA4Data() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const btn = document.getElementById('refreshGA4Btn');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
                btn.disabled = true;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/analytics/traffic/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.configured) {
                        document.getElementById('ga4NotConfigured').classList.add('hidden');
                        document.getElementById('ga4Data').classList.remove('hidden');
                        
                        // Update metrics
                        document.getElementById('ga4Sessions').textContent = (data.sessions || 0).toLocaleString();
                        document.getElementById('ga4Users').textContent = (data.users || 0).toLocaleString();
                        document.getElementById('ga4Pageviews').textContent = (data.pageviews || 0).toLocaleString();
                        document.getElementById('ga4BounceRate').textContent = (data.bounce_rate || 0).toFixed(1) + '%';
                        
                        // Show message if credentials missing
                        if (data.credentials_missing) {
                            showToast('GA4 Property ID saved, but server needs Google credentials to fetch data. Contact admin.', 'warning');
                        }
                        
                        // Update top pages
                        const topPagesHtml = data.top_pages?.length 
                            ? data.top_pages.slice(0, 5).map(p => `
                                <div class="flex justify-between text-gray-300">
                                    <span class="truncate flex-1">${p.page}</span>
                                    <span class="text-gray-500 ml-2">${p.views}</span>
                                </div>
                            `).join('') 
                            : '<p class="text-gray-500">No page data</p>';
                        document.getElementById('ga4TopPages').innerHTML = topPagesHtml;
                        
                        // Update search terms
                        const searchTermsHtml = data.search_terms?.length 
                            ? data.search_terms.slice(0, 5).map(t => `
                                <div class="flex justify-between text-gray-300">
                                    <span class="truncate flex-1">${t.term}</span>
                                    <span class="text-gray-500 ml-2">${t.clicks}</span>
                                </div>
                            `).join('') 
                            : '<p class="text-gray-500">No search data</p>';
                        document.getElementById('ga4SearchTerms').innerHTML = searchTermsHtml;
                    } else {
                        document.getElementById('ga4NotConfigured').classList.remove('hidden');
                        document.getElementById('ga4Data').classList.add('hidden');
                    }
                } else {
                    console.error('GA4 fetch failed');
                    document.getElementById('ga4NotConfigured').classList.remove('hidden');
                    document.getElementById('ga4Data').classList.add('hidden');
                }
            } catch (error) {
                console.error('GA4 error:', error);
            } finally {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh';
                    btn.disabled = false;
                }
            }
        }
        
        // ==========================================
        // RANK TRACKING
        // ==========================================
        
        let rankingsData = null;
        let rankHistoryChart = null;
        
        async function refreshRankings() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const btn = document.getElementById('refreshRankBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/rankings?client_id=${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    if (response.status === 403) {
                        // Check if user needs admin fix
                        const fixAdmin = confirm('Access denied. This may be a permission issue.\\n\\nWould you like to try fixing your admin role?\\n\\n(Click OK to attempt fix, Cancel to dismiss)');
                        if (fixAdmin) {
                            await attemptAdminFix();
                        }
                        throw new Error('Access denied. Your account may need admin permissions.');
                    }
                    if (response.status === 400 && err.error?.includes('keywords')) {
                        throw new Error('No keywords configured. Add keywords in Settings first.');
                    }
                    throw new Error(err.error || `Failed to check rankings (${response.status})`);
                }
                
                rankingsData = await response.json();
                renderRankings();
                showToast('Rankings updated!', 'success');
                
            } catch (error) {
                console.error('Rankings error:', error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function attemptAdminFix() {
            try {
                const response = await fetch(`${API_URL}/api/auth/fix-admin`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Admin role restored!\\n\\nOld role: ' + result.old_role + '\\nNew role: ' + result.new_role + '\\n\\nPlease refresh the page.');
                    location.reload();
                } else {
                    alert('Could not fix admin role: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Admin fix error:', error);
                alert('Failed to fix admin role: ' + error.message);
            }
        }
        
        async function loadRankingHistory() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/rankings/history?client_id=${currentClient.id}&days=30`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.history && data.history.length > 0) {
                        renderRankingHistory(data.history);
                    }
                }
            } catch (e) {
                console.log('No ranking history yet');
            }
        }
        
        function renderRankings() {
            if (!rankingsData || !rankingsData.keywords) return;
            
            const keywords = rankingsData.keywords;
            
            // Show demo mode notice if applicable
            const demoNotice = document.getElementById('rankingsDemoNotice');
            if (rankingsData.demo_mode) {
                if (!demoNotice) {
                    const notice = document.createElement('div');
                    notice.id = 'rankingsDemoNotice';
                    notice.className = 'mb-4 p-3 bg-amber-500/10 border border-amber-500/30 rounded-xl';
                    notice.innerHTML = `
                        <p class="text-amber-400 text-sm">
                            <i class="fas fa-flask mr-2"></i>
                            <strong>Demo Mode:</strong> ${rankingsData.message || 'Add SEMRUSH_API_KEY to enable real ranking data'}
                        </p>
                    `;
                    document.getElementById('rankingsTable')?.parentElement?.insertBefore(notice, document.getElementById('rankingsTable'));
                }
            } else if (demoNotice) {
                demoNotice.remove();
            }
            
            // Update stats
            const positions = keywords.filter(k => k.position && k.position <= 100).map(k => k.position);
            const avgPos = positions.length > 0 
                ? Math.round(positions.reduce((a, b) => a + b, 0) / positions.length) 
                : '--';
            
            document.getElementById('rankAvgPosition').textContent = positions.length > 0 ? `#${avgPos}` : '#--';
            document.getElementById('rankTop3').textContent = keywords.filter(k => k.position && k.position <= 3).length;
            document.getElementById('rankTop10').textContent = keywords.filter(k => k.position && k.position <= 10).length;
            
            // Handle traffic value - can be a number or an object with estimated_monthly_value
            let trafficValue = 0;
            if (rankingsData.traffic_value) {
                if (typeof rankingsData.traffic_value === 'object') {
                    trafficValue = parseFloat(rankingsData.traffic_value.estimated_monthly_value) || 0;
                } else {
                    trafficValue = parseFloat(rankingsData.traffic_value) || 0;
                }
            }
            document.getElementById('rankTrafficValue').textContent = isNaN(trafficValue) ? '$0' : `$${Math.round(trafficValue).toLocaleString()}`;
            
            // Render table
            const tbody = document.getElementById('rankingsTable');
            
            if (keywords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="py-8 text-center text-gray-500">
                            No keywords configured. Add keywords in client settings.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by position (ranked first)
            keywords.sort((a, b) => {
                if (!a.position) return 1;
                if (!b.position) return -1;
                return a.position - b.position;
            });
            
            tbody.innerHTML = keywords.map(kw => {
                const pos = kw.position ? `#${kw.position}` : '--';
                const posClass = kw.position 
                    ? (kw.position <= 3 ? 'text-green-400' : kw.position <= 10 ? 'text-blue-400' : kw.position <= 20 ? 'text-yellow-400' : 'text-gray-400')
                    : 'text-gray-500';
                
                let changeHtml = '--';
                if (kw.change) {
                    if (kw.change > 0) {
                        changeHtml = `<span class="text-green-400"><i class="fas fa-arrow-up mr-1"></i>${kw.change}</span>`;
                    } else if (kw.change < 0) {
                        changeHtml = `<span class="text-red-400"><i class="fas fa-arrow-down mr-1"></i>${Math.abs(kw.change)}</span>`;
                    } else {
                        changeHtml = '<span class="text-gray-500">-</span>';
                    }
                }
                
                return `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-3">
                            <div class="text-white">${kw.keyword}</div>
                            ${kw.serp_features && kw.serp_features.length > 0 ? `
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${kw.serp_features.map(f => `
                                        <span class="text-xs px-1.5 py-0.5 bg-purple-500/20 text-purple-300 rounded" title="${f.name}">
                                            ${f.icon || 'üîπ'}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </td>
                        <td class="py-3 text-center font-bold ${posClass}">${pos}</td>
                        <td class="py-3 text-center">${changeHtml}</td>
                        <td class="py-3 text-center text-gray-400">${kw.keyword_difficulty ? Math.round(kw.keyword_difficulty) + '%' : '--'}</td>
                        <td class="py-3 text-right text-gray-400">${kw.search_volume ? kw.search_volume.toLocaleString() : '--'}</td>
                    </tr>
                `;
            }).join('');
            
            // Update improved/declined sections
            const improved = keywords.filter(k => k.change && k.change > 0);
            const declined = keywords.filter(k => k.change && k.change < 0);
            
            document.getElementById('improvedKeywords').innerHTML = improved.length > 0
                ? improved.slice(0, 5).map(k => `
                    <div class="flex justify-between items-center p-2 bg-green-500/10 rounded">
                        <span class="text-white">${k.keyword}</span>
                        <span class="text-green-400">+${k.change}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No improvements detected yet</p>';
            
            document.getElementById('declinedKeywords').innerHTML = declined.length > 0
                ? declined.slice(0, 5).map(k => `
                    <div class="flex justify-between items-center p-2 bg-red-500/10 rounded">
                        <span class="text-white">${k.keyword}</span>
                        <span class="text-red-400">${k.change}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No declines detected</p>';
        }
        
        function renderRankingHistory(history) {
            // Group by keyword and date
            const byKeyword = {};
            history.forEach(h => {
                if (!byKeyword[h.keyword]) {
                    byKeyword[h.keyword] = [];
                }
                byKeyword[h.keyword].push({
                    date: h.checked_at,
                    position: h.position
                });
            });
            
            // Get top 5 keywords by frequency
            const topKeywords = Object.entries(byKeyword)
                .sort((a, b) => b[1].length - a[1].length)
                .slice(0, 5);
            
            if (topKeywords.length === 0) return;
            
            // Get unique dates
            const allDates = [...new Set(history.map(h => h.checked_at.split('T')[0]))].sort();
            const recentDates = allDates.slice(-14); // Last 14 days
            
            // Prepare chart data
            const datasets = topKeywords.map(([keyword, data], idx) => {
                const colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
                
                const positions = recentDates.map(date => {
                    const match = data.find(d => d.date.startsWith(date));
                    return match ? match.position : null;
                });
                
                return {
                    label: keyword.length > 20 ? keyword.substring(0, 20) + '...' : keyword,
                    data: positions,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '20',
                    tension: 0.3,
                    fill: false
                };
            });
            
            // Create or update chart
            const ctx = document.getElementById('rankHistoryChart').getContext('2d');
            
            if (rankHistoryChart) {
                rankHistoryChart.destroy();
            }
            
            rankHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#9ca3af', font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            reverse: true, // Lower position = better
                            min: 1,
                            max: 50,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // COMPETITOR DASHBOARD
        // ==========================================
        
        let competitorData = null;
        
        async function refreshCompetitorDashboard() {
            if (!currentClient) return;
            
            const btn = document.querySelector('[onclick="refreshCompetitorDashboard()"]');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                btn.disabled = true;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitor-dashboard/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    competitorData = await response.json();
                    renderCompetitorDashboard();
                } else {
                    console.error('Failed to load competitor data');
                }
            } catch (error) {
                console.error('Competitor dashboard error:', error);
            } finally {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                    btn.disabled = false;
                }
            }
            
            // Also load social connections
            loadSocialConnections();
        }
        
        function renderCompetitorDashboard() {
            if (!competitorData) return;
            
            const { summary, competitors, content_gaps, ranking_battles, client_rankings } = competitorData;
            
            // Update stats
            document.getElementById('compCount').textContent = summary.total_competitors || 0;
            document.getElementById('compGaps').textContent = summary.content_gaps_found || 0;
            document.getElementById('compKeywords').textContent = summary.client_keywords_tracked || 0;
            
            // Calculate win rate from battles
            const wins = ranking_battles.filter(b => b.winning).length;
            const total = ranking_battles.length;
            const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
            document.getElementById('compWinRate').textContent = winRate + '%';
            
            // Render competitor cards
            const cardsHtml = competitors.length ? competitors.map(comp => `
                <div class="bg-white/5 rounded-xl p-4 border border-white/10 hover:border-purple-500/50 transition cursor-pointer" onclick="viewCompetitor('${comp.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                <i class="fas fa-building text-white"></i>
                            </div>
                            <div>
                                <div class="font-medium text-white">${comp.name || comp.domain}</div>
                                <div class="text-xs text-gray-500">${comp.domain}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-white">${comp.total_pages}</div>
                            <div class="text-xs text-gray-500">pages</div>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center gap-2 text-xs">
                        <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">${comp.blog_posts} blogs</span>
                        <span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded">${comp.service_pages} services</span>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm">No competitors tracked. Add them in intake.</p>';
            
            document.getElementById('competitorCards').innerHTML = cardsHtml;
            
            // Render ranking battles
            const battlesHtml = ranking_battles.length ? ranking_battles.slice(0, 10).map(battle => `
                <div class="flex items-center justify-between p-3 rounded-lg ${battle.winning ? 'bg-green-500/10 border border-green-500/20' : 'bg-red-500/10 border border-red-500/20'}">
                    <div class="flex-1">
                        <div class="font-medium text-white text-sm">${battle.keyword}</div>
                        <div class="text-xs text-gray-500">vs ${battle.competitor}</div>
                    </div>
                    <div class="flex items-center gap-4 text-sm">
                        <div class="text-center">
                            <div class="font-bold ${battle.winning ? 'text-green-400' : 'text-gray-400'}">#${battle.client_position}</div>
                            <div class="text-xs text-gray-500">You</div>
                        </div>
                        <i class="fas ${battle.winning ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'}"></i>
                        <div class="text-center">
                            <div class="font-bold ${!battle.winning ? 'text-red-400' : 'text-gray-400'}">#${battle.competitor_position}</div>
                            <div class="text-xs text-gray-500">Them</div>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm">No ranking battles found. Check rankings first.</p>';
            
            document.getElementById('rankingBattles').innerHTML = battlesHtml;
            
            // Render content gaps with Beat This option
            const gapsHtml = content_gaps.length ? content_gaps.slice(0, 9).map(gap => `
                <div class="bg-white/5 rounded-lg p-3 border border-white/10 hover:border-yellow-500/50 transition group">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-lightbulb text-yellow-400 mt-1"></i>
                        <div class="flex-1">
                            <div class="text-sm text-white">${gap.title}</div>
                            <div class="text-xs text-gray-500 mt-1">From: ${gap.competitor}</div>
                            ${gap.word_count ? `<div class="text-xs text-gray-600">${gap.word_count} words</div>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="generateFromGap('${encodeURIComponent(gap.topic_suggestion)}')" 
                            class="flex-1 px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs hover:bg-yellow-500/30 transition">
                            <i class="fas fa-plus mr-1"></i>Create
                        </button>
                        ${gap.url ? `
                        <button onclick="beatCompetitorContent('${encodeURIComponent(gap.url)}', '${encodeURIComponent(gap.topic_suggestion)}')" 
                            class="flex-1 px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30 transition">
                            <i class="fas fa-trophy mr-1"></i>Beat
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm col-span-full">No content gaps detected yet.</p>';
            
            document.getElementById('contentGaps').innerHTML = gapsHtml;
        }
        
        function viewCompetitor(competitorId) {
            // Find the competitor in our data
            const comp = competitorData?.competitors?.find(c => c.id === competitorId);
            if (!comp) {
                showToast('Competitor not found', 'error');
                return;
            }
            
            const lastCrawled = comp.last_crawled 
                ? new Date(comp.last_crawled).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })
                : 'Never';
            
            // Show competitor details modal
            const details = `
                <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center" id="competitorModal" onclick="if(event.target === this) this.remove()">
                    <div class="glass-light rounded-2xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">${comp.name || comp.domain}</h3>
                            <button onclick="document.getElementById('competitorModal').remove()" class="p-2 hover:bg-gray-200 rounded-lg">
                                <i class="fas fa-times text-gray-600"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-gray-600">
                                <i class="fas fa-globe"></i>
                                <a href="https://${comp.domain}" target="_blank" class="text-blue-600 hover:underline">${comp.domain}</a>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600">${comp.total_pages || 0}</div>
                                    <div class="text-xs text-gray-500">Total Pages</div>
                                </div>
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${comp.blog_posts || 0}</div>
                                    <div class="text-xs text-gray-500">Blog Posts</div>
                                </div>
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${comp.service_pages || 0}</div>
                                    <div class="text-xs text-gray-500">Service Pages</div>
                                </div>
                            </div>
                            
                            <!-- Crawl Schedule -->
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-medium text-gray-700 mb-3"><i class="fas fa-clock mr-2 text-cyan-500"></i>Auto-Crawl Schedule</h4>
                                <div class="flex items-center gap-3 mb-3">
                                    <select id="compCrawlFrequency-${comp.id}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="updateCompetitorSchedule('${comp.id}', this.value)">
                                        <option value="daily" ${comp.crawl_frequency === 'daily' ? 'selected' : ''}>Daily</option>
                                        <option value="weekly" ${comp.crawl_frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="manual" ${comp.crawl_frequency === 'manual' ? 'selected' : ''}>Manual Only</option>
                                    </select>
                                </div>
                                <p class="text-xs text-gray-500"><i class="fas fa-history mr-1"></i>Last crawled: ${lastCrawled}</p>
                            </div>
                            
                            ${comp.keyword_overlap?.length ? `
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Keyword Overlap</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${comp.keyword_overlap.map(kw => `<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">${kw}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="flex gap-2 pt-4 border-t">
                                <button onclick="crawlCompetitor('${comp.id}')" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium">
                                    <i class="fas fa-sync-alt mr-1"></i>Crawl Now
                                </button>
                                <button onclick="deleteCompetitor('${comp.id}', '${(comp.name || comp.domain).replace(/'/g, "\\'")}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', details);
        }
        
        async function updateCompetitorSchedule(competitorId, frequency) {
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitors/${competitorId}/schedule`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ crawl_frequency: frequency })
                });
                
                if (response.ok) {
                    showToast(`Crawl schedule updated to ${frequency}`, 'success');
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to update schedule', 'error');
                }
            } catch (error) {
                console.error('Error updating schedule:', error);
                showToast('Failed to update schedule', 'error');
            }
        }
        
        function showAddCompetitorForm() {
            document.getElementById('addCompetitorForm').classList.remove('hidden');
            document.getElementById('newCompetitorDomain').focus();
        }
        
        function hideAddCompetitorForm() {
            document.getElementById('addCompetitorForm').classList.add('hidden');
            document.getElementById('newCompetitorDomain').value = '';
            document.getElementById('newCompetitorName').value = '';
        }
        
        async function addCompetitor() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const domain = document.getElementById('newCompetitorDomain').value.trim();
            const name = document.getElementById('newCompetitorName').value.trim();
            
            if (!domain) {
                showToast('Please enter a competitor domain', 'error');
                return;
            }
            
            // Clean domain (remove http://, https://, www.)
            const cleanDomain = domain.replace(/^https?:\/\//, '').replace(/^www\./, '').replace(/\/.*$/, '');
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitors`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        client_id: currentClient.id,
                        domain: cleanDomain,
                        name: name || cleanDomain
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`Added competitor: ${name || cleanDomain}`, 'success');
                    hideAddCompetitorForm();
                    refreshCompetitorDashboard();
                } else {
                    showToast(data.error || 'Failed to add competitor', 'error');
                }
            } catch (error) {
                console.error('Error adding competitor:', error);
                showToast('Failed to add competitor', 'error');
            }
        }
        
        async function deleteCompetitor(competitorId, name) {
            if (!confirm(`Delete competitor "${name}"?\n\nThis will remove all tracked data for this competitor.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitors/${competitorId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    showToast(`Deleted competitor: ${name}`, 'success');
                    // Close modal if open
                    document.getElementById('competitorModal')?.remove();
                    refreshCompetitorDashboard();
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to delete competitor', 'error');
                }
            } catch (error) {
                console.error('Error deleting competitor:', error);
                showToast('Failed to delete competitor', 'error');
            }
        }
        
        async function crawlCompetitor(competitorId) {
            showToast('Starting competitor crawl...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitors/${competitorId}/crawl`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`Crawl complete! Found ${data.pages_found || 0} pages`, 'success');
                    refreshCompetitorDashboard();
                    loadFreshnessAlerts();
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Crawl failed', 'error');
                }
            } catch (error) {
                console.error('Error crawling competitor:', error);
                showToast('Failed to crawl competitor', 'error');
            }
        }
        
        async function crawlAllCompetitors() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            showToast('Starting crawl of all competitors...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitors/crawl-all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ client_id: currentClient.id })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`Crawled ${data.competitors_crawled || 0} competitors, found ${data.total_new_pages || 0} new pages`, 'success');
                    refreshCompetitorDashboard();
                    loadFreshnessAlerts();
                    
                    // Update last crawl time
                    document.getElementById('lastCrawlTime').textContent = `Last crawl: Just now`;
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Crawl failed', 'error');
                }
            } catch (error) {
                console.error('Error crawling all competitors:', error);
                showToast('Failed to crawl competitors', 'error');
            }
        }
        
        async function saveCrawlSettings() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const frequency = document.querySelector('input[name="crawlFrequency"]:checked')?.value || 'daily';
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/crawl-settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        client_id: currentClient.id,
                        crawl_frequency: frequency
                    })
                });
                
                if (response.ok) {
                    showToast('Crawl settings saved!', 'success');
                } else {
                    showToast('Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving crawl settings:', error);
                showToast('Failed to save settings', 'error');
            }
        }
        
        async function loadFreshnessAlerts() {
            if (!currentClient) return;
            
            const container = document.getElementById('freshnessAlertsList');
            if (!container) return;
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/freshness-alerts?client_id=${currentClient.id}&days=7`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const alerts = data.alerts || [];
                    
                    if (alerts.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-check-circle text-2xl mb-2 opacity-50"></i>
                                <p class="text-sm">No new competitor content in the last 7 days</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = alerts.map(alert => `
                        <div class="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-yellow-500/20 flex items-center justify-center">
                                        <i class="fas fa-exclamation text-yellow-400 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-white font-medium text-sm">${alert.competitor_name}</p>
                                        <p class="text-gray-400 text-xs">${alert.title || 'New content published'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">${formatTimeAgo(alert.detected_at)}</span>
                                    <button onclick="generateFromGap('${encodeURIComponent(alert.topic || alert.title)}')" 
                                        class="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition">
                                        Counter
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading freshness alerts:', error);
            }
        }
        
        function formatTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }
        
        async function generateFromGap(topic) {
            const decodedTopic = decodeURIComponent(topic);
            
            if (!confirm(`Generate blog post about:\n\n"${decodedTopic}"\n\nThis will create a new SEO-optimized blog post.`)) {
                return;
            }
            
            // Show loading state
            const gapsContainer = document.getElementById('contentGaps');
            const originalHtml = gapsContainer.innerHTML;
            gapsContainer.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-yellow-400 mb-2"></i>
                    <p class="text-white">Generating blog about "${decodedTopic}"...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/content/blog/generate-async`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        client_id: currentClient.id,
                        keyword: decodedTopic,
                        word_count: 1500,
                        include_faq: true,
                        faq_count: 5
                    })
                });
                
                const data = await response.json();
                
                if (data.task_id) {
                    // Poll for completion
                    let attempts = 0;
                    const maxAttempts = 60;
                    
                    const pollTask = async () => {
                        attempts++;
                        const taskResponse = await fetch(`${API_URL}/api/content/blog/task/${data.task_id}`, {
                            headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                        });
                        const taskData = await taskResponse.json();
                        
                        if (taskData.status === 'complete') {
                            gapsContainer.innerHTML = `
                                <div class="col-span-full text-center py-8">
                                    <i class="fas fa-check-circle text-3xl text-green-400 mb-2"></i>
                                    <p class="text-white font-medium">Blog Created!</p>
                                    <p class="text-gray-400 text-sm">${taskData.title}</p>
                                    <p class="text-gray-500 text-xs mt-1">${taskData.word_count} words ‚Ä¢ SEO Score: ${taskData.seo_score || 'N/A'}</p>
                                    <button onclick="showTab('blogs'); loadBlogs();" class="mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                                        View Blog
                                    </button>
                                </div>
                            `;
                            // Refresh blogs list
                            loadBlogs();
                        } else if (taskData.status === 'error') {
                            gapsContainer.innerHTML = originalHtml;
                            alert('Error generating blog: ' + (taskData.error || 'Unknown error'));
                        } else if (attempts < maxAttempts) {
                            setTimeout(pollTask, 2000);
                        } else {
                            gapsContainer.innerHTML = originalHtml;
                            alert('Blog generation timed out. Check the Blogs tab for results.');
                        }
                    };
                    
                    setTimeout(pollTask, 2000);
                } else {
                    throw new Error(data.error || 'Failed to start generation');
                }
            } catch (error) {
                console.error('Gap generation error:', error);
                gapsContainer.innerHTML = originalHtml;
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        // ==========================================
        // BEAT COMPETITOR CONTENT
        // ==========================================
        
        async function beatCompetitorContent(competitorUrl, topic) {
            const url = decodeURIComponent(competitorUrl);
            const decodedTopic = decodeURIComponent(topic);
            
            // Show analysis modal
            const modal = `
                <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center" id="beatModal" onclick="if(event.target === this) this.remove()">
                    <div class="glass-light rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-trophy text-yellow-500 mr-2"></i>Beat This Content
                            </h3>
                            <button onclick="document.getElementById('beatModal').remove()" class="p-2 hover:bg-gray-200 rounded-lg">
                                <i class="fas fa-times text-gray-600"></i>
                            </button>
                        </div>
                        
                        <div id="beatAnalysis" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-3xl text-purple-500 mb-3"></i>
                            <p class="text-gray-600">Analyzing competitor content...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            
            try {
                // First, fetch and analyze the competitor page
                const analyzeResponse = await fetch(`${API_URL}/api/monitoring/analyze-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ url: url })
                });
                
                let competitorData = null;
                if (analyzeResponse.ok) {
                    competitorData = await analyzeResponse.json();
                }
                
                // Render analysis
                const analysisDiv = document.getElementById('beatAnalysis');
                analysisDiv.innerHTML = `
                    <div class="space-y-4 text-left">
                        <div class="p-4 bg-red-50 rounded-xl border border-red-200">
                            <h4 class="font-medium text-red-800 mb-2">
                                <i class="fas fa-crosshairs mr-2"></i>Competitor Content
                            </h4>
                            <p class="text-sm text-gray-700 font-medium">${competitorData?.title || decodedTopic}</p>
                            <div class="flex gap-4 mt-2 text-xs text-gray-500">
                                <span><i class="fas fa-file-word mr-1"></i>${competitorData?.word_count || '~1,500'} words</span>
                                <span><i class="fas fa-heading mr-1"></i>${competitorData?.h2_count || '5'} H2s</span>
                                <span><i class="fas fa-link mr-1"></i>${competitorData?.internal_links || '3'} links</span>
                            </div>
                            <a href="${url}" target="_blank" class="text-xs text-blue-600 hover:underline mt-2 inline-block">
                                <i class="fas fa-external-link-alt mr-1"></i>View original
                            </a>
                        </div>
                        
                        <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                            <h4 class="font-medium text-green-800 mb-2">
                                <i class="fas fa-rocket mr-2"></i>Our Strategy to Beat It
                            </h4>
                            <ul class="text-sm text-gray-700 space-y-2">
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Write <strong>${Math.round((competitorData?.word_count || 1500) * 1.3)}</strong> words (30% more)</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Include <strong>${(competitorData?.h2_count || 5) + 2}</strong> comprehensive H2 sections</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Add <strong>5</strong> FAQs with schema markup</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Include <strong>6+</strong> internal links</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Add images with optimized alt text</li>
                                <li><i class="fas fa-check text-green-500 mr-2"></i>Target keyword in title, H1, meta, and first 100 words</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="generateBeatContent('${encodeURIComponent(decodedTopic)}', ${Math.round((competitorData?.word_count || 1500) * 1.3)})" 
                                class="flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-medium hover:opacity-90 transition">
                                <i class="fas fa-magic mr-2"></i>Generate Winning Content
                            </button>
                            <button onclick="document.getElementById('beatModal').remove()" 
                                class="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Beat analysis error:', error);
                document.getElementById('beatAnalysis').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                        <p>Error analyzing competitor content</p>
                        <button onclick="generateFromGap('${encodeURIComponent(topic)}')" class="mt-3 px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm">
                            Generate Anyway
                        </button>
                    </div>
                `;
            }
        }
        
        async function generateBeatContent(topic, wordCount) {
            const decodedTopic = decodeURIComponent(topic);
            document.getElementById('beatModal')?.remove();
            
            // Switch to generate tab and fill in the form
            showTab('generate');
            
            // Fill in the custom keyword
            document.getElementById('customBlogKeyword').value = decodedTopic;
            
            // Set word count to beat competitor
            const wordCountSelect = document.getElementById('blogWordCount');
            if (wordCount >= 2000) {
                wordCountSelect.value = '2500';
            } else if (wordCount >= 1800) {
                wordCountSelect.value = '2000';
            } else {
                wordCountSelect.value = '1800';
            }
            
            // Ensure FAQs are enabled
            document.getElementById('blogFaqs').value = '5';
            document.getElementById('blogGenerateImage').checked = true;
            
            showToast('Form filled! Click "Generate Blog Post" to create winning content.', 'success');
        }
        
        // ==========================================
        // SERP PREVIEW
        // ==========================================
        
        function showSERPPreview(title, description, url) {
            const modal = `
                <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center" id="serpModal" onclick="if(event.target === this) this.remove()">
                    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fab fa-google text-blue-500 mr-2"></i>Google SERP Preview
                            </h3>
                            <button onclick="document.getElementById('serpModal').remove()" class="p-2 hover:bg-gray-200 rounded-lg">
                                <i class="fas fa-times text-gray-600"></i>
                            </button>
                        </div>
                        
                        <div class="border rounded-lg p-4 mb-4">
                            <div class="text-sm text-green-700 mb-1">${url || 'https://example.com/page'}</div>
                            <div class="text-xl text-blue-800 hover:underline cursor-pointer mb-1" style="font-family: arial, sans-serif;">
                                ${title || 'Page Title Goes Here'}
                            </div>
                            <div class="text-sm text-gray-600" style="font-family: arial, sans-serif;">
                                ${description || 'Meta description will appear here. Make it compelling!'}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-500">Title Length:</span>
                                <span class="font-medium ${(title?.length || 0) > 60 ? 'text-red-600' : 'text-green-600'}">
                                    ${title?.length || 0}/60
                                </span>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-500">Description Length:</span>
                                <span class="font-medium ${(description?.length || 0) > 160 ? 'text-red-600' : 'text-green-600'}">
                                    ${description?.length || 0}/160
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        
        // ==========================================
        // SOCIAL CONNECTIONS
        // ==========================================
        
        async function loadSocialConnections() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/social/connections/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderSocialConnections(data.connections);
                }
            } catch (error) {
                console.error('Failed to load social connections:', error);
            }
        }
        
        function renderSocialConnections(connections) {
            if (!connections) {
                console.warn('No connections data received');
                return;
            }
            
            const platforms = ['gbp', 'facebook', 'instagram', 'linkedin'];
            
            platforms.forEach(platform => {
                const conn = connections[platform];
                const statusEl = document.getElementById(`${platform}-status`);
                const btnEl = document.getElementById(`${platform}-btn`);
                
                if (statusEl && btnEl && conn) {
                    if (conn.connected) {
                        statusEl.textContent = 'Connected';
                        statusEl.classList.remove('text-gray-500');
                        statusEl.classList.add('text-green-400');
                        btnEl.textContent = 'Disconnect';
                        btnEl.classList.add('bg-red-500/20', 'hover:bg-red-500/30');
                        btnEl.classList.remove('bg-white/10', 'hover:bg-white/20');
                        btnEl.onclick = () => disconnectSocial(platform);
                    } else {
                        statusEl.textContent = 'Not connected';
                        statusEl.classList.remove('text-green-400');
                        statusEl.classList.add('text-gray-500');
                        btnEl.textContent = 'Connect';
                        btnEl.classList.remove('bg-red-500/20', 'hover:bg-red-500/30');
                        btnEl.classList.add('bg-white/10', 'hover:bg-white/20');
                        btnEl.onclick = () => connectSocial(platform);
                    }
                }
            });
        }
        
        // OAuth state for handling callbacks
        let pendingOAuthState = null;
        
        // Check for OAuth callback on page load
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const oauthSuccess = urlParams.get('oauth_success');
            const oauthError = urlParams.get('oauth_error');
            const platform = urlParams.get('platform');
            const state = urlParams.get('state');
            const clientId = urlParams.get('client_id');
            
            if (oauthSuccess && state) {
                // Clean URL first
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Restore client context if provided
                if (clientId && (!currentClient || currentClient.id !== clientId)) {
                    try {
                        await loadClient(clientId);
                    } catch (e) {
                        console.error('Failed to restore client context:', e);
                    }
                }
                
                // OAuth successful, show account selection
                pendingOAuthState = state;
                showAccountSelection(platform, state);
            } else if (oauthError) {
                alert(`OAuth Error: ${decodeURIComponent(oauthError)} for ${platform}`);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        async function verifyOAuthCredentials() {
            try {
                const response = await fetch(`${API_URL}/api/oauth/verify-credentials`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await response.json();
                
                if (!response.ok) {
                    alert('Error verifying credentials: ' + (data.error || 'Unknown error'));
                    return;
                }
                
                // Build result message
                let message = 'üîê OAuth API Credentials Status\n\n';
                
                // Facebook
                const fb = data.platforms.facebook;
                message += `üìò Facebook:\n`;
                message += `   Configured: ${fb.configured ? '‚úÖ Yes' : '‚ùå No'}\n`;
                if (fb.configured) {
                    message += `   Valid: ${fb.valid ? '‚úÖ Yes' : '‚ùå No'}\n`;
                    message += `   App ID: ${fb.app_id || 'N/A'}\n`;
                    if (fb.app_name) message += `   App Name: ${fb.app_name}\n`;
                    if (fb.error) message += `   Error: ${fb.error}\n`;
                } else {
                    message += `   Error: ${fb.error}\n`;
                }
                message += '\n';
                
                // Google
                const google = data.platforms.google;
                message += `üîµ Google Business Profile:\n`;
                message += `   Configured: ${google.configured ? '‚úÖ Yes' : '‚ùå No'}\n`;
                if (google.configured) {
                    message += `   Valid: ${google.valid ? '‚úÖ Yes' : '‚ùå No'}\n`;
                    message += `   Client ID: ${google.client_id || 'N/A'}\n`;
                    if (google.error) message += `   Error: ${google.error}\n`;
                } else {
                    message += `   Error: ${google.error}\n`;
                }
                message += '\n';
                
                // LinkedIn
                const li = data.platforms.linkedin;
                message += `üíº LinkedIn:\n`;
                message += `   Configured: ${li.configured ? '‚úÖ Yes' : '‚ùå No'}\n`;
                if (li.configured) {
                    message += `   Valid: ${li.valid ? '‚úÖ Yes' : '‚ùå No'}\n`;
                    message += `   Client ID: ${li.client_id || 'N/A'}\n`;
                    if (li.error) message += `   Error: ${li.error}\n`;
                } else {
                    message += `   Error: ${li.error}\n`;
                }
                message += '\n';
                
                // Callbacks
                message += `üìç Required Callback URLs:\n`;
                message += `   Facebook: ${data.required_callbacks.facebook}\n`;
                message += `   Google: ${data.required_callbacks.google}\n`;
                message += `   LinkedIn: ${data.required_callbacks.linkedin}\n`;
                
                alert(message);
                
            } catch (error) {
                alert('Error verifying credentials: ' + error.message);
            }
        }
        
        async function testClientTokens() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            try {
                showToast('Testing OAuth tokens...', 'info');
                
                const response = await fetch(`${API_URL}/api/oauth/test-client-tokens/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await response.json();
                
                if (!response.ok) {
                    alert('Error testing tokens: ' + (data.error || 'Unknown error'));
                    return;
                }
                
                // Build detailed result
                let html = `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="this.remove()">
                        <div class="bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-auto" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-white">üî¨ Token Test Results</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="text-sm text-gray-400 mb-4">
                                Client: <span class="text-white">${data.client_name}</span><br>
                                Tested: ${new Date(data.tested_at).toLocaleString()}
                            </div>
                            
                            <!-- Summary -->
                            <div class="mb-4 p-3 rounded-lg ${data.summary.all_valid ? 'bg-green-500/20 border border-green-500/50' : 'bg-yellow-500/20 border border-yellow-500/50'}">
                                <div class="font-medium ${data.summary.all_valid ? 'text-green-300' : 'text-yellow-300'}">
                                    ${data.summary.all_valid ? '‚úÖ All tokens are valid!' : '‚ö†Ô∏è Some tokens need attention'}
                                </div>
                                <div class="text-sm text-gray-400 mt-1">
                                    ${data.summary.tokens_valid}/${data.summary.tokens_stored} tokens valid
                                    ${data.summary.needs_reconnect.length > 0 ? `<br>Needs reconnect: ${data.summary.needs_reconnect.join(', ')}` : ''}
                                </div>
                            </div>
                            
                            <!-- Facebook -->
                            <div class="mb-4 p-4 bg-white/5 rounded-lg border ${data.facebook.token_valid ? 'border-green-500/50' : 'border-red-500/50'}">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fab fa-facebook text-blue-400"></i>
                                    <span class="font-medium text-white">Facebook</span>
                                    ${data.facebook.token_valid ? '<span class="text-green-400 text-sm">‚úì Valid</span>' : '<span class="text-red-400 text-sm">‚úó Invalid</span>'}
                                </div>
                                <div class="text-sm space-y-1">
                                    <div class="text-gray-400">Has Token: ${data.facebook.has_token ? 'Yes (' + data.facebook.token_length + ' chars)' : 'No'}</div>
                                    <div class="text-gray-400">Page ID: ${data.facebook.page_id || 'Not set'}</div>
                                    ${data.facebook.error ? `<div class="text-red-400">Error: ${data.facebook.error}</div>` : ''}
                                    ${data.facebook.details?.expires_at_human ? `<div class="text-gray-400">Expires: ${data.facebook.details.expires_at_human}</div>` : ''}
                                    ${data.facebook.details?.is_expired ? `<div class="text-red-400 font-medium">‚ö†Ô∏è TOKEN EXPIRED - Please reconnect</div>` : ''}
                                    ${data.facebook.details?.scopes ? `<div class="text-gray-500 text-xs">Scopes: ${data.facebook.details.scopes.join(', ')}</div>` : ''}
                                </div>
                            </div>
                            
                            <!-- Google/GBP -->
                            <div class="mb-4 p-4 bg-white/5 rounded-lg border ${data.google.token_valid ? 'border-green-500/50' : 'border-red-500/50'}">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fab fa-google text-red-400"></i>
                                    <span class="font-medium text-white">Google Business Profile</span>
                                    ${data.google.token_valid ? '<span class="text-green-400 text-sm">‚úì Valid</span>' : '<span class="text-red-400 text-sm">‚úó Invalid</span>'}
                                </div>
                                <div class="text-sm space-y-1">
                                    <div class="text-gray-400">Has Token: ${data.google.has_token ? 'Yes' : 'No'}</div>
                                    <div class="text-gray-400">Access Token: ${data.google.token_length || 0} chars</div>
                                    <div class="text-gray-400">Refresh Token: ${data.google.refresh_token_length || 0} chars</div>
                                    <div class="text-gray-400">Location ID: ${data.google.location_id || 'Not set'}</div>
                                    ${data.google.error ? `<div class="text-red-400">Error: ${data.google.error}</div>` : ''}
                                    ${data.google.details?.refresh_worked ? `<div class="text-green-400">‚úì Refresh token working</div>` : ''}
                                    ${data.google.details?.token_updated ? `<div class="text-green-400">‚úì Access token refreshed</div>` : ''}
                                </div>
                            </div>
                            
                            <!-- LinkedIn -->
                            <div class="mb-4 p-4 bg-white/5 rounded-lg border ${data.linkedin.token_valid ? 'border-green-500/50' : 'border-red-500/50'}">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fab fa-linkedin text-blue-500"></i>
                                    <span class="font-medium text-white">LinkedIn</span>
                                    ${data.linkedin.token_valid ? '<span class="text-green-400 text-sm">‚úì Valid</span>' : '<span class="text-red-400 text-sm">‚úó Invalid</span>'}
                                </div>
                                <div class="text-sm space-y-1">
                                    <div class="text-gray-400">Has Token: ${data.linkedin.has_token ? 'Yes (' + data.linkedin.token_length + ' chars)' : 'No'}</div>
                                    <div class="text-gray-400">Org ID: ${data.linkedin.org_id || 'Not set'}</div>
                                    ${data.linkedin.error ? `<div class="text-red-400">Error: ${data.linkedin.error}</div>` : ''}
                                    ${data.linkedin.details?.profile_id ? `<div class="text-gray-400">Profile: ${data.linkedin.details.first_name} ${data.linkedin.details.last_name}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-2 mt-4">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
            } catch (error) {
                alert('Error testing tokens: ' + error.message);
            }
        }
        
        async function connectSocial(platform) {
            const platformNames = {
                'gbp': 'Google Business Profile',
                'google': 'Google Business Profile',
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'linkedin': 'LinkedIn'
            };
            
            // Check if OAuth is configured
            try {
                const configResponse = await fetch(`${API_URL}/api/oauth/config`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const configData = await configResponse.json();
                
                const oauthPlatform = platform === 'instagram' ? 'facebook' : (platform === 'gbp' ? 'google' : platform);
                const isConfigured = configData.platforms?.[oauthPlatform]?.configured;
                
                if (isConfigured) {
                    // Use OAuth flow
                    await initiateOAuth(platform);
                } else {
                    // Fall back to manual entry
                    await manualConnect(platform, platformNames);
                }
            } catch (error) {
                console.error('OAuth config check failed:', error);
                // Fall back to manual
                await manualConnect(platform, platformNames);
            }
        }
        
        async function initiateOAuth(platform) {
            const oauthPlatform = platform === 'gbp' ? 'google' : platform;
            
            try {
                const response = await fetch(`${API_URL}/api/oauth/authorize/${oauthPlatform}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ client_id: currentClient.id })
                });
                
                const data = await response.json();
                
                if (response.ok && data.auth_url) {
                    // Redirect to OAuth provider
                    window.location.href = data.auth_url;
                } else {
                    alert(`OAuth error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Failed to initiate OAuth: ' + error.message);
            }
        }
        
        async function showAccountSelection(platform, state) {
            try {
                const response = await fetch(`${API_URL}/api/oauth/accounts/${platform}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ state: state })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                if (!data.accounts || data.accounts.length === 0) {
                    alert('No accounts found. Make sure you have admin access to the pages/accounts.');
                    return;
                }
                
                // Show account selection modal
                showAccountSelectionModal(data.accounts, state);
                
            } catch (error) {
                alert('Failed to get accounts: ' + error.message);
            }
        }
        
        function showAccountSelectionModal(accounts, state) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'oauth-modal-overlay';
            overlay.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50';
            
            let accountsHtml = accounts.map((acc, idx) => {
                const icon = acc.type.includes('facebook') ? 'fab fa-facebook text-blue-500' :
                            acc.type.includes('instagram') ? 'fab fa-instagram text-pink-500' :
                            acc.type.includes('linkedin') ? 'fab fa-linkedin text-blue-600' :
                            'fab fa-google text-red-500';
                const subtitle = acc.type.replace('_', ' ').replace(/(^\w|\s\w)/g, m => m.toUpperCase());
                
                return `
                    <button onclick="selectOAuthAccount(${idx})" 
                            class="w-full p-4 bg-white/5 hover:bg-white/10 rounded-xl flex items-center gap-4 transition text-left"
                            data-account='${JSON.stringify(acc)}'>
                        <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center">
                            ${acc.picture ? `<img src="${acc.picture}" class="w-full h-full rounded-full object-cover">` : `<i class="${icon} text-xl"></i>`}
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-white">${acc.name}</div>
                            <div class="text-sm text-gray-400">${subtitle}</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                `;
            }).join('');
            
            overlay.innerHTML = `
                <div class="bg-gray-900 rounded-2xl p-6 max-w-md w-full mx-4 border border-white/10">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Select Account</h3>
                        <button onclick="closeOAuthModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-gray-400 mb-4">Choose which account to connect:</p>
                    <div class="space-y-3 max-h-80 overflow-y-auto" id="oauth-accounts-list" data-state="${state}">
                        ${accountsHtml}
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function closeOAuthModal() {
            const overlay = document.getElementById('oauth-modal-overlay');
            if (overlay) overlay.remove();
            pendingOAuthState = null;
        }
        
        async function selectOAuthAccount(index) {
            const container = document.getElementById('oauth-accounts-list');
            const state = container.dataset.state;
            const buttons = container.querySelectorAll('button');
            const accountData = JSON.parse(buttons[index].dataset.account);
            
            try {
                const response = await fetch(`${API_URL}/api/oauth/connect`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        state: state,
                        account_type: accountData.type,
                        account_id: accountData.id,
                        account_name: accountData.name,
                        page_access_token: accountData.access_token,
                        facebook_page_id: accountData.facebook_page_id,
                        google_account_id: accountData.account_id  // For GBP locations
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    closeOAuthModal();
                    alert(`‚úì ${accountData.name} connected successfully!`);
                    loadSocialConnections();
                } else {
                    alert(`Connection failed: ${data.error}`);
                }
            } catch (error) {
                alert('Failed to connect: ' + error.message);
            }
        }
        
        async function manualConnect(platform, platformNames) {
            // Fallback to manual token entry when OAuth not configured
            const accessToken = prompt(`Enter ${platformNames[platform]} Access Token:\n\n(OAuth not configured - using manual entry)`);
            if (!accessToken) return;
            
            let extraData = {};
            
            if (platform === 'facebook') {
                const pageId = prompt('Enter Facebook Page ID:');
                if (!pageId) return;
                extraData.page_id = pageId;
            } else if (platform === 'instagram') {
                const accountId = prompt('Enter Instagram Business Account ID:');
                if (!accountId) return;
                extraData.account_id = accountId;
            } else if (platform === 'linkedin') {
                const orgId = prompt('Enter LinkedIn Organization ID:');
                if (!orgId) return;
                extraData.org_id = orgId;
            } else if (platform === 'gbp') {
                const locationId = prompt('Enter GBP Location ID:');
                if (!locationId) return;
                extraData.location_id = locationId;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/social/connect/${currentClient.id}/${platform}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        ...extraData
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì ${platformNames[platform]} connected successfully!`);
                    loadSocialConnections();
                } else {
                    alert(`Connection failed: ${data.error}`);
                }
            } catch (error) {
                alert('Connection failed: ' + error.message);
            }
        }
        
        async function disconnectSocial(platform) {
            if (!confirm(`Are you sure you want to disconnect ${platform}?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/social/disconnect/${currentClient.id}/${platform}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    alert('Disconnected successfully');
                    loadSocialConnections();
                }
            } catch (error) {
                alert('Disconnect failed: ' + error.message);
            }
        }
        
        // ==========================================
        // CHATBOT MANAGEMENT
        // ==========================================
        
        let chatbotConfig = null;
        
        async function loadChatbotConfig() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/config/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    chatbotConfig = await response.json();
                    populateChatbotForm(chatbotConfig);
                    loadChatbotAnalytics();
                    loadEmbedCode();
                    loadRecentConversations();
                }
            } catch (error) {
                console.error('Failed to load chatbot config:', error);
            }
        }
        
        function populateChatbotForm(config) {
            document.getElementById('chatbotEnabled').checked = config.is_active;
            document.getElementById('chatbotName').value = config.name || 'Support Assistant';
            document.getElementById('chatbotPosition').value = config.position || 'bottom-right';
            document.getElementById('chatbotColor').value = config.primary_color || '#8b5cf6';
            document.getElementById('chatbotColorText').value = config.primary_color || '#8b5cf6';
            document.getElementById('chatbotColor2').value = config.secondary_color || '#ec4899';
            document.getElementById('chatbotColor2Text').value = config.secondary_color || '#ec4899';
            document.getElementById('chatbotWelcome').value = config.welcome_message || 'Hi! How can I help you today?';
            document.getElementById('chatbotLeadEnabled').checked = config.lead_capture_enabled !== false;
            document.getElementById('chatbotCollectName').checked = config.collect_name !== false;
            document.getElementById('chatbotCollectEmail').checked = config.collect_email !== false;
            document.getElementById('chatbotCollectPhone').checked = config.collect_phone !== false;
            document.getElementById('chatbotLeadTrigger').value = config.lead_capture_trigger || 'after_3_messages';
            document.getElementById('chatbotEmailNotify').checked = config.email_notifications !== false;
            document.getElementById('chatbotNotifyEmail').value = config.notification_email || '';
            
            // Update preview
            updateChatbotPreview();
        }
        
        async function loadChatbotAnalytics() {
            if (!currentClient || !chatbotConfig) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/analytics/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chatbotConversations').textContent = data.total_conversations || 0;
                    document.getElementById('chatbotLeads').textContent = data.total_leads || 0;
                    document.getElementById('chatbotRating').textContent = data.avg_rating ? data.avg_rating.toFixed(1) : '--';
                }
            } catch (error) {
                console.error('Failed to load chatbot analytics:', error);
            }
        }
        
        async function loadEmbedCode() {
            if (!currentClient || !chatbotConfig) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/config/${currentClient.id}/embed-code`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chatbotEmbedCode').textContent = data.embed_code;
                }
            } catch (error) {
                document.getElementById('chatbotEmbedCode').textContent = '<!-- Error loading embed code -->';
            }
        }
        
        async function loadRecentConversations() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/conversations?client_id=${currentClient.id}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('recentConversations');
                    
                    if (data.conversations && data.conversations.length > 0) {
                        container.innerHTML = data.conversations.map(conv => `
                            <div class="p-3 glass rounded-lg">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-white font-medium text-sm">${escapeHtml(conv.visitor_name || 'Anonymous')}</span>
                                    <span class="text-xs text-gray-500">${getTimeAgo(conv.last_message_at)}</span>
                                </div>
                                <div class="flex items-center gap-2 text-xs">
                                    <span class="text-gray-400">${conv.message_count} messages</span>
                                    ${conv.is_lead_captured ? '<span class="text-green-400">‚úì Lead</span>' : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No conversations yet</p>';
                    }
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }
        
        function getTimeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        function toggleChatbot() {
            // Will save when user clicks save button
        }
        
        async function saveChatbotConfig() {
            if (!currentClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const config = {
                is_active: document.getElementById('chatbotEnabled').checked,
                name: document.getElementById('chatbotName').value,
                position: document.getElementById('chatbotPosition').value,
                primary_color: document.getElementById('chatbotColor').value,
                secondary_color: document.getElementById('chatbotColor2').value,
                welcome_message: document.getElementById('chatbotWelcome').value,
                lead_capture_enabled: document.getElementById('chatbotLeadEnabled').checked,
                collect_name: document.getElementById('chatbotCollectName').checked,
                collect_email: document.getElementById('chatbotCollectEmail').checked,
                collect_phone: document.getElementById('chatbotCollectPhone').checked,
                lead_capture_trigger: document.getElementById('chatbotLeadTrigger').value,
                email_notifications: document.getElementById('chatbotEmailNotify').checked,
                notification_email: document.getElementById('chatbotNotifyEmail').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/config/${currentClient.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    chatbotConfig = data.config;
                    alert('‚úì Chatbot settings saved successfully!');
                    loadEmbedCode();
                } else {
                    const error = await response.json();
                    alert('Failed to save: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to save chatbot settings');
                console.error(error);
            }
        }
        
        function updateChatbotPreview() {
            const color1 = document.getElementById('chatbotColor').value;
            const color2 = document.getElementById('chatbotColor2').value;
            const name = document.getElementById('chatbotName').value;
            const welcome = document.getElementById('chatbotWelcome').value;
            
            const bubble = document.getElementById('previewBubble');
            const header = document.getElementById('previewHeader');
            const nameEl = document.getElementById('previewName');
            const messageEl = document.getElementById('previewMessage');
            
            bubble.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
            header.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
            nameEl.textContent = name || 'Support Assistant';
            messageEl.textContent = welcome || 'Hi! How can I help you today?';
        }
        
        // Color picker sync
        document.getElementById('chatbotColor')?.addEventListener('input', function() {
            document.getElementById('chatbotColorText').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotColorText')?.addEventListener('input', function() {
            document.getElementById('chatbotColor').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotColor2')?.addEventListener('input', function() {
            document.getElementById('chatbotColor2Text').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotColor2Text')?.addEventListener('input', function() {
            document.getElementById('chatbotColor2').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotName')?.addEventListener('input', updateChatbotPreview);
        document.getElementById('chatbotWelcome')?.addEventListener('input', updateChatbotPreview);
        
        // Preview toggle
        document.getElementById('previewBubble')?.addEventListener('click', function() {
            const window = document.getElementById('previewWindow');
            window.classList.toggle('hidden');
        });
        
        function copyEmbedCode() {
            const code = document.getElementById('chatbotEmbedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úì Embed code copied to clipboard!');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úì Embed code copied to clipboard!');
            });
        }
        
        function viewAllConversations() {
            alert('Full conversation view coming soon! For now, conversations are listed here.');
        }
        
        // ==========================================
        // MCP SUPPORT CHATBOT
        // ==========================================
        
        let mcpSupportOpen = false;
        let mcpSupportHistory = [];
        
        function toggleMCPSupport() {
            mcpSupportOpen = !mcpSupportOpen;
            const chatWindow = document.getElementById('mcpSupportWindow');
            const chatBubble = document.getElementById('mcpSupportBubble');
            
            if (mcpSupportOpen) {
                chatWindow.classList.remove('hidden');
                chatWindow.classList.add('flex');
                chatBubble.classList.add('hidden');
                document.getElementById('mcpSupportInput').focus();
            } else {
                chatWindow.classList.add('hidden');
                chatWindow.classList.remove('flex');
                chatBubble.classList.remove('hidden');
            }
        }
        
        async function sendMCPSupportMessage() {
            const input = document.getElementById('mcpSupportInput');
            const message = input.value.trim();
            if (!message) return;
            
            input.value = '';
            
            // Add user message
            addMCPMessage('user', message);
            mcpSupportHistory.push({ role: 'user', content: message });
            
            // Show typing
            document.getElementById('mcpSupportTyping').classList.remove('hidden');
            
            try {
                const response = await fetch('/api/chatbot/mcp-support/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: mcpSupportHistory.slice(-10) // Last 10 messages
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('mcpSupportTyping').classList.add('hidden');
                
                addMCPMessage('assistant', data.response);
                mcpSupportHistory.push({ role: 'assistant', content: data.response });
                
            } catch (error) {
                document.getElementById('mcpSupportTyping').classList.add('hidden');
                addMCPMessage('assistant', 'Sorry, I had trouble responding. Please try again!');
            }
        }
        
        function addMCPMessage(role, content) {
            const container = document.getElementById('mcpSupportMessages');
            const div = document.createElement('div');
            div.className = role === 'user' 
                ? 'ml-auto bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-2xl rounded-br-sm px-4 py-2 max-w-[80%]'
                : 'bg-gray-700 text-gray-100 rounded-2xl rounded-bl-sm px-4 py-2 max-w-[80%]';
            div.textContent = content;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
    
    <!-- MCP Support Chatbot -->
    <div id="mcpSupportBubble" onclick="toggleMCPSupport()" 
         class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full cursor-pointer shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center z-50"
         title="Need help? Ask MCP Support">
        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
    </div>
    
    <div id="mcpSupportWindow" class="hidden fixed bottom-6 right-6 w-96 h-[500px] bg-gray-800 rounded-2xl shadow-2xl flex-col z-50 border border-gray-700 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                </svg>
            </div>
            <div class="flex-1">
                <div class="text-white font-semibold">MCP Support</div>
                <div class="text-white/70 text-sm">How can I help?</div>
            </div>
            <button onclick="toggleMCPSupport()" class="w-8 h-8 rounded-lg bg-white/20 hover:bg-white/30 flex items-center justify-center transition">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Messages -->
        <div id="mcpSupportMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="bg-gray-700 text-gray-100 rounded-2xl rounded-bl-sm px-4 py-2 max-w-[80%]">
                üëã Hi! I'm your MCP assistant. I can help you navigate the dashboard, generate content, find features, and more. What would you like to do?
            </div>
        </div>
        
        <!-- Typing indicator -->
        <div id="mcpSupportTyping" class="hidden px-4 pb-2">
            <div class="bg-gray-700 rounded-2xl px-4 py-2 inline-flex gap-1 items-center">
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            </div>
        </div>
        
        <!-- Input -->
        <div class="p-4 border-t border-gray-700">
            <div class="flex gap-2">
                <input type="text" id="mcpSupportInput" 
                       placeholder="Ask me anything about MCP..."
                       onkeypress="if(event.key==='Enter')sendMCPSupportMessage()"
                       class="flex-1 bg-gray-700 border border-gray-600 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                <button onclick="sendMCPSupportMessage()" 
                        class="w-10 h-10 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full flex items-center justify-center hover:opacity-90 transition">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</body>
</html>
