<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Client Onboarding | AckWest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        /* Dark gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        
        /* Glass effects */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-light {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Progress bar animations */
        .progress-line {
            position: relative;
            overflow: hidden;
        }
        .progress-line::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Step indicator */
        .step-indicator {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .step-indicator.active {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
        }
        .step-indicator.completed {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .step-line {
            transition: all 0.5s ease;
        }
        .step-line.completed {
            background: linear-gradient(90deg, #10b981, #8b5cf6);
        }
        
        /* Animations */
        .fade-up {
            animation: fadeUp 0.5s ease-out;
        }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes bounceIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.6); }
        }
        
        /* Keyword cards */
        .keyword-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .keyword-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .keyword-card.selected-primary {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.15);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }
        .keyword-card.selected-secondary {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
        }
        
        /* Opportunity score colors */
        .score-excellent { background: linear-gradient(135deg, #059669, #10b981); }
        .score-good { background: linear-gradient(135deg, #0891b2, #06b6d4); }
        .score-moderate { background: linear-gradient(135deg, #d97706, #f59e0b); }
        .score-difficult { background: linear-gradient(135deg, #dc2626, #ef4444); }
        
        /* Input focus effects */
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }
        
        /* Logo upload area */
        .logo-upload {
            transition: all 0.3s ease;
            border: 2px dashed rgba(255,255,255,0.2);
        }
        .logo-upload:hover, .logo-upload.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        
        /* Service tag */
        .service-tag {
            transition: all 0.2s ease;
        }
        .service-tag:hover {
            transform: scale(1.05);
        }
        
        /* Competitor card */
        .competitor-card {
            transition: all 0.3s ease;
        }
        .competitor-card:hover {
            transform: translateX(5px);
            border-left-color: #8b5cf6;
        }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Success checkmark */
        .checkmark {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: drawCheck 0.5s ease-out 0.3s forwards;
        }
        @keyframes drawCheck {
            to { stroke-dashoffset: 0; }
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        
        /* Number counter animation */
        .count-up {
            display: inline-block;
        }
        
        /* Tooltip */
        .tooltip-container {
            position: relative;
        }
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 50;
            transition: all 0.2s ease;
        }
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        /* Industry card */
        .industry-card {
            transition: all 0.3s ease;
        }
        .industry-card:hover, .industry-card.selected {
            transform: scale(1.02);
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .industry-card.selected {
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="glass-light rounded-3xl p-8 w-full max-w-md mx-4 shadow-2xl fade-up">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center shadow-lg pulse-glow">
                    <i class="fas fa-rocket text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Client Onboarding</h1>
                <p class="text-gray-500">AckWest</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                    <input type="email" id="loginEmail" 
                        class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:border-purple-500 input-glow transition-all" 
                        placeholder="you@company.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                    <input type="password" id="loginPassword" autocomplete="current-password" 
                        class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:border-purple-500 input-glow transition-all" 
                        placeholder="••••••••"
                        onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                <button onclick="doLogin()" id="loginBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-bold text-lg hover:opacity-90 transition-all shadow-lg mt-2">
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                </button>
                <p id="authError" class="text-red-500 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <!-- Top Navigation -->
        <nav class="glass border-b border-white/10">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center">
                            <i class="fas fa-bolt text-white"></i>
                        </div>
                        <div>
                            <span class="text-white font-bold">AckWest</span>
                            <span class="text-purple-400 text-sm ml-1">Onboarding</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="/client" class="text-gray-400 hover:text-white transition text-sm">
                            <i class="fas fa-arrow-left mr-1"></i>Back to Dashboard
                        </a>
                        <button onclick="startFresh()" class="px-4 py-2 glass text-gray-400 hover:text-white rounded-lg text-sm transition">
                            <i class="fas fa-redo mr-1"></i>Start Over
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Progress Indicator -->
        <div class="py-8 px-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-center">
                    <!-- Step 1 -->
                    <div class="flex flex-col items-center">
                        <div id="step-dot-1" class="step-indicator active w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center text-white font-bold shadow-lg cursor-pointer" onclick="goToStep(1)">
                            <i class="fas fa-building text-lg"></i>
                        </div>
                        <span class="text-white text-xs mt-2 font-medium">Business</span>
                    </div>
                    
                    <div id="step-line-1" class="step-line w-20 h-1 bg-white/20 mx-2 rounded-full"></div>
                    
                    <!-- Step 2 -->
                    <div class="flex flex-col items-center">
                        <div id="step-dot-2" class="step-indicator w-14 h-14 rounded-2xl bg-white/10 flex items-center justify-center text-gray-500 font-bold cursor-pointer" onclick="goToStep(2)">
                            <i class="fas fa-key text-lg"></i>
                        </div>
                        <span class="text-gray-500 text-xs mt-2 font-medium">Keywords</span>
                    </div>
                    
                    <div id="step-line-2" class="step-line w-20 h-1 bg-white/20 mx-2 rounded-full"></div>
                    
                    <!-- Step 3 -->
                    <div class="flex flex-col items-center">
                        <div id="step-dot-3" class="step-indicator w-14 h-14 rounded-2xl bg-white/10 flex items-center justify-center text-gray-500 font-bold cursor-pointer" onclick="goToStep(3)">
                            <i class="fas fa-users text-lg"></i>
                        </div>
                        <span class="text-gray-500 text-xs mt-2 font-medium">Competitors</span>
                    </div>
                    
                    <div id="step-line-3" class="step-line w-20 h-1 bg-white/20 mx-2 rounded-full"></div>
                    
                    <!-- Step 4 -->
                    <div class="flex flex-col items-center">
                        <div id="step-dot-4" class="step-indicator w-14 h-14 rounded-2xl bg-white/10 flex items-center justify-center text-gray-500 font-bold cursor-pointer" onclick="goToStep(4)">
                            <i class="fas fa-clipboard-check text-lg"></i>
                        </div>
                        <span class="text-gray-500 text-xs mt-2 font-medium">Review</span>
                    </div>
                    
                    <div id="step-line-4" class="step-line w-20 h-1 bg-white/20 mx-2 rounded-full"></div>
                    
                    <!-- Step 5 -->
                    <div class="flex flex-col items-center">
                        <div id="step-dot-5" class="step-indicator w-14 h-14 rounded-2xl bg-white/10 flex items-center justify-center text-gray-500 font-bold cursor-pointer" onclick="goToStep(5)">
                            <i class="fas fa-rocket text-lg"></i>
                        </div>
                        <span class="text-gray-500 text-xs mt-2 font-medium">Launch</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="max-w-5xl mx-auto px-4 pb-12">
            <div class="glass rounded-3xl overflow-hidden shadow-2xl">
                
                <!-- ==================== STEP 1: BUSINESS PROFILE ==================== -->
                <div id="step-1" class="step-content">
                    <div class="p-8 lg:p-12">
                        <!-- Header -->
                        <div class="text-center mb-10">
                            <span class="inline-block px-4 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm font-medium mb-4">
                                Step 1 of 5
                            </span>
                            <h2 class="text-3xl lg:text-4xl font-bold text-white mb-3">Tell us about the business</h2>
                            <p class="text-gray-400 max-w-xl mx-auto">We'll use this to create perfectly targeted content that ranks and converts.</p>
                        </div>
                        
                        <!-- Value Proposition -->
                        <div class="glass-card rounded-2xl p-6 mb-10">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-gift text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="text-white font-bold text-lg mb-1">Here's what you'll get:</h4>
                                    <div class="flex flex-wrap gap-3 text-sm">
                                        <span class="text-green-400"><i class="fas fa-check mr-1"></i>10-20 SEO Blog Posts</span>
                                        <span class="text-green-400"><i class="fas fa-check mr-1"></i>30-60 Social Posts</span>
                                        <span class="text-green-400"><i class="fas fa-check mr-1"></i>Service Pages</span>
                                        <span class="text-green-400"><i class="fas fa-check mr-1"></i>Content Calendar</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-3 gap-8">
                            <!-- Left Column - Main Info -->
                            <div class="lg:col-span-2 space-y-6">
                                <!-- Business Name -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-300 mb-2">
                                        <i class="fas fa-store mr-2 text-purple-400"></i>Business Name *
                                    </label>
                                    <input type="text" id="business_name" placeholder="e.g., ABC Roofing & Construction" 
                                        class="w-full px-5 py-4 bg-white/5 border-2 border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 input-glow transition-all text-lg">
                                </div>
                                
                                <!-- Industry Selection -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-300 mb-2">
                                        <i class="fas fa-industry mr-2 text-purple-400"></i>Industry *
                                    </label>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3" id="industryGrid">
                                        <!-- Populated by JS -->
                                    </div>
                                    <select id="industry" class="hidden">
                                        <option value="">Select...</option>
                                    </select>
                                </div>

                                <!-- Location -->
                                <div class="grid sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-300 mb-2">
                                            <i class="fas fa-map-marker-alt mr-2 text-purple-400"></i>Primary Location *
                                        </label>
                                        <input type="text" id="geo" placeholder="e.g., Sarasota, FL" 
                                            class="w-full px-5 py-4 bg-white/5 border-2 border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 input-glow transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-300 mb-2">
                                            <i class="fas fa-globe mr-2 text-purple-400"></i>Website
                                        </label>
                                        <input type="text" id="website" placeholder="https://example.com" 
                                            class="w-full px-5 py-4 bg-white/5 border-2 border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 input-glow transition-all">
                                    </div>
                                </div>

                                <!-- Service Areas -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-300 mb-2">
                                        <i class="fas fa-map mr-2 text-purple-400"></i>Service Areas
                                        <span class="text-gray-500 font-normal ml-1">(comma separated)</span>
                                    </label>
                                    <input type="text" id="service_areas" placeholder="e.g., Sarasota, Bradenton, Venice, Lakewood Ranch" 
                                        class="w-full px-5 py-4 bg-white/5 border-2 border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 input-glow transition-all">
                                    <div id="serviceAreaTags" class="flex flex-wrap gap-2 mt-3"></div>
                                </div>

                                <!-- USPs -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-300 mb-2">
                                        <i class="fas fa-star mr-2 text-purple-400"></i>What makes them unique?
                                        <button onclick="generateUSPSuggestions()" class="ml-2 text-xs text-purple-400 hover:text-purple-300">
                                            <i class="fas fa-magic mr-1"></i>AI Suggest
                                        </button>
                                    </label>
                                    <textarea id="usps" rows="3" placeholder="e.g., 24/7 emergency service, family-owned since 1995, free estimates, licensed & insured..." 
                                        class="w-full px-5 py-4 bg-white/5 border-2 border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 input-glow transition-all resize-none"></textarea>
                                    <div id="uspSuggestions" class="hidden mt-3 flex flex-wrap gap-2"></div>
                                </div>
                            </div>

                            <!-- Right Column - Logo & Contact -->
                            <div class="space-y-6">
                                <!-- Logo Upload -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-300 mb-2">
                                        <i class="fas fa-image mr-2 text-purple-400"></i>Logo
                                    </label>
                                    <div id="logoUpload" class="logo-upload rounded-xl p-8 text-center cursor-pointer" 
                                         onclick="document.getElementById('logoInput').click()"
                                         ondragover="event.preventDefault(); this.classList.add('dragover')"
                                         ondragleave="this.classList.remove('dragover')"
                                         ondrop="handleLogoDrop(event)">
                                        <input type="file" id="logoInput" class="hidden" accept="image/*" onchange="handleLogoUpload(event)">
                                        <div id="logoPreview" class="hidden">
                                            <img id="logoImage" src="" alt="Logo" class="max-h-24 mx-auto mb-2 rounded-lg">
                                            <button onclick="event.stopPropagation(); removeLogo()" class="text-red-400 text-xs hover:text-red-300">
                                                <i class="fas fa-trash mr-1"></i>Remove
                                            </button>
                                        </div>
                                        <div id="logoPlaceholder">
                                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-500 mb-3"></i>
                                            <p class="text-gray-400 text-sm">Drop logo here or click to upload</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Info -->
                                <div class="glass-card rounded-xl p-5">
                                    <h4 class="text-white font-semibold mb-4">
                                        <i class="fas fa-address-card mr-2 text-purple-400"></i>Contact Info
                                    </h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">Phone</label>
                                            <input type="tel" id="phone" placeholder="(941) 555-1234" 
                                                class="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">Email</label>
                                            <input type="email" id="email" placeholder="info@example.com" 
                                                class="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">Address</label>
                                            <input type="text" id="address" placeholder="123 Main St, Sarasota, FL" 
                                                class="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500">
                                        </div>
                                    </div>
                                </div>

                                <!-- Brand Colors -->
                                <div class="glass-card rounded-xl p-5">
                                    <h4 class="text-white font-semibold mb-4">
                                        <i class="fas fa-palette mr-2 text-purple-400"></i>Brand Colors
                                    </h4>
                                    <div class="flex gap-3">
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-400 mb-1">Primary</label>
                                            <div class="flex items-center gap-2">
                                                <input type="color" id="brandColor1" value="#8b5cf6" class="w-10 h-10 rounded-lg cursor-pointer border-0">
                                                <input type="text" id="brandColor1Text" value="#8b5cf6" 
                                                    class="flex-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-xs focus:outline-none">
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-400 mb-1">Secondary</label>
                                            <div class="flex items-center gap-2">
                                                <input type="color" id="brandColor2" value="#ec4899" class="w-10 h-10 rounded-lg cursor-pointer border-0">
                                                <input type="text" id="brandColor2Text" value="#ec4899" 
                                                    class="flex-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-xs focus:outline-none">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="mt-10 flex justify-end">
                            <button onclick="goToStep(2)" id="btn-step-1-next" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl hover:opacity-90 transition-all flex items-center text-lg shadow-lg hover:shadow-purple-500/30">
                                Find Keywords
                                <i class="fas fa-arrow-right ml-3"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ==================== STEP 2: KEYWORD DISCOVERY ==================== -->
                <div id="step-2" class="step-content hidden">
                    <div class="p-8 lg:p-12">
                        <!-- Header -->
                        <div class="text-center mb-8">
                            <span class="inline-block px-4 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm font-medium mb-4">
                                Step 2 of 5
                            </span>
                            <h2 class="text-3xl lg:text-4xl font-bold text-white mb-3">Discover Ranking Opportunities</h2>
                            <p class="text-gray-400 max-w-xl mx-auto">We're analyzing the <span id="industryLabel" class="text-purple-400 font-medium">your industry</span> market in <span id="geoLabel" class="text-purple-400 font-medium">your location</span>.</p>
                        </div>

                        <!-- Research Status -->
                        <div id="researchStatus" class="glass-card rounded-2xl p-6 mb-8">
                            <div class="flex items-center gap-4">
                                <div id="researchIcon" class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                                    <div class="spinner w-6 h-6"></div>
                                </div>
                                <div class="flex-1">
                                    <p id="researchText" class="text-white font-medium">Researching keywords with SEMrush...</p>
                                    <p id="researchSubtext" class="text-gray-400 text-sm">This usually takes 10-30 seconds</p>
                                </div>
                            </div>
                        </div>

                        <!-- Keyword Input -->
                        <div id="keywordInput" class="hidden mb-6">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="flex-1 relative">
                                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                                    <input type="text" id="customKeyword" placeholder="Add a keyword the client mentioned..." 
                                        class="w-full pl-12 pr-4 py-4 bg-white/5 border-2 border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                                        onkeypress="if(event.key==='Enter')addCustomKeyword()">
                                </div>
                                <button onclick="addCustomKeyword()" class="px-6 py-4 bg-white/10 hover:bg-white/20 text-white font-medium rounded-xl transition-all">
                                    <i class="fas fa-plus mr-2"></i>Add & Research
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div id="keywordActions" class="hidden flex flex-wrap gap-3 mb-6">
                            <button onclick="autoSelectBest()" class="px-4 py-2 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition text-sm font-medium">
                                <i class="fas fa-magic mr-2"></i>Auto-Select Best
                            </button>
                            <button onclick="clearSelections()" class="px-4 py-2 bg-white/5 text-gray-400 rounded-lg hover:bg-white/10 transition text-sm">
                                <i class="fas fa-times mr-2"></i>Clear All
                            </button>
                            <div class="flex-1"></div>
                            <div class="flex items-center gap-4 text-sm">
                                <span class="text-gray-500">Filter:</span>
                                <button onclick="filterKeywords('all')" class="keyword-filter active px-3 py-1 bg-white/10 text-white rounded-lg">All</button>
                                <button onclick="filterKeywords('easy')" class="keyword-filter px-3 py-1 text-gray-400 hover:bg-white/5 rounded-lg">Easy Wins</button>
                                <button onclick="filterKeywords('high-volume')" class="keyword-filter px-3 py-1 text-gray-400 hover:bg-white/5 rounded-lg">High Volume</button>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div id="keywordLegend" class="hidden flex flex-wrap items-center gap-4 mb-6 text-sm">
                            <span class="text-gray-500">Opportunity:</span>
                            <span class="flex items-center"><span class="w-3 h-3 rounded-full score-excellent mr-2"></span><span class="text-gray-400">Excellent (80+)</span></span>
                            <span class="flex items-center"><span class="w-3 h-3 rounded-full score-good mr-2"></span><span class="text-gray-400">Good (60-79)</span></span>
                            <span class="flex items-center"><span class="w-3 h-3 rounded-full score-moderate mr-2"></span><span class="text-gray-400">Moderate (40-59)</span></span>
                            <span class="flex items-center"><span class="w-3 h-3 rounded-full score-difficult mr-2"></span><span class="text-gray-400">Difficult (&lt;40)</span></span>
                        </div>

                        <!-- Keywords Grid -->
                        <div id="keywordsGrid" class="grid gap-3 mb-6">
                            <!-- Populated by JS -->
                        </div>

                        <!-- Selection Summary -->
                        <div id="selectionSummary" class="hidden sticky bottom-0 glass-card rounded-xl p-4 mt-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-8">
                                    <div class="text-center">
                                        <span class="text-3xl font-bold text-purple-400" id="primaryCount">0</span>
                                        <span class="text-gray-400 text-sm ml-1">Primary</span>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-3xl font-bold text-green-400" id="secondaryCount">0</span>
                                        <span class="text-gray-400 text-sm ml-1">Secondary</span>
                                    </div>
                                    <div class="hidden sm:block border-l border-white/10 pl-8">
                                        <span class="text-2xl font-bold text-white" id="totalVolume">0</span>
                                        <span class="text-gray-400 text-sm ml-1">monthly searches</span>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="goToStep(1)" class="px-4 py-2 text-gray-400 hover:text-white transition">
                                        <i class="fas fa-arrow-left mr-2"></i>Back
                                    </button>
                                    <button onclick="goToStep(3)" id="btn-step-2-next" disabled class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                        Analyze Competitors
                                        <i class="fas fa-arrow-right ml-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== STEP 3: COMPETITOR ANALYSIS ==================== -->
                <div id="step-3" class="step-content hidden">
                    <div class="p-8 lg:p-12">
                        <!-- Header -->
                        <div class="text-center mb-10">
                            <span class="inline-block px-4 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm font-medium mb-4">
                                Step 3 of 5
                            </span>
                            <h2 class="text-3xl lg:text-4xl font-bold text-white mb-3">Know Your Competition</h2>
                            <p class="text-gray-400 max-w-xl mx-auto">We've identified competitors in <span id="geoLabel2" class="text-purple-400 font-medium">your market</span>. Add more or confirm to continue.</p>
                        </div>

                        <!-- Auto-discovered Competitors -->
                        <div class="glass-card rounded-2xl p-6 mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white font-semibold">
                                    <i class="fas fa-radar mr-2 text-purple-400"></i>Discovered Competitors
                                </h3>
                                <button onclick="discoverMoreCompetitors()" id="btnDiscoverMore" class="text-sm text-purple-400 hover:text-purple-300">
                                    <i class="fas fa-search mr-1"></i>Find More
                                </button>
                            </div>
                            <div id="competitorsList" class="space-y-3">
                                <!-- Populated by JS -->
                                <div class="text-center py-8 text-gray-500">
                                    <div class="spinner w-8 h-8 mx-auto mb-3"></div>
                                    <p>Discovering competitors...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Add Competitor Manually -->
                        <div class="glass-card rounded-2xl p-6 mb-8">
                            <h3 class="text-white font-semibold mb-4">
                                <i class="fas fa-plus-circle mr-2 text-green-400"></i>Add Competitor
                            </h3>
                            <div class="flex gap-3">
                                <input type="text" id="newCompetitorDomain" placeholder="competitor.com" 
                                    class="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                                    onkeypress="if(event.key==='Enter')addCompetitor()">
                                <button onclick="addCompetitor()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-xl transition-all">
                                    <i class="fas fa-plus mr-2"></i>Add
                                </button>
                            </div>
                        </div>

                        <!-- Competitive Insights Preview -->
                        <div id="competitiveInsights" class="hidden glass-card rounded-2xl p-6 mb-8">
                            <h3 class="text-white font-semibold mb-4">
                                <i class="fas fa-chart-bar mr-2 text-cyan-400"></i>Competitive Landscape
                            </h3>
                            <div class="grid sm:grid-cols-3 gap-4">
                                <div class="bg-white/5 rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-white" id="avgCompetitorPages">--</div>
                                    <div class="text-gray-400 text-sm">Avg Competitor Pages</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-white" id="avgCompetitorBlogs">--</div>
                                    <div class="text-gray-400 text-sm">Avg Blog Posts</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-green-400" id="contentGapsFound">--</div>
                                    <div class="text-gray-400 text-sm">Content Gaps Found</div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between">
                            <button onclick="goToStep(2)" class="px-6 py-3 text-gray-400 hover:text-white transition">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Keywords
                            </button>
                            <button onclick="goToStep(4)" id="btn-step-3-next" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl hover:opacity-90 transition-all flex items-center shadow-lg">
                                Review Strategy
                                <i class="fas fa-arrow-right ml-3"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ==================== STEP 4: REVIEW ==================== -->
                <div id="step-4" class="step-content hidden">
                    <div class="p-8 lg:p-12">
                        <!-- Header -->
                        <div class="text-center mb-10">
                            <span class="inline-block px-4 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm font-medium mb-4">
                                Step 4 of 5
                            </span>
                            <h2 class="text-3xl lg:text-4xl font-bold text-white mb-3">Review Your Strategy</h2>
                            <p class="text-gray-400 max-w-xl mx-auto">One last look before we generate your complete content package.</p>
                        </div>

                        <!-- Summary Cards -->
                        <div class="grid lg:grid-cols-2 gap-6 mb-8">
                            <!-- Business Summary -->
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="text-white font-semibold mb-4 flex items-center">
                                    <i class="fas fa-building mr-2 text-purple-400"></i>Business Profile
                                </h3>
                                <dl class="space-y-3">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">Business Name</dt>
                                        <dd class="text-white font-medium" id="reviewBusinessName">—</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">Industry</dt>
                                        <dd class="text-white font-medium" id="reviewIndustry">—</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">Location</dt>
                                        <dd class="text-white font-medium" id="reviewLocation">—</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">Service Areas</dt>
                                        <dd class="text-white font-medium" id="reviewServiceAreas">—</dd>
                                    </div>
                                </dl>
                            </div>

                            <!-- Strategy Summary -->
                            <div class="glass-card rounded-2xl p-6 bg-gradient-to-br from-purple-500/10 to-pink-500/10">
                                <h3 class="text-white font-semibold mb-4 flex items-center">
                                    <i class="fas fa-chart-line mr-2 text-green-400"></i>Content Strategy
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-white/5 rounded-xl p-4 text-center">
                                        <div class="text-3xl font-bold text-purple-400" id="reviewPrimaryCount">0</div>
                                        <div class="text-xs text-gray-400">Primary Keywords</div>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4 text-center">
                                        <div class="text-3xl font-bold text-green-400" id="reviewSecondaryCount">0</div>
                                        <div class="text-xs text-gray-400">Secondary Keywords</div>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4 text-center">
                                        <div class="text-3xl font-bold text-cyan-400" id="reviewCompetitors">0</div>
                                        <div class="text-xs text-gray-400">Competitors</div>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4 text-center">
                                        <div class="text-3xl font-bold text-white" id="reviewVolume">0</div>
                                        <div class="text-xs text-gray-400">Monthly Searches</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Keywords Preview -->
                        <div class="grid lg:grid-cols-2 gap-6 mb-8">
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-purple-400 font-medium mb-3 flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-purple-500 mr-2"></span>
                                    Primary Keywords (Service Pages)
                                </h4>
                                <div id="reviewPrimaryList" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-green-400 font-medium mb-3 flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                    Secondary Keywords (Blog Posts)
                                </h4>
                                <div id="reviewSecondaryList" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- What Gets Generated -->
                        <div class="glass-card rounded-2xl p-6 mb-8 bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/20">
                            <h3 class="text-white font-semibold mb-4 flex items-center">
                                <i class="fas fa-magic mr-2 text-green-400"></i>What We'll Generate
                            </h3>
                            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <label class="flex items-center p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="optBlogs" checked class="w-5 h-5 rounded text-green-500 mr-3">
                                    <div>
                                        <span class="text-white font-medium block">Blog Posts</span>
                                        <span class="text-gray-400 text-xs">1,500+ words with FAQs</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="optSocial" checked class="w-5 h-5 rounded text-green-500 mr-3">
                                    <div>
                                        <span class="text-white font-medium block">Social Posts</span>
                                        <span class="text-gray-400 text-xs">FB, IG, LinkedIn</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="optServicePages" checked class="w-5 h-5 rounded text-green-500 mr-3">
                                    <div>
                                        <span class="text-white font-medium block">Service Pages</span>
                                        <span class="text-gray-400 text-xs">Optimized landing pages</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="optMonitoring" checked class="w-5 h-5 rounded text-green-500 mr-3">
                                    <div>
                                        <span class="text-white font-medium block">Monitoring</span>
                                        <span class="text-gray-400 text-xs">Track rankings</span>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- Quick Setup Option -->
                            <div class="mt-4 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="optQuickSetup" checked class="w-5 h-5 rounded text-amber-500 mr-3">
                                    <div>
                                        <span class="text-amber-400 font-medium">Quick Setup Mode</span>
                                        <span class="text-gray-400 text-sm ml-2">Save client first, generate content from dashboard (recommended for cloud hosting)</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between">
                            <button onclick="goToStep(3)" class="px-6 py-3 text-gray-400 hover:text-white transition">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Competitors
                            </button>
                            <button onclick="launchClient()" id="btn-launch" class="px-10 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:opacity-90 transition-all flex items-center text-lg shadow-lg hover:shadow-green-500/30">
                                <i class="fas fa-rocket mr-3"></i>Launch Client
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ==================== STEP 5: SUCCESS ==================== -->
                <div id="step-5" class="step-content hidden">
                    <div class="p-8 lg:p-12">
                        <!-- Success Animation -->
                        <div class="text-center mb-10">
                            <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center shadow-lg bounce-in">
                                <svg class="w-12 h-12 text-white checkmark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <h2 class="text-4xl font-bold text-white mb-3">Client Launched! 🚀</h2>
                            <p class="text-gray-400" id="successMessage">Your client has been set up successfully.</p>
                        </div>

                        <!-- Delivery Summary -->
                        <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white font-bold text-lg">What Was Delivered</h3>
                                <span class="px-3 py-1 bg-white/20 text-white text-xs font-bold rounded-full">COMPLETE</span>
                            </div>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-white/10 rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-white" id="deliveredBlogs">0</div>
                                    <div class="text-purple-200 text-sm">Blog Posts</div>
                                </div>
                                <div class="bg-white/10 rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-white" id="deliveredSocial">0</div>
                                    <div class="text-purple-200 text-sm">Social Posts</div>
                                </div>
                                <div class="bg-white/10 rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-white" id="deliveredKeywords">0</div>
                                    <div class="text-purple-200 text-sm">Keywords</div>
                                </div>
                                <div class="bg-white/10 rounded-xl p-4 text-center">
                                    <div class="text-3xl font-bold text-white" id="deliveredVolume">0</div>
                                    <div class="text-purple-200 text-sm">Monthly Searches</div>
                                </div>
                            </div>
                        </div>

                        <!-- Generation Progress -->
                        <div id="generationProgress" class="hidden glass-card rounded-2xl p-6 mb-8">
                            <h3 class="text-white font-semibold mb-4 flex items-center">
                                <div class="spinner w-5 h-5 mr-3"></div>
                                Generating Content...
                            </h3>
                            <div id="progressItems" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Next Steps -->
                        <div class="mb-8">
                            <h3 class="text-white font-semibold mb-4">
                                <i class="fas fa-tasks mr-2 text-purple-400"></i>Next Steps
                            </h3>
                            <div class="grid sm:grid-cols-2 gap-4">
                                <a href="/client" id="linkViewContent" class="flex items-center p-5 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl hover:opacity-90 transition group">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-eye text-white text-xl"></i>
                                    </div>
                                    <div class="text-white">
                                        <span class="font-bold block">Review Content</span>
                                        <span class="text-purple-200 text-sm">View and edit generated content</span>
                                    </div>
                                    <i class="fas fa-arrow-right text-white ml-auto opacity-0 group-hover:opacity-100 transition"></i>
                                </a>
                                <button onclick="showWordPressSetup()" class="flex items-center p-5 glass-card rounded-xl hover:bg-white/10 transition group text-left">
                                    <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fab fa-wordpress text-blue-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <span class="font-bold text-white block">Connect WordPress</span>
                                        <span class="text-gray-400 text-sm">Auto-publish to their site</span>
                                    </div>
                                </button>
                                <button onclick="startFresh()" class="flex items-center p-5 glass-card rounded-xl hover:bg-white/10 transition group text-left">
                                    <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-plus text-green-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <span class="font-bold text-white block">Add Another Client</span>
                                        <span class="text-gray-400 text-sm">Start a new onboarding</span>
                                    </div>
                                </button>
                                <a href="/agency" class="flex items-center p-5 glass-card rounded-xl hover:bg-white/10 transition group">
                                    <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-building text-amber-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <span class="font-bold text-white block">Agency Dashboard</span>
                                        <span class="text-gray-400 text-sm">Manage all clients</span>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- WordPress Setup Modal -->
    <div id="wordpressModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center" onclick="if(event.target===this)closeWordPressModal()">
        <div class="glass-light rounded-2xl p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">
                <i class="fab fa-wordpress text-blue-600 mr-2"></i>Connect WordPress
            </h3>
            <p class="text-gray-500 mb-6">Enter the WordPress site details to enable auto-publishing.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">WordPress URL</label>
                    <input type="text" id="wpUrl" placeholder="https://example.com" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Application Password</label>
                    <input type="password" id="wpPassword" placeholder="xxxx xxxx xxxx xxxx" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Users → Your Profile → Application Passwords</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeWordPressModal()" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl font-medium hover:bg-gray-50 transition">Cancel</button>
                <button onclick="saveWordPressConfig()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition">Connect</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const API_URL = window.location.origin;
        let AUTH_TOKEN = localStorage.getItem('auth_token');
        let currentStep = 1;
        let clientData = {
            business_name: '',
            industry: '',
            geo: '',
            website: '',
            phone: '',
            email: '',
            address: '',
            service_areas: [],
            usps: '',
            brand_colors: ['#8b5cf6', '#ec4899'],
            logo_url: ''
        };
        let keywordsData = [];
        let selectedKeywords = { primary: [], secondary: [] };
        let competitorsData = [];
        let createdClientId = null;

        // Industry data with icons
        const industries = [
            { value: 'hvac', label: 'HVAC', icon: 'snowflake', color: 'blue' },
            { value: 'plumbing', label: 'Plumbing', icon: 'wrench', color: 'cyan' },
            { value: 'roofing', label: 'Roofing', icon: 'home', color: 'amber' },
            { value: 'electrical', label: 'Electrical', icon: 'bolt', color: 'yellow' },
            { value: 'landscaping', label: 'Landscaping', icon: 'tree', color: 'green' },
            { value: 'cleaning', label: 'Cleaning', icon: 'broom', color: 'purple' },
            { value: 'pest_control', label: 'Pest Control', icon: 'bug', color: 'red' },
            { value: 'painting', label: 'Painting', icon: 'paint-brush', color: 'pink' },
            { value: 'flooring', label: 'Flooring', icon: 'square', color: 'orange' },
            { value: 'windows', label: 'Windows', icon: 'window-maximize', color: 'teal' },
            { value: 'real_estate', label: 'Real Estate', icon: 'building', color: 'indigo' },
            { value: 'dentist', label: 'Dentist', icon: 'tooth', color: 'sky' },
            { value: 'lawyer', label: 'Attorney', icon: 'gavel', color: 'slate' },
            { value: 'auto_repair', label: 'Auto Repair', icon: 'car', color: 'zinc' },
            { value: 'other', label: 'Other', icon: 'ellipsis-h', color: 'gray' }
        ];

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initIndustryGrid();
            initColorPickers();
            initServiceAreaTags();
            
            if (AUTH_TOKEN) {
                checkExistingToken();
            }
        });

        function initIndustryGrid() {
            const grid = document.getElementById('industryGrid');
            grid.innerHTML = industries.map(ind => `
                <div class="industry-card glass-card rounded-xl p-4 cursor-pointer transition" 
                     data-value="${ind.value}"
                     onclick="selectIndustry('${ind.value}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-${ind.color}-500/20 flex items-center justify-center">
                            <i class="fas fa-${ind.icon} text-${ind.color}-400"></i>
                        </div>
                        <span class="text-white font-medium text-sm">${ind.label}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectIndustry(value) {
            document.querySelectorAll('.industry-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.value === value);
            });
            clientData.industry = value;
            document.getElementById('industry').value = value;
        }

        function initColorPickers() {
            const color1 = document.getElementById('brandColor1');
            const color1Text = document.getElementById('brandColor1Text');
            const color2 = document.getElementById('brandColor2');
            const color2Text = document.getElementById('brandColor2Text');

            color1.addEventListener('change', () => {
                color1Text.value = color1.value;
                clientData.brand_colors[0] = color1.value;
            });
            color1Text.addEventListener('change', () => {
                color1.value = color1Text.value;
                clientData.brand_colors[0] = color1Text.value;
            });
            color2.addEventListener('change', () => {
                color2Text.value = color2.value;
                clientData.brand_colors[1] = color2.value;
            });
            color2Text.addEventListener('change', () => {
                color2.value = color2Text.value;
                clientData.brand_colors[1] = color2Text.value;
            });
        }

        function initServiceAreaTags() {
            const input = document.getElementById('service_areas');
            const tagsContainer = document.getElementById('serviceAreaTags');
            
            input.addEventListener('blur', () => {
                const areas = input.value.split(',').map(a => a.trim()).filter(a => a);
                clientData.service_areas = areas;
                renderServiceAreaTags();
            });
        }

        function renderServiceAreaTags() {
            const container = document.getElementById('serviceAreaTags');
            container.innerHTML = clientData.service_areas.map((area, i) => `
                <span class="service-tag inline-flex items-center px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm">
                    ${area}
                    <button onclick="removeServiceArea(${i})" class="ml-2 hover:text-purple-300">&times;</button>
                </span>
            `).join('');
        }

        function removeServiceArea(index) {
            clientData.service_areas.splice(index, 1);
            document.getElementById('service_areas').value = clientData.service_areas.join(', ');
            renderServiceAreaTags();
        }

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const error = document.getElementById('authError');

            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mx-auto"></div>';
            error.classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    AUTH_TOKEN = data.token;
                    localStorage.setItem('auth_token', AUTH_TOKEN);
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('mainDashboard').classList.remove('hidden');
                    loadSavedState();
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            } catch (err) {
                error.textContent = err.message;
                error.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Sign In';
            }
        }

        async function checkExistingToken() {
            try {
                const response = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (response.ok) {
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('mainDashboard').classList.remove('hidden');
                    loadSavedState();
                } else {
                    localStorage.removeItem('auth_token');
                    AUTH_TOKEN = null;
                }
            } catch (e) {
                console.error('Token check failed:', e);
            }
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        function goToStep(step) {
            // Validate before proceeding
            if (step > currentStep) {
                if (currentStep === 1 && !validateStep1()) return;
                if (currentStep === 2 && !validateStep2()) return;
            }

            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show target step
            const targetStep = document.getElementById(`step-${step}`);
            targetStep.classList.remove('hidden');
            targetStep.classList.add('fade-up');

            // Update progress indicators
            for (let i = 1; i <= 5; i++) {
                const dot = document.getElementById(`step-dot-${i}`);
                const line = document.getElementById(`step-line-${i}`);
                
                if (i < step) {
                    dot.classList.remove('active');
                    dot.classList.add('completed');
                    dot.innerHTML = '<i class="fas fa-check text-white"></i>';
                    if (line) line.classList.add('completed');
                } else if (i === step) {
                    dot.classList.add('active');
                    dot.classList.remove('completed');
                    dot.innerHTML = getStepIcon(i);
                    dot.querySelector('i')?.classList.add('text-white');
                } else {
                    dot.classList.remove('active', 'completed');
                    dot.innerHTML = getStepIcon(i);
                    dot.querySelector('i')?.classList.remove('text-white');
                    dot.querySelector('i')?.classList.add('text-gray-500');
                    if (line) line.classList.remove('completed');
                }
            }

            // Step-specific actions
            if (step === 2 && currentStep === 1) {
                loadKeywords();
            } else if (step === 3 && currentStep === 2) {
                discoverCompetitors();
            } else if (step === 4) {
                populateReview();
            }

            currentStep = step;
            saveState();
        }

        function getStepIcon(step) {
            const icons = ['', 'building', 'key', 'users', 'clipboard-check', 'rocket'];
            return `<i class="fas fa-${icons[step]} text-lg"></i>`;
        }

        function validateStep1() {
            const name = document.getElementById('business_name').value.trim();
            const industry = clientData.industry;
            const geo = document.getElementById('geo').value.trim();

            if (!name) {
                showToast('Please enter a business name', 'error');
                document.getElementById('business_name').focus();
                return false;
            }
            if (!industry) {
                showToast('Please select an industry', 'error');
                return false;
            }
            if (!geo) {
                showToast('Please enter a location', 'error');
                document.getElementById('geo').focus();
                return false;
            }

            // Save data
            clientData.business_name = name;
            clientData.geo = geo;
            clientData.website = document.getElementById('website').value.trim();
            clientData.phone = document.getElementById('phone').value.trim();
            clientData.email = document.getElementById('email').value.trim();
            clientData.address = document.getElementById('address').value.trim();
            clientData.usps = document.getElementById('usps').value.trim();

            return true;
        }

        function validateStep2() {
            if (selectedKeywords.primary.length === 0) {
                showToast('Please select at least one primary keyword', 'error');
                return false;
            }
            return true;
        }

        // ==========================================
        // KEYWORD RESEARCH
        // ==========================================
        async function loadKeywords() {
            const industryLabel = industries.find(i => i.value === clientData.industry)?.label || clientData.industry;
            document.getElementById('industryLabel').textContent = industryLabel;
            document.getElementById('geoLabel').textContent = clientData.geo;

            // Show loading
            document.getElementById('researchStatus').classList.remove('hidden');
            document.getElementById('keywordInput').classList.add('hidden');
            document.getElementById('keywordActions').classList.add('hidden');
            document.getElementById('keywordLegend').classList.add('hidden');
            document.getElementById('selectionSummary').classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/api/intake/research`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        industry: clientData.industry,
                        geo: clientData.geo,
                        business_name: clientData.business_name
                    })
                });

                const data = await response.json();

                if (data.keywords && data.keywords.length > 0) {
                    keywordsData = data.keywords.map((kw, i) => ({
                        id: i,
                        keyword: kw.keyword || kw,
                        volume: kw.volume || kw.search_volume || Math.floor(Math.random() * 5000),
                        difficulty: kw.difficulty || kw.keyword_difficulty || Math.floor(Math.random() * 100),
                        opportunity: kw.opportunity_score || calculateOpportunity(kw),
                        intent: kw.intent || 'commercial',
                        type: null
                    }));
                    
                    renderKeywords();
                    showResearchSuccess();
                } else {
                    showResearchError('No keywords found. Try adding custom keywords.');
                }
            } catch (error) {
                console.error('Keyword research error:', error);
                showResearchError('Research failed. You can add keywords manually.');
            }
        }

        function calculateOpportunity(kw) {
            const volume = kw.volume || kw.search_volume || 100;
            const difficulty = kw.difficulty || kw.keyword_difficulty || 50;
            return Math.round(Math.min(100, (volume / 100) * (100 - difficulty) / 50));
        }

        function showResearchSuccess() {
            document.getElementById('researchStatus').innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                        <i class="fas fa-check text-green-400 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-white font-medium">Found ${keywordsData.length} keyword opportunities!</p>
                        <p class="text-gray-400 text-sm">Click keywords to select them as primary or secondary</p>
                    </div>
                </div>
            `;
            document.getElementById('keywordInput').classList.remove('hidden');
            document.getElementById('keywordActions').classList.remove('hidden');
            document.getElementById('keywordLegend').classList.remove('hidden');
            document.getElementById('selectionSummary').classList.remove('hidden');
        }

        function showResearchError(message) {
            document.getElementById('researchStatus').innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-amber-400 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-white font-medium">${message}</p>
                        <p class="text-gray-400 text-sm">Enter keywords below to research them</p>
                    </div>
                </div>
            `;
            document.getElementById('keywordInput').classList.remove('hidden');
            document.getElementById('selectionSummary').classList.remove('hidden');
        }

        function renderKeywords() {
            const grid = document.getElementById('keywordsGrid');
            
            grid.innerHTML = keywordsData.map(kw => {
                const scoreClass = kw.opportunity >= 80 ? 'score-excellent' : 
                                   kw.opportunity >= 60 ? 'score-good' : 
                                   kw.opportunity >= 40 ? 'score-moderate' : 'score-difficult';
                const selectedClass = kw.type === 'primary' ? 'selected-primary' : 
                                      kw.type === 'secondary' ? 'selected-secondary' : '';
                
                return `
                    <div class="keyword-card glass-card rounded-xl p-4 ${selectedClass}" data-id="${kw.id}" onclick="cycleKeywordType(${kw.id})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg ${scoreClass} flex items-center justify-center text-white font-bold text-sm">
                                    ${kw.opportunity}
                                </div>
                                <div>
                                    <div class="text-white font-medium">${kw.keyword}</div>
                                    <div class="flex items-center gap-3 text-xs text-gray-400">
                                        <span><i class="fas fa-search mr-1"></i>${kw.volume.toLocaleString()}/mo</span>
                                        <span><i class="fas fa-signal mr-1"></i>KD: ${kw.difficulty}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${kw.type === 'primary' ? '<span class="px-2 py-1 bg-purple-500 text-white text-xs rounded-full">Primary</span>' : ''}
                                ${kw.type === 'secondary' ? '<span class="px-2 py-1 bg-green-500 text-white text-xs rounded-full">Secondary</span>' : ''}
                                ${!kw.type ? '<span class="text-gray-500 text-xs">Click to select</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function cycleKeywordType(id) {
            const kw = keywordsData.find(k => k.id === id);
            if (!kw) return;

            // Cycle: null -> primary -> secondary -> null
            if (!kw.type) {
                kw.type = 'primary';
            } else if (kw.type === 'primary') {
                kw.type = 'secondary';
            } else {
                kw.type = null;
            }

            updateSelections();
            renderKeywords();
        }

        function updateSelections() {
            selectedKeywords.primary = keywordsData.filter(k => k.type === 'primary');
            selectedKeywords.secondary = keywordsData.filter(k => k.type === 'secondary');

            document.getElementById('primaryCount').textContent = selectedKeywords.primary.length;
            document.getElementById('secondaryCount').textContent = selectedKeywords.secondary.length;
            
            const totalVolume = [...selectedKeywords.primary, ...selectedKeywords.secondary]
                .reduce((sum, k) => sum + k.volume, 0);
            document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();

            // Enable/disable next button
            document.getElementById('btn-step-2-next').disabled = selectedKeywords.primary.length === 0;
        }

        function autoSelectBest() {
            // Sort by opportunity score
            const sorted = [...keywordsData].sort((a, b) => b.opportunity - a.opportunity);
            
            // Select top 5 as primary, next 10 as secondary
            sorted.forEach((kw, i) => {
                if (i < 5) kw.type = 'primary';
                else if (i < 15) kw.type = 'secondary';
                else kw.type = null;
            });

            updateSelections();
            renderKeywords();
            showToast('Auto-selected best keywords!', 'success');
        }

        function clearSelections() {
            keywordsData.forEach(kw => kw.type = null);
            updateSelections();
            renderKeywords();
        }

        async function addCustomKeyword() {
            const input = document.getElementById('customKeyword');
            const keyword = input.value.trim();
            if (!keyword) return;

            // Add to list
            const newKw = {
                id: keywordsData.length,
                keyword: keyword,
                volume: 0,
                difficulty: 50,
                opportunity: 50,
                intent: 'commercial',
                type: 'primary'
            };

            keywordsData.push(newKw);
            updateSelections();
            renderKeywords();
            input.value = '';

            // Research the keyword
            try {
                const response = await fetch(`${API_URL}/api/intake/research`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        keywords: [keyword],
                        geo: clientData.geo
                    })
                });

                const data = await response.json();
                if (data.keywords && data.keywords[0]) {
                    const researched = data.keywords[0];
                    newKw.volume = researched.volume || researched.search_volume || 100;
                    newKw.difficulty = researched.difficulty || researched.keyword_difficulty || 50;
                    newKw.opportunity = calculateOpportunity(researched);
                    renderKeywords();
                }
            } catch (e) {
                console.log('Could not research keyword:', e);
            }
        }

        function filterKeywords(filter) {
            document.querySelectorAll('.keyword-filter').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(filter) || filter === 'all');
                btn.classList.toggle('bg-white/10', btn.textContent.toLowerCase().includes(filter) || filter === 'all');
                btn.classList.toggle('text-white', btn.textContent.toLowerCase().includes(filter) || filter === 'all');
            });
            // TODO: Implement actual filtering
        }

        // ==========================================
        // COMPETITOR DISCOVERY
        // ==========================================
        async function discoverCompetitors() {
            document.getElementById('geoLabel2').textContent = clientData.geo;
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitors/discover`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        industry: clientData.industry,
                        geo: clientData.geo,
                        keywords: selectedKeywords.primary.map(k => k.keyword)
                    })
                });

                const data = await response.json();
                
                if (data.competitors && data.competitors.length > 0) {
                    competitorsData = data.competitors;
                } else {
                    // Use demo competitors
                    competitorsData = [
                        { domain: 'competitor1.com', name: 'Local Competitor 1', pages: 45, blogs: 12 },
                        { domain: 'competitor2.com', name: 'Regional Competitor', pages: 78, blogs: 24 },
                        { domain: 'competitor3.com', name: 'National Brand Local', pages: 120, blogs: 56 }
                    ];
                }
                
                renderCompetitors();
            } catch (error) {
                console.error('Competitor discovery error:', error);
                // Show demo data
                competitorsData = [
                    { domain: 'competitor1.com', name: 'Sample Competitor 1', pages: 30, blogs: 8 },
                    { domain: 'competitor2.com', name: 'Sample Competitor 2', pages: 55, blogs: 15 }
                ];
                renderCompetitors();
            }
        }

        function renderCompetitors() {
            const list = document.getElementById('competitorsList');
            
            if (competitorsData.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-3xl mb-3 opacity-50"></i>
                        <p>No competitors found. Add them manually below.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = competitorsData.map((comp, i) => `
                <div class="competitor-card flex items-center justify-between p-4 bg-white/5 rounded-xl border-l-4 border-purple-500/50">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                            <i class="fas fa-building text-purple-400"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium">${comp.name || comp.domain}</div>
                            <div class="text-gray-400 text-sm">${comp.domain}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="text-white font-medium">${comp.pages || '--'}</div>
                            <div class="text-gray-500 text-xs">pages</div>
                        </div>
                        <div class="text-right">
                            <div class="text-white font-medium">${comp.blogs || '--'}</div>
                            <div class="text-gray-500 text-xs">blogs</div>
                        </div>
                        <button onclick="removeCompetitor(${i})" class="p-2 text-gray-500 hover:text-red-400 transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Show insights
            document.getElementById('competitiveInsights').classList.remove('hidden');
            const avgPages = Math.round(competitorsData.reduce((s, c) => s + (c.pages || 0), 0) / competitorsData.length);
            const avgBlogs = Math.round(competitorsData.reduce((s, c) => s + (c.blogs || 0), 0) / competitorsData.length);
            document.getElementById('avgCompetitorPages').textContent = avgPages || '--';
            document.getElementById('avgCompetitorBlogs').textContent = avgBlogs || '--';
            document.getElementById('contentGapsFound').textContent = Math.round(avgBlogs * 0.7);
        }

        function addCompetitor() {
            const input = document.getElementById('newCompetitorDomain');
            const domain = input.value.trim().replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
            
            if (!domain) return;

            competitorsData.push({
                domain: domain,
                name: domain,
                pages: '--',
                blogs: '--'
            });

            renderCompetitors();
            input.value = '';
            showToast('Competitor added!', 'success');
        }

        function removeCompetitor(index) {
            competitorsData.splice(index, 1);
            renderCompetitors();
        }

        // ==========================================
        // REVIEW & LAUNCH
        // ==========================================
        function populateReview() {
            document.getElementById('reviewBusinessName').textContent = clientData.business_name;
            document.getElementById('reviewIndustry').textContent = industries.find(i => i.value === clientData.industry)?.label || clientData.industry;
            document.getElementById('reviewLocation').textContent = clientData.geo;
            document.getElementById('reviewServiceAreas').textContent = clientData.service_areas.join(', ') || clientData.geo;
            
            document.getElementById('reviewPrimaryCount').textContent = selectedKeywords.primary.length;
            document.getElementById('reviewSecondaryCount').textContent = selectedKeywords.secondary.length;
            document.getElementById('reviewCompetitors').textContent = competitorsData.length;
            
            const totalVolume = [...selectedKeywords.primary, ...selectedKeywords.secondary]
                .reduce((sum, k) => sum + k.volume, 0);
            document.getElementById('reviewVolume').textContent = totalVolume.toLocaleString();

            // Primary keywords list
            document.getElementById('reviewPrimaryList').innerHTML = selectedKeywords.primary.map(kw => `
                <div class="flex justify-between items-center py-2 px-3 bg-white/5 rounded-lg">
                    <span class="text-white">${kw.keyword}</span>
                    <span class="text-gray-400 text-sm">${kw.volume.toLocaleString()}/mo</span>
                </div>
            `).join('') || '<p class="text-gray-500 text-sm">No primary keywords selected</p>';

            // Secondary keywords list
            document.getElementById('reviewSecondaryList').innerHTML = selectedKeywords.secondary.map(kw => `
                <div class="flex justify-between items-center py-2 px-3 bg-white/5 rounded-lg">
                    <span class="text-white">${kw.keyword}</span>
                    <span class="text-gray-400 text-sm">${kw.volume.toLocaleString()}/mo</span>
                </div>
            `).join('') || '<p class="text-gray-500 text-sm">No secondary keywords selected</p>';
        }

        async function launchClient() {
            const btn = document.getElementById('btn-launch');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-3"></div>Launching...';

            try {
                const quickSetup = document.getElementById('optQuickSetup').checked;
                
                // Prepare client data
                const payload = {
                    business_name: clientData.business_name,
                    industry: clientData.industry,
                    geo: clientData.geo,
                    website_url: clientData.website,
                    phone: clientData.phone,
                    email: clientData.email,
                    address: clientData.address,
                    service_areas: clientData.service_areas,
                    usps: clientData.usps,
                    primary_keywords: selectedKeywords.primary.map(k => k.keyword),
                    secondary_keywords: selectedKeywords.secondary.map(k => k.keyword),
                    competitors: competitorsData.map(c => c.domain),
                    options: {
                        generate_blogs: !quickSetup && document.getElementById('optBlogs').checked,
                        generate_social: !quickSetup && document.getElementById('optSocial').checked,
                        generate_service_pages: !quickSetup && document.getElementById('optServicePages').checked,
                        setup_monitoring: document.getElementById('optMonitoring').checked,
                        quick_setup: quickSetup
                    }
                };

                const endpoint = quickSetup ? '/api/intake/quick' : '/api/intake/pipeline';
                
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.client_id) {
                    createdClientId = data.client_id;
                    
                    // Update success page
                    document.getElementById('deliveredKeywords').textContent = 
                        selectedKeywords.primary.length + selectedKeywords.secondary.length;
                    document.getElementById('deliveredVolume').textContent = 
                        [...selectedKeywords.primary, ...selectedKeywords.secondary]
                            .reduce((s, k) => s + k.volume, 0).toLocaleString();
                    document.getElementById('deliveredBlogs').textContent = data.blogs_created || 0;
                    document.getElementById('deliveredSocial').textContent = data.social_created || 0;
                    
                    document.getElementById('linkViewContent').href = `/client?id=${createdClientId}`;
                    
                    if (quickSetup) {
                        document.getElementById('successMessage').textContent = 
                            'Client saved! Generate content from the dashboard.';
                    } else {
                        document.getElementById('successMessage').textContent = 
                            'Content generation complete!';
                    }

                    goToStep(5);
                    clearSavedState();
                    
                    // Confetti!
                    launchConfetti();
                } else {
                    throw new Error(data.error || 'Failed to create client');
                }
            } catch (error) {
                console.error('Launch error:', error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket mr-3"></i>Launch Client';
            }
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'from-green-500 to-emerald-600',
                error: 'from-red-500 to-pink-600',
                info: 'from-blue-500 to-cyan-600',
                warning: 'from-amber-500 to-orange-600'
            };
            toast.className = `fixed bottom-4 right-4 bg-gradient-to-r ${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg z-50 fade-up`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function launchConfetti() {
            // Simple confetti effect
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.background = ['#8b5cf6', '#ec4899', '#10b981', '#f59e0b'][Math.floor(Math.random() * 4)];
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animation = `fall ${2 + Math.random() * 2}s linear forwards`;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        // Add confetti animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(720deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // ==========================================
        // LOGO HANDLING
        // ==========================================
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) processLogo(file);
        }

        function handleLogoDrop(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processLogo(file);
            }
        }

        function processLogo(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('logoImage').src = e.target.result;
                document.getElementById('logoPreview').classList.remove('hidden');
                document.getElementById('logoPlaceholder').classList.add('hidden');
                clientData.logo_url = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            document.getElementById('logoPreview').classList.add('hidden');
            document.getElementById('logoPlaceholder').classList.remove('hidden');
            document.getElementById('logoInput').value = '';
            clientData.logo_url = '';
        }

        // ==========================================
        // AI SUGGESTIONS
        // ==========================================
        async function generateUSPSuggestions() {
            if (!clientData.industry || !clientData.geo) {
                showToast('Please fill in industry and location first', 'warning');
                return;
            }

            const container = document.getElementById('uspSuggestions');
            container.innerHTML = '<div class="spinner w-5 h-5"></div>';
            container.classList.remove('hidden');

            const industryLabel = industries.find(i => i.value === clientData.industry)?.label || clientData.industry;
            
            // Common USPs by industry
            const uspsByIndustry = {
                hvac: ['24/7 Emergency Service', 'Licensed & Insured', 'Free Estimates', 'Same-Day Service', 'Financing Available', 'Senior Discounts'],
                plumbing: ['No Overtime Charges', '24/7 Emergency', 'Licensed Master Plumber', 'Upfront Pricing', 'Satisfaction Guaranteed'],
                roofing: ['Free Roof Inspections', 'Lifetime Warranty', 'Insurance Claims Assistance', 'Local Family Owned', 'GAF Certified'],
                electrical: ['Licensed Electricians', 'Safety First', 'Code Compliant Work', 'Free Safety Inspections', 'Commercial & Residential'],
                default: ['Family Owned', 'Licensed & Insured', 'Free Estimates', 'Satisfaction Guaranteed', 'Fast Response Time', 'Competitive Pricing']
            };

            const usps = uspsByIndustry[clientData.industry] || uspsByIndustry.default;
            
            setTimeout(() => {
                container.innerHTML = usps.map(usp => `
                    <button onclick="addUSP('${usp}')" class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm hover:bg-purple-500/30 transition">
                        + ${usp}
                    </button>
                `).join('');
            }, 500);
        }

        function addUSP(usp) {
            const textarea = document.getElementById('usps');
            if (textarea.value) {
                textarea.value += ', ' + usp;
            } else {
                textarea.value = usp;
            }
        }

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        function saveState() {
            const state = {
                currentStep,
                clientData,
                keywordsData,
                selectedKeywords,
                competitorsData
            };
            localStorage.setItem('intake_state', JSON.stringify(state));
        }

        function loadSavedState() {
            const saved = localStorage.getItem('intake_state');
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    // Restore state
                    if (state.clientData) {
                        clientData = state.clientData;
                        document.getElementById('business_name').value = clientData.business_name || '';
                        if (clientData.industry) selectIndustry(clientData.industry);
                        document.getElementById('geo').value = clientData.geo || '';
                        document.getElementById('website').value = clientData.website || '';
                        document.getElementById('phone').value = clientData.phone || '';
                        document.getElementById('email').value = clientData.email || '';
                        document.getElementById('usps').value = clientData.usps || '';
                    }
                    if (state.keywordsData) keywordsData = state.keywordsData;
                    if (state.selectedKeywords) selectedKeywords = state.selectedKeywords;
                    if (state.competitorsData) competitorsData = state.competitorsData;
                    
                    if (state.currentStep && state.currentStep > 1) {
                        showToast('Resuming saved session...', 'info');
                    }
                } catch (e) {
                    console.error('Failed to load state:', e);
                }
            }
        }

        function clearSavedState() {
            localStorage.removeItem('intake_state');
        }

        function startFresh() {
            if (confirm('Start a new client? This will clear any unsaved progress.')) {
                clearSavedState();
                location.reload();
            }
        }

        // ==========================================
        // WORDPRESS MODAL
        // ==========================================
        function showWordPressSetup() {
            document.getElementById('wordpressModal').classList.remove('hidden');
        }

        function closeWordPressModal() {
            document.getElementById('wordpressModal').classList.add('hidden');
        }

        async function saveWordPressConfig() {
            const url = document.getElementById('wpUrl').value.trim();
            const password = document.getElementById('wpPassword').value.trim();

            if (!url || !password) {
                showToast('Please fill in all fields', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/clients/${createdClientId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        wordpress_url: url,
                        wordpress_password: password
                    })
                });

                if (response.ok) {
                    showToast('WordPress connected!', 'success');
                    closeWordPressModal();
                } else {
                    throw new Error('Failed to save');
                }
            } catch (error) {
                showToast('Error saving WordPress config', 'error');
            }
        }
    </script>
</body>
</html>
